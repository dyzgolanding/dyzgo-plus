This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  (auth)/
    login/
      actions.ts
      page.tsx
    register/
      page.tsx
  (dashboard)/
    events/
      [id]/
        attendees/
          page.tsx
        rrpp/
          page.tsx
        settings/
          page.tsx
        staff/
          page.tsx
        layout.tsx
        page.tsx
      create/
        page.tsx
      page.tsx
    finance/
      page.tsx
    settings/
      page.tsx
    team/
      page.tsx
    layout.tsx
    page.tsx
  onboarding/
    page.tsx
  favicon.ico
  globals.css
  layout.tsx
  not-found.tsx
components/
  hud/
    DescriptionPanel.tsx
    DesignPanel.tsx
    ExperiencePanel.tsx
    GeneralPanel.tsx
    LivePreview.tsx
    SettingsPanel.tsx
    TicketPanel.tsx
  providers/
    org-provider.tsx
  ui/
    alert.tsx
    badge.tsx
    button.tsx
    card.tsx
    select.tsx
    separator.tsx
    table.tsx
    tabs.tsx
lib/
  supabase.ts
  utils.ts
public/
  file.svg
  globe.svg
  next.svg
  plantilla-clientes.xlsx
  vercel.svg
  window.svg
store/
  useEventStore.ts
.gitignore
components.json
eslint.config.mjs
middleware.ts
next.config.ts
package.json
postcss.config.mjs
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/(auth)/login/actions.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function login(formData: FormData) {
  const cookieStore = await cookies()

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Se ignoran errores en Server Components
          }
        },
      },
    }
  )

  const email = formData.get('email') as string
  const password = formData.get('password') as string

  // 1. Iniciar Sesión
  const { data: { user }, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  })

  if (error) {
    return redirect(`/login?error=${encodeURIComponent('Credenciales inválidas')}`)
  }

  if (user) {
    // 2. Verificar Rol (Tabla profiles)
    const { data: profile } = await supabase
        .from('profiles') 
        .select('role')
        .eq('id', user.id)
        .single()

    // Si no es admin, fuera.
    if (!profile || profile.role !== 'admin') {
        await supabase.auth.signOut()
        return redirect(`/login?error=${encodeURIComponent('Acceso denegado. No eres administrador.')}`)
    }

    // 3. NUEVO: Verificar si tiene Productora (Tabla experiences)
    const { data: experience } = await supabase
        .from('experiences')
        .select('id')
        .eq('producer_id', user.id)
        .maybeSingle() // Usamos maybeSingle para que no lance error si no encuentra nada

    // LÓGICA DE REDIRECCIÓN INTELIGENTE
    if (!experience) {
        // Si no tiene productora -> Al Onboarding
        revalidatePath('/onboarding', 'layout')
        return redirect('/onboarding')
    }
  }

  // 4. Si tiene productora -> Al Dashboard (Login normal)
  revalidatePath('/', 'layout')
  redirect('/')
}
</file>

<file path="app/(auth)/login/page.tsx">
'use client'

import { useState } from 'react'
import Link from 'next/link'
import { useSearchParams } from 'next/navigation'
import { ArrowRight, Lock, Mail, Sparkles, Loader2, Eye, EyeOff, AlertCircle } from 'lucide-react'
import { login } from './actions' // <--- Importamos la Server Action

export default function LoginPage() {
  // Mantenemos estados visuales, pero ya no controlamos la data del form con state para el envío
  const [showPassword, setShowPassword] = useState(false)
  const [loading, setLoading] = useState(false) 
  
  // Para mostrar errores que vienen del servidor
  const searchParams = useSearchParams()
  const errorMsg = searchParams.get('error')

  // Wrapper para manejar el estado de carga visual
  const handleSubmit = async (formData: FormData) => {
    setLoading(true)
    await login(formData) // Llamamos al Server Action
    setLoading(false)
  }

  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-[#030005] font-sans text-white relative overflow-hidden selection:bg-[#FF007F]/30">
      
      {/* ==================================================================
          FONDO UNIFICADO
      ================================================================== */}
      <div className="fixed inset-0 z-0">
          <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1514525253440-b393452e3383?q=80&w=2500&auto=format&fit=crop')] bg-cover bg-center opacity-40 mix-blend-color-dodge grayscale" />
          <div className="absolute inset-0 bg-[#050208]/80 backdrop-blur-sm" />
          <div className="absolute top-[-10%] left-[-10%] w-[60vw] h-[60vw] bg-[#8A2BE2]/20 rounded-full blur-[120px] animate-pulse" />
          <div className="absolute bottom-[-10%] right-[-10%] w-[60vw] h-[60vw] bg-[#FF007F]/10 rounded-full blur-[120px]" />
      </div>

      {/* ==================================================================
          CONTENIDO FLOTANTE
      ================================================================== */}
      <div className="relative z-10 w-full max-w-5xl p-4 md:p-6">
        
        <div className="w-full grid lg:grid-cols-2 bg-white/5 backdrop-blur-3xl border border-white/10 rounded-[3rem] overflow-hidden shadow-2xl shadow-purple-900/30">
            
            {/* --- COLUMNA IZQUIERDA: FORMULARIO --- */}
            <div className="p-8 md:p-16 flex flex-col justify-center relative">
                
                <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent" />

                <div className="mb-10">
                    <div className="inline-flex h-12 w-12 bg-gradient-to-br from-[#8A2BE2] to-[#FF007F] rounded-2xl items-center justify-center shadow-[0_0_20px_rgba(138,43,226,0.3)] mb-6 border border-white/20">
                        <Sparkles size={22} className="text-white drop-shadow-md" />
                    </div>
                    <h1 className="text-3xl font-black tracking-tight text-white mb-2">DyzGO<span className="text-transparent bg-clip-text bg-gradient-to-r from-[#FF007F] to-[#8A2BE2]">+</span></h1>
                    <p className="text-white/40 text-sm font-medium">Panel de Control Administrativo</p>
                </div>

                {/* MENSAJE DE ERROR DEL SERVIDOR */}
                {errorMsg && (
                    <div className="mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl flex items-center gap-3 text-red-200 text-sm">
                        <AlertCircle size={18} className="text-red-500" />
                        {decodeURIComponent(errorMsg)}
                    </div>
                )}

                {/* IMPORTANTE: action={handleSubmit} conecta con el server action */}
                <form action={handleSubmit} className="space-y-5">
                    <div className="space-y-2">
                        <label className="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em] ml-1">Email</label>
                        <div className="relative group">
                            <div className="absolute inset-0 bg-gradient-to-r from-[#8A2BE2] to-[#FF007F] rounded-2xl opacity-0 group-focus-within:opacity-20 transition-opacity blur-md duration-500" />
                            <Mail size={18} className="absolute left-5 top-4 text-white/30 group-focus-within:text-[#FF007F] transition-colors z-10" />
                            <input 
                                name="email" // <--- IMPORTANTE
                                type="email" 
                                required
                                placeholder="admin@dyzgo.com"
                                className="relative w-full bg-black/40 backdrop-blur-md border border-white/10 rounded-2xl py-3.5 pl-14 pr-4 text-white placeholder:text-white/10 focus:outline-none focus:border-white/20 focus:bg-black/60 transition-all font-medium"
                            />
                        </div>
                    </div>

                    <div className="space-y-2">
                        <label className="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em] ml-1">Contraseña</label>
                        <div className="relative group">
                            <div className="absolute inset-0 bg-gradient-to-r from-[#8A2BE2] to-[#FF007F] rounded-2xl opacity-0 group-focus-within:opacity-20 transition-opacity blur-md duration-500" />
                            <Lock size={18} className="absolute left-5 top-4 text-white/30 group-focus-within:text-[#FF007F] transition-colors z-10" />
                            <input 
                                name="password" // <--- IMPORTANTE
                                type={showPassword ? "text" : "password"} 
                                required
                                placeholder="••••••••••••"
                                className="relative w-full bg-black/40 backdrop-blur-md border border-white/10 rounded-2xl py-3.5 pl-14 pr-12 text-white placeholder:text-white/10 focus:outline-none focus:border-white/20 focus:bg-black/60 transition-all font-medium"
                            />
                            <button 
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                className="absolute right-5 top-4 text-white/30 hover:text-white transition-colors focus:outline-none z-10"
                            >
                                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                            </button>
                        </div>
                    </div>

                    <button 
                        type="submit"
                        disabled={loading}
                        className="w-full py-4 rounded-2xl font-bold text-xs uppercase tracking-widest text-white relative group overflow-hidden transition-all hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50 mt-4 shadow-lg shadow-purple-900/20"
                    >
                        <div className="absolute inset-0 bg-gradient-to-r from-[#8A2BE2] to-[#FF007F] opacity-90 group-hover:opacity-100 transition-opacity" />
                        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 mix-blend-overlay" />
                        <div className="relative flex items-center justify-center gap-3">
                            {loading ? (
                                <Loader2 className="animate-spin" size={18} />
                            ) : (
                                <>Entrar al Sistema <ArrowRight size={16} /></>
                            )}
                        </div>
                    </button>
                </form>

                <div className="mt-8 text-center">
                    <p className="text-xs text-white/30 font-medium">
                        ¿No tienes acceso? 
                        <Link 
                            href="/register" 
                            className="ml-2 text-white hover:text-[#FF007F] transition-colors underline decoration-white/20 hover:decoration-[#FF007F] underline-offset-4"
                        >
                            Solicitar invitación
                        </Link>
                    </p>
                </div>
            </div>

            {/* --- COLUMNA DERECHA: VISUAL --- */}
            <div className="hidden lg:flex relative bg-black/20 items-center justify-center p-12 overflow-hidden">
                <div className="absolute left-0 top-10 bottom-10 w-px bg-gradient-to-b from-transparent via-white/10 to-transparent" />
                <div className="relative z-10 max-w-sm">
                    <div className="absolute top-[-50px] left-[-50px] w-32 h-32 bg-[#FF007F] rounded-full blur-[80px] opacity-20" />
                    <div className="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/5 backdrop-blur-md border border-white/10 text-[9px] font-bold tracking-[0.2em] uppercase mb-8 text-[#FF007F]">
                        <span className="relative flex h-1.5 w-1.5">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#FF007F] opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-1.5 w-1.5 bg-[#FF007F]"></span>
                        </span>
                        Sistema v2.0
                    </div>
                    <h2 className="text-4xl md:text-5xl font-black mb-6 leading-tight tracking-tight text-white">
                        Gestión <br/>
                        <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#8A2BE2] to-[#FF007F]">Inteligente</span> <br/>
                        de Eventos.
                    </h2>
                    <p className="text-sm text-white/40 leading-relaxed font-medium">
                        Control de acceso en tiempo real, métricas avanzadas y gestión de staff en una sola plataforma unificada.
                    </p>
                    <div className="flex items-center gap-4 mt-10">
                        <div className="flex -space-x-3">
                            {[1,2,3].map(i => (
                                <div key={i} className="w-8 h-8 rounded-full border border-black/50 bg-[#1a1a1a] flex items-center justify-center text-[8px] font-bold text-white/30">
                                    <div className="w-full h-full bg-gradient-to-br from-white/10 to-transparent rounded-full" />
                                </div>
                            ))}
                        </div>
                        <div className="text-xs font-bold text-white/30 uppercase tracking-widest">
                            Trusted by Pros
                        </div>
                    </div>
                </div>
            </div>

        </div>
      </div>
    </div>
  )
}
</file>

<file path="app/(auth)/register/page.tsx">
'use client'
import Link from 'next/link'
import { Sparkles, Mail, MessageCircle, ArrowLeft, ShieldCheck, Zap, Globe } from 'lucide-react'

export default function RegisterPage() {
  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-[#030005] font-sans text-white relative overflow-hidden selection:bg-[#FF007F]/30">
      
      {/* ==================================================================
          1. FONDO GLOBAL (IDÉNTICO AL LOGIN)
      ================================================================== */}
      <div className="fixed inset-0 z-0 pointer-events-none">
          {/* Imagen de fondo base */}
          <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1514525253440-b393452e3383?q=80&w=2500&auto=format&fit=crop')] bg-cover bg-center opacity-40 mix-blend-color-dodge grayscale" />
          
          {/* Capa oscura para legibilidad */}
          <div className="absolute inset-0 bg-[#050208]/80 backdrop-blur-sm" />

          {/* Manchas de luz "Liquid" animadas */}
          <div className="absolute top-[-10%] left-[-10%] w-[60vw] h-[60vw] bg-[#8A2BE2]/20 rounded-full blur-[120px] animate-pulse" />
          <div className="absolute bottom-[-10%] right-[-10%] w-[60vw] h-[60vw] bg-[#FF007F]/10 rounded-full blur-[120px]" />
      </div>

      {/* ==================================================================
          2. TARJETA UNIFICADA (DISTRIBUCIÓN FLUIDA)
      ================================================================== */}
      <div className="relative z-10 w-full max-w-5xl p-4 md:p-6">
        
        <div className="w-full grid lg:grid-cols-2 bg-white/5 backdrop-blur-3xl border border-white/10 rounded-[3rem] overflow-hidden shadow-2xl shadow-purple-900/30 min-h-[600px]">
            
            {/* --- COLUMNA IZQUIERDA: VISUAL & VALOR (Darker Glass) --- */}
            <div className="relative p-10 md:p-16 flex flex-col justify-center bg-black/20 overflow-hidden group">
                
                {/* Decoración de fondo interna */}
                <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-[#8A2BE2]/20 to-transparent rounded-full blur-[80px] group-hover:opacity-100 transition-opacity opacity-50" />
                
                <div className="relative z-10">
                    <div className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-[10px] font-bold tracking-[0.2em] uppercase mb-8 text-[#FF007F] w-fit shadow-lg shadow-purple-900/20">
                        <Sparkles size={12} className="text-[#FF007F]" />
                        Exclusive Access
                    </div>

                    <h1 className="text-5xl md:text-6xl font-black tracking-tighter leading-[0.95] mb-6 text-white">
                        Únete a la <br/>
                        <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#8A2BE2] via-[#FF007F] to-white animate-gradient-x">Élite.</span>
                    </h1>
                    
                    <p className="text-base text-white/50 font-medium max-w-sm leading-relaxed mb-10">
                        DyzGO+ es el sistema operativo privado para las productoras que definen la escena. Seguridad militar, analítica real y control total.
                    </p>

                    {/* Mini Grid de Features */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="p-4 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 transition-colors">
                            <ShieldCheck size={20} className="text-[#8A2BE2] mb-2" />
                            <div className="text-xs font-bold uppercase tracking-wider text-white">Seguridad</div>
                            <div className="text-[10px] text-white/40">Anti-fraude QR</div>
                        </div>
                        <div className="p-4 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 transition-colors">
                            <Zap size={20} className="text-[#FF007F] mb-2" />
                            <div className="text-xs font-bold uppercase tracking-wider text-white">Velocidad</div>
                            <div className="text-[10px] text-white/40">Acceso en 0.2s</div>
                        </div>
                    </div>
                </div>
            </div>

            {/* --- COLUMNA DERECHA: ACCIÓN (Lighter Glass) --- */}
            <div className="relative p-10 md:p-16 flex flex-col justify-center items-center text-center">
                
                {/* Separador Vertical (Solo Desktop) */}
                <div className="absolute left-0 top-10 bottom-10 w-px bg-gradient-to-b from-transparent via-white/10 to-transparent hidden lg:block" />

                <div className="max-w-xs w-full">
                    <h2 className="text-2xl font-black text-white tracking-tight mb-3">Solicitar Invitación</h2>
                    <p className="text-white/40 text-sm mb-10">
                        Selecciona un canal para verificar tu productora con nuestro equipo.
                    </p>

                    <div className="space-y-4">
                        {/* Botón WhatsApp (Primary) */}
                        <a 
                            href="https://wa.me/56912345678?text=Hola,%20quisiera%20solicitar%20acceso%20a%20DyzGO+" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="group relative w-full py-5 rounded-2xl font-black text-xs uppercase tracking-widest text-white overflow-hidden shadow-lg shadow-green-900/20 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3"
                        >
                            <div className="absolute inset-0 bg-[#25D366] group-hover:bg-[#20bd5a] transition-colors" />
                            <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10 mix-blend-overlay" />
                            <MessageCircle size={20} strokeWidth={2.5} className="relative z-10 text-black" />
                            <span className="relative z-10 text-black">WhatsApp Directo</span>
                        </a>

                        {/* Botón Correo (Secondary) */}
                        <a 
                            href="mailto:contacto@dyzgo.com?subject=Solicitud de Acceso DyzGO+&body=Hola equipo DyzGO, me gustaría solicitar acceso para mi productora..."
                            className="group w-full py-5 bg-white/5 border border-white/10 hover:border-white/20 hover:bg-white/10 rounded-2xl font-bold text-xs uppercase tracking-widest text-white/60 hover:text-white transition-all flex items-center justify-center gap-3"
                        >
                            <Mail size={18} className="group-hover:text-[#8A2BE2] transition-colors" />
                            <span>Enviar Correo</span>
                        </a>
                    </div>

                    <div className="mt-12 pt-6 border-t border-white/5 w-full">
                        <Link 
                            href="/login" 
                            className="inline-flex items-center gap-2 text-[10px] font-bold text-white/30 hover:text-white transition-colors uppercase tracking-[0.2em] group"
                        >
                            <ArrowLeft size={12} className="group-hover:-translate-x-1 transition-transform" /> 
                            Volver al Login
                        </Link>
                    </div>
                </div>
            </div>

        </div>
      </div>
    </div>
  )
}
</file>

<file path="app/(dashboard)/events/[id]/attendees/page.tsx">
'use client'
import React, { use, useEffect, useState } from 'react'
import { Search, Download, Filter, UserCheck, Mail, RefreshCw, Loader2, MoreHorizontal, CheckCircle, XCircle, Send, Users } from 'lucide-react'
import { supabase } from '@/lib/supabase'

export default function AttendeesPage({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const eventId = resolvedParams.id

  const [attendees, setAttendees] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')

  // Función para cargar asistentes reales
  const fetchAttendees = async () => {
    setLoading(true)
    const { data, error } = await supabase
      .from('tickets')
      .select('*, ticket_tiers(name), profiles(full_name, email)') 
      .eq('event_id', eventId)
      .order('created_at', { ascending: false })

    if (data) setAttendees(data)
    if (error) console.error("Error cargando asistentes:", error)
    setLoading(false)
  }

  useEffect(() => {
    fetchAttendees()
  }, [eventId])

  // Filtro de búsqueda local
  const filteredAttendees = attendees.filter(a => {
    const nameToCheck = a.profiles?.full_name || a.guest_name || ''
    const emailToCheck = a.profiles?.email || a.guest_email || ''
    const idToCheck = a.id || ''

    return (
        nameToCheck.toLowerCase().includes(searchTerm.toLowerCase()) || 
        emailToCheck.toLowerCase().includes(searchTerm.toLowerCase()) ||
        idToCheck.toLowerCase().includes(searchTerm.toLowerCase())
    )
  })

  return (
    // CONTENEDOR LIMPIO (El fondo ya está en el Layout)
    <div className="relative z-10 max-w-[1600px] mx-auto space-y-8 animate-in fade-in pt-4">
        
        {/* HEADER */}
        <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-white/5 pb-8">
            <div>
                <h1 className="text-3xl md:text-4xl font-black text-white tracking-tighter mb-2 flex items-center gap-3">
                    <Users className="text-[#8A2BE2]" size={32}/>
                    Lista de <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#8A2BE2] to-[#FF007F]">Asistentes</span>
                </h1>
                <p className="text-white/40 text-sm font-medium">Gestiona el acceso y controla el aforo de tu evento.</p>
            </div>
            
            {/* TOOLBAR */}
            <div className="flex flex-wrap gap-3 items-center">
                <div className="relative group shadow-lg shadow-purple-900/10">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-white/40 group-focus-within:text-white transition-colors" size={16} />
                    <input 
                        type="text" 
                        placeholder="Buscar asistente..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="h-12 pl-12 pr-4 bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl text-sm text-white focus:outline-none focus:border-[#8A2BE2]/50 transition-all w-full md:w-72 placeholder:text-white/20"
                    />
                </div>
                
                <button 
                    onClick={fetchAttendees}
                    className="h-12 w-12 flex items-center justify-center bg-white/5 border border-white/10 rounded-2xl text-white/60 hover:text-white hover:bg-white/10 transition-all hover:scale-105"
                    title="Sincronizar"
                >
                    <RefreshCw className={loading ? 'animate-spin' : ''} size={18} />
                </button>
                
                <button className="h-12 px-6 bg-white text-black font-bold rounded-2xl text-xs uppercase tracking-wider flex items-center gap-2 hover:scale-105 transition-transform shadow-[0_0_20px_rgba(255,255,255,0.15)]">
                    <Download size={16} /> Exportar
                </button>
            </div>
        </div>

        {/* TABLA LIQUID GLASS */}
        <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] overflow-hidden min-h-[500px] shadow-2xl shadow-purple-900/10 relative">
            
            {/* Header Tabla */}
            <div className="grid grid-cols-12 px-8 py-4 border-b border-white/5 bg-black/20 text-[10px] font-bold text-white/40 uppercase tracking-widest sticky top-0 backdrop-blur-md z-10">
                <div className="col-span-4">Asistente</div>
                <div className="col-span-3">Ticket</div>
                <div className="col-span-2">Estado</div>
                <div className="col-span-2">ID Compra</div>
                <div className="col-span-1 text-right"></div>
            </div>

            {/* Body Tabla */}
            <div className="divide-y divide-white/5">
                {loading ? (
                    <div className="flex flex-col items-center justify-center py-32 text-white/20">
                        <Loader2 className="animate-spin mb-2" size={32} />
                        <span className="text-xs font-medium">Cargando lista...</span>
                    </div>
                ) : filteredAttendees.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-32 text-white/20">
                        <Users size={40} className="mb-4 opacity-50" />
                        <span className="text-sm font-medium">No se encontraron asistentes.</span>
                    </div>
                ) : (
                    filteredAttendees.map((item) => {
                        let status = 'pending'
                        if (item.used) status = 'checked-in'
                        
                        const finalName = item.profiles?.full_name || item.guest_name || 'Sin Nombre'
                        const finalEmail = item.profiles?.email || item.guest_email || 'Sin Email'

                        return (
                            <AttendeeRow 
                                key={item.id}
                                id={item.id}
                                tierId={item.tier_id} 
                                name={finalName} 
                                email={finalEmail} 
                                ticket={item.ticket_type || item.ticket_tiers?.name || 'General'} 
                                status={status}
                                date={new Date(item.created_at).toLocaleDateString()}
                                onRefresh={fetchAttendees} 
                            />
                        )
                    })
                )}
            </div>
        </div>

        {/* FOOTER PAGINACIÓN */}
        <div className="flex justify-between items-center px-4 pt-2">
            <span className="text-xs font-medium text-white/40">Mostrando {filteredAttendees.length} registros</span>
            <div className="flex gap-2">
                <button className="px-4 py-2 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 text-xs font-bold text-white transition-all disabled:opacity-50">Anterior</button>
                <button className="px-4 py-2 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 text-xs font-bold text-white transition-all disabled:opacity-50">Siguiente</button>
            </div>
        </div>

    </div>
  )
}

function AttendeeRow({ id, tierId, name, email, ticket, status, date, onRefresh }: any) {
    const [showMenu, setShowMenu] = useState(false)
    const [processing, setProcessing] = useState(false)

    // 1. Reenviar Ticket
    const handleResend = async () => {
        setProcessing(true)
        await new Promise(resolve => setTimeout(resolve, 1000))
        alert(`Ticket reenviado a ${email}`)
        setProcessing(false)
        setShowMenu(false)
    }

    // 2. Validar Ticket
    const handleValidate = async () => {
        setProcessing(true)
        const { error } = await supabase
            .from('tickets')
            .update({ used: true })
            .eq('id', id)
        
        if (!error) onRefresh()
        setProcessing(false)
        setShowMenu(false)
    }

    // 3. Anular Ticket
    const handleVoid = async () => {
        if(!confirm("¿Estás seguro de anular este ticket? Se eliminará y devolverá el stock.")) return;
        setProcessing(true)
        const { error } = await supabase.rpc('void_ticket', { ticket_id_input: id })
        if (error) alert("Error: " + error.message)
        else onRefresh()
        setProcessing(false)
        setShowMenu(false)
    }

    return (
        <div className="grid grid-cols-12 px-8 py-5 hover:bg-white/5 transition-colors group items-center relative text-sm">
            <div className="col-span-4 pr-4">
                <div className="font-bold text-white mb-0.5 truncate">{name}</div>
                <div className="text-white/40 text-xs flex items-center gap-1.5 truncate">
                    <Mail size={10} /> {email}
                </div>
            </div>
            <div className="col-span-3">
                <div className="text-white/80 font-medium truncate">{ticket}</div>
                <div className="text-white/30 text-[10px] uppercase font-bold tracking-wider mt-0.5">{date}</div>
            </div>
            <div className="col-span-2">
                {status === 'checked-in' ? (
                    <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-[#00D15B]/10 text-[#00D15B] text-[9px] font-black border border-[#00D15B]/20 uppercase tracking-wide">
                        <UserCheck size={10} /> Ingresado
                    </span>
                ) : (
                    <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-white/5 text-white/40 text-[9px] font-black border border-white/10 uppercase tracking-wide">
                        Pendiente
                    </span>
                )}
            </div>
            <div className="col-span-2">
                <span className="text-white/30 font-mono text-xs tracking-wider">#{id.slice(0, 8)}</span>
            </div>
            <div className="col-span-1 text-right relative">
                <button 
                    onClick={() => setShowMenu(!showMenu)} 
                    className="h-8 w-8 flex items-center justify-center rounded-lg hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                >
                    <MoreHorizontal size={16} />
                </button>

                {showMenu && (
                    <>
                        <div className="fixed inset-0 z-10" onClick={() => setShowMenu(false)} />
                        <div className="absolute right-0 top-10 z-20 w-48 bg-[#050505]/95 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200">
                            <div className="p-1.5 flex flex-col gap-1">
                                <button onClick={handleResend} disabled={processing} className="w-full text-left px-3 py-2.5 text-xs font-bold text-white/80 hover:bg-white/10 hover:text-white rounded-xl flex items-center gap-2 transition-colors">
                                    <Send size={14} className="text-[#3b82f6]" /> Reenviar
                                </button>
                                <button onClick={handleValidate} disabled={processing || status === 'checked-in'} className="w-full text-left px-3 py-2.5 text-xs font-bold text-white/80 hover:bg-white/10 hover:text-white rounded-xl flex items-center gap-2 transition-colors disabled:opacity-50">
                                    <CheckCircle size={14} className="text-[#00D15B]" /> Validar
                                </button>
                                <div className="h-px bg-white/10 my-0.5 mx-2" />
                                <button onClick={handleVoid} disabled={processing} className="w-full text-left px-3 py-2.5 text-xs font-bold text-red-400 hover:bg-red-500/10 hover:text-red-300 rounded-xl flex items-center gap-2 transition-colors">
                                    <XCircle size={14} /> Anular
                                </button>
                            </div>
                        </div>
                    </>
                )}
            </div>
        </div>
    )
}
</file>

<file path="app/(dashboard)/events/[id]/rrpp/page.tsx">
'use client'
import { useEffect, useState, use, forwardRef, useRef } from 'react'
import { supabase } from '@/lib/supabase'
import { 
    Loader2, Plus, Ticket, Gift, Search,
    Layers, PlusCircle, FileSpreadsheet, Download, Upload, CheckCircle2, Trash2,
    X, Sparkles, Calendar, Clock, Mail, User, ChevronDown, Send
} from 'lucide-react'
import * as XLSX from 'xlsx'
import { useEventStore } from '@/store/useEventStore'

// --- IMPORTS PARA EL DATEPICKER ---
import DatePicker, { registerLocale } from 'react-datepicker' 
import "react-datepicker/dist/react-datepicker.css"
import { es } from 'date-fns/locale/es'

registerLocale('es', es)

// --- ESTILOS CSS PERSONALIZADOS PARA EL DATEPICKER (DARK THEME) ---
const datePickerStyles = `
  .react-datepicker-wrapper { width: 100%; }
  .react-datepicker-popper { z-index: 9999 !important; }
  .react-datepicker {
    font-family: inherit;
    background-color: #09090b; 
    border: 1px solid rgba(255,255,255,0.1); 
    color: white;
    border-radius: 1.5rem;
    padding: 1rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(20px);
  }
  .react-datepicker__header {
    background-color: transparent;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-top: 0.5rem;
  }
  .react-datepicker__current-month {
    color: white !important;
    font-weight: 800;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
  }
  .react-datepicker__day-name {
    color: rgba(255,255,255,0.3) !important;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.7rem;
    margin: 0.3rem;
  }
  .react-datepicker__day { 
    color: rgba(255,255,255,0.8); 
    font-weight: 500;
    margin: 0.3rem;
    width: 2rem;
    height: 2rem;
    line-height: 2rem;
    border-radius: 0.75rem;
    transition: all 0.2s;
  }
  .react-datepicker__day:hover {
    background-color: rgba(255,255,255,0.1) !important;
    color: white !important;
  }
  /* Día seleccionado */
  .react-datepicker__day--selected, .react-datepicker__day--keyboard-selected {
    background-color: #00D15B !important;
    color: black !important;
    font-weight: 900;
    box-shadow: 0 0 20px rgba(0, 209, 91, 0.3);
  }
  .react-datepicker__day--today {
    border: 1px solid #00D15B;
    font-weight: bold;
    color: #00D15B;
    background-color: transparent;
  }
  .react-datepicker__day--outside-month { color: rgba(255,255,255,0.1) !important; }
  .react-datepicker__navigation-icon::before {
    border-color: rgba(255,255,255,0.5); border-width: 2px 2px 0 0; height: 6px; width: 6px;
  }
`

// --- INPUT PERSONALIZADO DATEPICKER ---
// eslint-disable-next-line react/display-name
const CustomDateInput = forwardRef(({ value, onClick, placeholder }: any, ref: any) => (
  <div onClick={onClick} ref={ref} className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm outline-none hover:border-[#00D15B]/50 focus:border-[#00D15B] cursor-pointer transition-all font-medium flex justify-between items-center group shadow-sm text-white">
      <span className={value ? 'text-white' : 'text-white/30'}>{value || placeholder}</span>
      <Calendar className="text-white/30 group-hover:text-[#00D15B] transition-colors" size={18}/>
  </div>
))

// --- COMPONENTE SELECT PERSONALIZADO ---
const CustomSelect = ({ options, value, onChange, placeholder, variant = 'green' }: { options: { label: string, value: string }[], value: string, onChange: (val: string) => void, placeholder: string, variant?: 'green' | 'purple' }) => {
    const [isOpen, setIsOpen] = useState(false);
    const containerRef = useRef<HTMLDivElement>(null);

    const activeColor = variant === 'purple' ? 'border-[#8A2BE2]' : 'border-[#00D15B]';
    const hoverColor = variant === 'purple' ? 'hover:border-[#8A2BE2]/50' : 'hover:border-[#00D15B]/50';
    const textHover = variant === 'purple' ? 'group-hover:text-[#8A2BE2]' : 'group-hover:text-[#00D15B]';
    const optionSelected = variant === 'purple' ? 'bg-[#8A2BE2]/10 text-[#8A2BE2]' : 'bg-[#00D15B]/10 text-[#00D15B]';

    useEffect(() => {
        const handleClickOutside = (event: MouseEvent) => {
            if (containerRef.current && !containerRef.current.contains(event.target as Node)) setIsOpen(false);
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const selectedLabel = options.find(o => o.value === value)?.label;

    return (
        <div className="relative w-full" ref={containerRef}>
            <div onClick={() => setIsOpen(!isOpen)} className={`w-full bg-black/40 border ${isOpen ? activeColor : 'border-white/10'} rounded-2xl px-5 py-4 text-sm outline-none ${hoverColor} cursor-pointer transition-all font-medium flex justify-between items-center group shadow-sm`}>
                <span className={selectedLabel ? 'text-white' : 'text-white/30'}>{selectedLabel || placeholder}</span>
                <ChevronDown className={`text-white/30 ${textHover} transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} size={18}/>
            </div>
            {isOpen && (
                <div className="absolute top-full left-0 mt-2 w-full bg-[#050505]/95 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl z-[60] overflow-hidden animate-in fade-in zoom-in-95 duration-200 max-h-60 overflow-y-auto custom-scrollbar">
                    {options.length > 0 ? (
                        options.map((option) => (
                            <div key={option.value} onClick={() => { onChange(option.value); setIsOpen(false); }} className={`px-5 py-3 text-xs cursor-pointer transition-colors border-b border-white/5 last:border-0 font-medium tracking-wide ${value === option.value ? optionSelected : 'text-zinc-400 hover:bg-white/5 hover:text-white'}`}>
                                {option.label}
                            </div>
                        ))
                    ) : (
                        <div className="px-5 py-4 text-xs text-white/30 italic text-center">No hay opciones disponibles</div>
                    )}
                </div>
            )}
        </div>
    );
};

interface CourtesyTicket {
  id: string; guest_name: string; guest_email: string; ticket_name: string; created_at: string; status: string
}

export default function RRPPPage({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const eventId = resolvedParams.id
  const { eventData, loadEvent } = useEventStore()

  const [loading, setLoading] = useState(true)
  const [courtesyList, setCourtesyList] = useState<CourtesyTicket[]>([])
  const [searchTerm, setSearchTerm] = useState('')

  // --- ESTADOS DE SETTINGS ---
  const [uploadedGroups, setUploadedGroups] = useState<any[]>([])
  const [dbName, setDbName] = useState('')
  const [previewData, setPreviewData] = useState<any[] | null>(null)
  const [isIndividualCourtesyOpen, setIsIndividualCourtesyOpen] = useState(false)
  const [isGroupCourtesyOpen, setIsGroupCourtesyOpen] = useState(false)
  const [recipients, setRecipients] = useState([{ email: '', nombre: '', apellido: '', rut: '', cantidad: 1 }])
  
  // ESTADOS MODALES
  const [selectedDate, setSelectedDate] = useState<Date | null>(null)
  const [selectedDb, setSelectedDb] = useState('')
  const [selectedTicket, setSelectedTicket] = useState('')
  const [selectedIndividualTicket, setSelectedIndividualTicket] = useState('') 

  useEffect(() => {
    async function fetchAllData() {
      try {
        setLoading(true)
        await loadEvent(eventId)
        const { data: eventDataDB, error: eventError } = await supabase.from('events').select('uploaded_dbs').eq('id', eventId).single()
        if (!eventError && eventDataDB?.uploaded_dbs) setUploadedGroups(eventDataDB.uploaded_dbs)
        const { data: ticketsData, error: ticketsError } = await supabase.from('tickets').select('*').eq('event_id', eventId).order('created_at', { ascending: false })
        if (ticketsError) throw ticketsError
        if (ticketsData) setCourtesyList(ticketsData as unknown as CourtesyTicket[])
      } catch (error) { console.error('Error fetching data:', error) } finally { setLoading(false) }
    }
    fetchAllData()
  }, [eventId, loadEvent])

  // --- LOGICA ---
  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]; if (!file) return; const reader = new FileReader();
    reader.onload = (evt) => {
      const bstr = evt.target?.result; const wb = XLSX.read(bstr, { type: 'binary' }); const wsname = wb.SheetNames[0]; const ws = wb.Sheets[wsname]; const data = XLSX.utils.sheet_to_json(ws); setPreviewData(data);
    }
    reader.readAsBinaryString(file)
  }

  const saveDatabase = async () => {
    if (!dbName || !previewData) return; const newGroup = { name: dbName, data: previewData, date: new Date().toLocaleDateString('es-CL') }; const updatedGroups = [...uploadedGroups, newGroup];
    const { error } = await supabase.from('events').update({ uploaded_dbs: updatedGroups }).eq('id', eventId); if (error) alert("Error"); else { setUploadedGroups(updatedGroups); setPreviewData(null); setDbName('') }
  }

  const removeGroup = async (idx: number) => {
    if(!confirm("¿Eliminar?")) return; const updatedGroups = uploadedGroups.filter((_, i) => i !== idx);
    const { error } = await supabase.from('events').update({ uploaded_dbs: updatedGroups }).eq('id', eventId); if(error) alert("Error"); else setUploadedGroups(updatedGroups)
  }

  const addRecipient = () => setRecipients([...recipients, { email: '', nombre: '', apellido: '', rut: '', cantidad: 1 }])

  const filteredList = courtesyList.filter(ticket => ticket.guest_name?.toLowerCase().includes(searchTerm.toLowerCase()) || ticket.guest_email?.toLowerCase().includes(searchTerm.toLowerCase()) || ticket.ticket_name?.toLowerCase().includes(searchTerm.toLowerCase()))

  const courtesyTicketsOnly = eventData?.tickets?.filter((t: any) => t.type === 'courtesy') || []

  if (loading) return (
    <div className="flex items-center justify-center h-full pt-40">
        <Loader2 className="animate-spin text-[#8A2BE2]" size={40} />
    </div>
  )

  return (
    // CONTENEDOR LIMPIO (Sin fondo, ya está en el Layout)
    <div className="relative z-10 max-w-[1600px] mx-auto space-y-8 animate-in fade-in pt-4">
        <style>{datePickerStyles}</style>
        
        {/* HEADER */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 border-b border-white/5 pb-8">
            <div>
                <h1 className="text-3xl md:text-4xl font-black text-white tracking-tighter mb-2">
                    RRPP & <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#8A2BE2] to-[#FF007F]">Cortesías</span>
                </h1>
                <p className="text-white/40 text-sm font-medium">Gestiona el envío de entradas de cortesía y bases de datos.</p>
            </div>
        </div>

        {/* TERMINAL DE CORTESÍAS */}
        <section className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2.5rem] p-10 relative overflow-hidden shadow-2xl group transition-all">
            <div className="absolute top-0 right-0 w-[400px] h-[400px] bg-[#3b82f6]/10 rounded-full blur-[100px] pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-700" />
            
            <div className="flex items-center gap-5 border-b border-white/5 pb-8 mb-8 relative z-10">
                <div className="p-3.5 bg-[#3b82f6]/10 rounded-2xl text-[#3b82f6] shadow-[0_0_20px_rgba(59,130,246,0.2)] border border-[#3b82f6]/20">
                    <Ticket size={28} />
                </div>
                <div>
                    <h3 className="text-xl font-black text-white tracking-tight uppercase">Terminal de Cortesías</h3>
                    <p className="text-white/40 text-xs font-medium tracking-wide mt-1">Gestión de invitaciones y accesos directos.</p>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                <button onClick={() => setIsIndividualCourtesyOpen(true)} className="flex flex-col items-start gap-5 p-8 bg-black/40 border border-white/5 rounded-[2rem] hover:border-[#8A2BE2]/50 hover:bg-[#8A2BE2]/5 transition-all group/card shadow-lg hover:shadow-[#8A2BE2]/20">
                    <div className="p-3 bg-white/5 rounded-2xl text-[#8A2BE2] group-hover/card:scale-110 transition-transform border border-white/5">
                        <PlusCircle size={32}/>
                    </div>
                    <div className="text-left space-y-1">
                        <span className="text-sm font-black text-white block uppercase tracking-wider">Invitación Directa</span>
                        <span className="text-[10px] text-white/40 font-medium block">Envía tickets personalizados a clientes VIP.</span>
                    </div>
                </button>
                
                <button onClick={() => setIsGroupCourtesyOpen(true)} className="flex flex-col items-start gap-5 p-8 bg-black/40 border border-white/5 rounded-[2rem] hover:border-[#00D15B]/50 hover:bg-[#00D15B]/5 transition-all group/card shadow-lg hover:shadow-[#00D15B]/20">
                    <div className="p-3 bg-white/5 rounded-2xl text-[#00D15B] group-hover/card:scale-110 transition-transform border border-white/5">
                        <Layers size={32}/>
                    </div>
                    <div className="text-left space-y-1">
                        <span className="text-sm font-black text-white block uppercase tracking-wider">Despacho Masivo</span>
                        <span className="text-[10px] text-white/40 font-medium block">Usa tus grupos de base de datos importados.</span>
                    </div>
                </button>
            </div>
        </section>

        {/* DATA IMPORTADA */}
        <section className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2.5rem] p-10 relative overflow-hidden shadow-2xl">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-white/5 pb-8 mb-8">
                <div className="flex items-center gap-5">
                    <div className="p-3.5 bg-[#00D15B]/10 rounded-2xl text-[#00D15B] shadow-[0_0_20px_rgba(34,197,94,0.2)] border border-[#00D15B]/20">
                        <FileSpreadsheet size={28} />
                    </div>
                    <div>
                        <h3 className="text-xl font-black text-white tracking-tight uppercase">Data Importada</h3>
                        <p className="text-white/40 text-xs font-medium tracking-wide mt-1">Sincronización con Supabase.</p>
                    </div>
                </div>
                <a href="/plantilla-clientes.xlsx" download className="flex items-center gap-2 px-6 py-3 bg-white/5 hover:bg-white/10 text-white/60 hover:text-white text-[10px] font-black rounded-xl transition-all border border-white/5 hover:border-white/20 uppercase tracking-widest shadow-lg">
                    <Download size={14} /> Plantilla
                </a>
            </div>

            <label className="border-2 border-dashed border-white/10 hover:border-[#8A2BE2]/40 rounded-[2rem] p-12 flex flex-col items-center justify-center gap-4 cursor-pointer transition-all bg-black/20 hover:bg-black/40 group">
                <input type="file" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="hidden" />
                <div className="p-5 bg-white/5 rounded-2xl text-white/30 group-hover:text-[#8A2BE2] group-hover:scale-110 transition-all shadow-lg border border-white/5">
                    <Upload size={32} />
                </div>
                <p className="text-xs font-bold text-white/40 group-hover:text-white uppercase tracking-widest transition-colors">Subir archivo Excel</p>
            </label>

            {uploadedGroups.length > 0 && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-8">
                    {uploadedGroups.map((group, idx) => (
                        <div key={idx} className="flex items-center justify-between p-6 bg-black/40 border border-white/5 rounded-3xl group hover:border-[#00D15B]/30 transition-all shadow-md">
                            <div className="flex items-center gap-4">
                                <div className="p-2.5 bg-[#00D15B]/10 rounded-xl text-[#00D15B] border border-[#00D15B]/20">
                                    <CheckCircle2 size={20}/>
                                </div>
                                <div>
                                    <p className="text-sm font-black text-white uppercase mb-1 leading-none tracking-wide">{group.name}</p>
                                    <p className="text-[10px] text-white/40 font-bold uppercase tracking-wider">{group.data.length} Clientes • {group.date}</p>
                                </div>
                            </div>
                            <button onClick={() => removeGroup(idx)} className="p-3 text-white/20 hover:text-[#FF007F] opacity-0 group-hover:opacity-100 transition-all transform hover:scale-110 hover:bg-white/5 rounded-xl">
                                <Trash2 size={18} />
                            </button>
                        </div>
                    ))}
                </div>
            )}
        </section>

        {/* REGISTRO DE CORTESÍAS */}
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <div className="p-2.5 bg-[#FF007F]/10 rounded-xl text-[#FF007F] border border-[#FF007F]/20">
                        <Gift size={20}/>
                    </div>
                    <h3 className="text-lg font-black text-white uppercase tracking-wide">Registro de Cortesías</h3>
                </div>
                
                <div className="bg-black/40 border border-white/10 rounded-xl p-1 flex items-center gap-2 w-full max-w-sm backdrop-blur-md focus-within:border-[#FF007F]/50 transition-colors">
                    <Search size={16} className="text-white/30 ml-3" />
                    <input 
                        type="text" 
                        placeholder="Buscar por nombre, email o ticket..." 
                        value={searchTerm} 
                        onChange={(e) => setSearchTerm(e.target.value)} 
                        className="bg-transparent border-none outline-none text-xs text-white flex-1 p-2 placeholder:text-white/20 font-medium" 
                    />
                </div>
            </div>

            <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] overflow-hidden shadow-2xl">
                <div className="grid grid-cols-12 gap-4 px-8 py-4 border-b border-white/5 bg-black/40 text-[10px] font-black text-white/40 uppercase tracking-widest">
                    <div className="col-span-4">Invitado</div>
                    <div className="col-span-3">Ticket Enviado</div>
                    <div className="col-span-3">Fecha de Envío</div>
                    <div className="col-span-2 text-right">Estado</div>
                </div>
                
                <div className="max-h-[500px] overflow-y-auto custom-scrollbar">
                    {filteredList.length === 0 ? (
                        <div className="p-20 flex flex-col items-center justify-center text-center">
                            <div className="p-5 bg-white/5 rounded-full mb-4 border border-white/5">
                                <Gift size={32} className="text-white/20"/>
                            </div>
                            <p className="text-white/30 text-xs font-bold uppercase tracking-wide">No se encontraron cortesías enviadas.</p>
                        </div>
                    ) : (
                        filteredList.map((ticket) => (
                            <div key={ticket.id} className="grid grid-cols-12 gap-4 px-8 py-5 border-b border-white/5 items-center hover:bg-white/5 transition-colors text-xs group">
                                <div className="col-span-4">
                                    <p className="font-bold text-white flex items-center gap-2 mb-1">
                                        <User size={12} className="text-[#8A2BE2]"/> {ticket.guest_name || 'Sin Nombre'}
                                    </p>
                                    <p className="text-white/40 flex items-center gap-2 ml-5 truncate text-[10px] font-medium">{ticket.guest_email}</p>
                                </div>
                                <div className="col-span-3">
                                    <span className="bg-[#8A2BE2]/10 text-[#8A2BE2] border border-[#8A2BE2]/20 px-3 py-1 rounded-lg font-bold text-[10px] uppercase tracking-wide shadow-sm">
                                        {ticket.ticket_name}
                                    </span>
                                </div>
                                <div className="col-span-3 text-white/50 font-medium flex items-center gap-2">
                                    <Clock size={12} className="text-white/30"/>
                                    {new Date(ticket.created_at).toLocaleDateString()} <span className="text-white/20">•</span> {new Date(ticket.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </div>
                                <div className="col-span-2 text-right">
                                    <span className="text-[#00D15B] font-bold flex items-center justify-end gap-1.5 uppercase text-[10px] tracking-wide bg-[#00D15B]/5 px-2 py-1 rounded-lg w-fit ml-auto border border-[#00D15B]/10">
                                        <CheckCircle2 size={12}/> Enviado
                                    </span>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>
        </div>

        {/* --- MODAL INVITACIÓN INDIVIDUAL REDISEÑADO --- */}
        {isIndividualCourtesyOpen && (
            <div className="fixed inset-0 z-[130] flex items-center justify-center p-4 animate-in fade-in duration-300">
                <div className="absolute inset-0 bg-[#050505]/95 backdrop-blur-3xl" onClick={() => setIsIndividualCourtesyOpen(false)} />
                <div className="relative w-full max-w-6xl bg-[#09090b] border border-white/10 rounded-[3rem] p-12 shadow-2xl animate-in zoom-in-95 overflow-hidden">
                    
                    {/* Glow Ambiental Morado */}
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#8A2BE2] to-[#FF007F] opacity-80" />
                    <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-[#8A2BE2]/10 rounded-full blur-[120px] pointer-events-none" />

                    <div className="flex justify-between items-center mb-10 relative z-10">
                        <div className="flex items-center gap-5">
                            <div className="p-3.5 bg-[#8A2BE2]/10 rounded-2xl text-[#8A2BE2] shadow-[0_0_20px_rgba(138,43,226,0.3)] border border-[#8A2BE2]/30">
                                <PlusCircle size={32}/>
                            </div>
                            <h3 className="text-3xl font-black text-white tracking-tighter leading-none uppercase">Invitación Directa</h3>
                        </div>
                        <button onClick={() => setIsIndividualCourtesyOpen(false)} className="p-3 bg-white/5 rounded-full text-white/40 hover:text-white transition-all hover:bg-white/10 hover:scale-110 border border-white/5"><X size={24}/></button>
                    </div>
                    
                    <div className="relative z-10">
                        <div className="mb-8 w-full max-w-md">
                            <label className="text-[10px] font-black text-[#8A2BE2] uppercase tracking-[0.2em] ml-2 mb-3 block">Seleccionar Ticket</label>
                            <CustomSelect 
                                value={selectedIndividualTicket}
                                onChange={setSelectedIndividualTicket}
                                placeholder="Seleccionar Ticket..."
                                variant="purple"
                                options={courtesyTicketsOnly.map(t => ({ label: t.name, value: t.name }))}
                            />
                        </div>

                        <div className="space-y-4 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">
                            {recipients.map((r, i) => (
                                <div key={i} className="grid grid-cols-1 md:grid-cols-6 gap-5 items-end bg-white/5 p-6 rounded-[2rem] border border-white/5 hover:border-[#8A2BE2]/40 transition-all shadow-lg hover:shadow-[#8A2BE2]/10 group">
                                    <div className="space-y-2 col-span-1.5"><label className="text-[9px] font-black text-white/30 uppercase tracking-widest ml-1 group-hover:text-[#8A2BE2] transition-colors">Email</label><input placeholder="ej@mail.com" className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3 text-xs text-white focus:border-[#8A2BE2] focus:bg-black/60 outline-none font-medium placeholder:text-white/20 transition-all shadow-inner" /></div>
                                    <div className="space-y-2"><label className="text-[9px] font-black text-white/30 uppercase tracking-widest ml-1">Nombre</label><input placeholder="Nombre" className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3 text-xs text-white focus:border-[#8A2BE2] focus:bg-black/60 outline-none font-medium placeholder:text-white/20 transition-all shadow-inner" /></div>
                                    <div className="space-y-2"><label className="text-[9px] font-black text-white/30 uppercase tracking-widest ml-1">Apellido</label><input placeholder="Apellido" className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3 text-xs text-white focus:border-[#8A2BE2] focus:bg-black/60 outline-none font-medium placeholder:text-white/20 transition-all shadow-inner" /></div>
                                    <div className="space-y-2"><label className="text-[9px] font-black text-white/30 uppercase tracking-widest ml-1">RUT</label><input placeholder="Opcional" className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3 text-xs text-white focus:border-[#8A2BE2] focus:bg-black/60 outline-none font-medium placeholder:text-white/20 transition-all shadow-inner" /></div>
                                    <div className="space-y-2"><label className="text-[9px] font-black text-white/30 uppercase tracking-widest ml-1">Cant.</label><input type="number" defaultValue={1} className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3 text-xs text-white focus:border-[#8A2BE2] focus:bg-black/60 outline-none font-medium placeholder:text-white/20 transition-all shadow-inner text-center" /></div>
                                    <button onClick={() => setRecipients(recipients.filter((_, idx) => idx !== i))} className="p-3 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white rounded-2xl transition-all mb-0.5 border border-red-500/20 hover:border-transparent hover:shadow-[0_0_15px_rgba(220,38,38,0.4)]"><X size={18} /></button>
                                </div>
                            ))}
                        </div>
                        
                        <div className="flex gap-4 pt-10">
                            <button onClick={addRecipient} className="flex-1 py-5 bg-white/5 border border-white/10 text-white/50 font-bold rounded-[1.5rem] hover:text-white hover:bg-white/10 hover:border-white/20 transition-all uppercase tracking-widest text-xs flex items-center justify-center gap-2">
                                <Plus size={16}/> Añadir Persona
                            </button>
                            <button className="flex-[2.5] py-5 bg-gradient-to-r from-[#8A2BE2] to-[#7c3aed] text-white font-black rounded-[1.5rem] shadow-[0_0_40px_rgba(138,43,226,0.3)] uppercase tracking-[0.25em] transition-all hover:scale-[1.01] active:scale-95 flex items-center justify-center gap-3">
                                <Send size={16} /> Despachar Cortesías
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* --- MODAL DESPACHO MASIVO REDISEÑADO --- */}
        {isGroupCourtesyOpen && (
            <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 animate-in fade-in duration-300">
                <div className="absolute inset-0 bg-[#050505]/95 backdrop-blur-3xl" onClick={() => setIsGroupCourtesyOpen(false)} />
                <div className="relative w-full max-w-4xl bg-[#09090b] border border-white/10 rounded-[3.5rem] p-16 shadow-2xl animate-in zoom-in-95 overflow-hidden">
                    
                    {/* Glow Ambiental Verde */}
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#00D15B] to-[#10b981] opacity-80" />
                    <div className="absolute bottom-0 right-0 w-[400px] h-[400px] bg-[#00D15B]/10 rounded-full blur-[100px] pointer-events-none" />

                    <div className="flex justify-between items-center mb-14 relative z-10">
                        <div className="flex items-center gap-6">
                            <div className="p-4 bg-[#00D15B]/10 rounded-3xl text-[#00D15B] shadow-[0_0_25px_rgba(34,197,94,0.25)] border border-[#00D15B]/30"><Layers size={36}/></div>
                            <div>
                                <h3 className="text-4xl font-black text-white tracking-tighter leading-none uppercase">Envío Masivo</h3>
                                <p className="text-white/40 text-xs font-medium tracking-wide mt-1">Despacho automatizado a bases de datos.</p>
                            </div>
                        </div>
                        <button onClick={() => setIsGroupCourtesyOpen(false)} className="p-4 bg-white/5 rounded-full text-white/40 hover:text-white transition-all hover:bg-white/10 hover:scale-110 border border-white/5"><X size={24}/></button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-14 relative z-10">
                        <div className="space-y-4">
                            <label className="text-[10px] font-black text-[#00D15B] uppercase tracking-[0.2em] ml-2">Base de Datos</label>
                            <CustomSelect value={selectedDb} onChange={setSelectedDb} placeholder="Seleccionar..." variant="green" options={uploadedGroups.map(g => ({ label: `${g.name} (${g.data.length})`, value: g.name }))} />
                        </div>
                        <div className="space-y-4">
                            <label className="text-[10px] font-black text-[#00D15B] uppercase tracking-[0.2em] ml-2">Ticket (Cortesía)</label>
                            <CustomSelect value={selectedTicket} onChange={setSelectedTicket} placeholder="Seleccionar..." variant="green" options={courtesyTicketsOnly.map(t => ({ label: t.name, value: t.name }))} />
                        </div>
                        <div className="space-y-4">
                            <label className="text-[10px] font-black text-[#00D15B] uppercase tracking-[0.2em] ml-2">Vencimiento</label>
                            <div className="relative z-50"><DatePicker selected={selectedDate} onChange={(date) => setSelectedDate(date)} locale="es" dateFormat="dd/MM/yyyy" placeholderText="dd-mm-aaaa" customInput={<CustomDateInput placeholder="dd-mm-aaaa" />} wrapperClassName="w-full" /></div>
                        </div>
                    </div>

                    <button className="w-full py-6 bg-gradient-to-r from-[#00D15B] to-[#10b981] text-black font-black rounded-[2rem] shadow-[0_0_50px_rgba(34,197,94,0.3)] uppercase tracking-[0.3em] transition-all hover:scale-[1.01] active:scale-95 text-xs flex items-center justify-center gap-3 relative z-10 group">
                        <Send size={18} className="group-hover:translate-x-1 transition-transform"/> Iniciar Despacho
                    </button>
                </div>
            </div>
        )}
    </div>
  )
}
</file>

<file path="app/(dashboard)/events/[id]/settings/page.tsx">
'use client'
import { useState, useEffect, use, useRef } from 'react'
import { useRouter } from 'next/navigation' 
import { 
  Globe, 
  Zap, 
  AlertTriangle, 
  Save, 
  Trash2, 
  Loader2,
  CheckCircle2,
  AlertCircle,
  Settings as SettingsIcon,
  ShieldCheck,
  RefreshCcw,
  Users
} from 'lucide-react'
import { useEventStore } from '@/store/useEventStore'
import { supabase } from '@/lib/supabase'

export default function SettingsPage({ params }: { params: Promise<{ id: string }> }) {
  const router = useRouter()
  const resolvedParams = use(params)
  const eventId = resolvedParams.id

  const { updateSettings } = useEventStore()
  const [isDeleting, setIsDeleting] = useState(false)
  const [isSaving, setIsSaving] = useState(false)

  const saveButtonRef = useRef<HTMLDivElement>(null) 

  const [isDirty, setIsDirty] = useState(false)
  const [showUnsavedWarning, setShowUnsavedWarning] = useState(false)
  const [highlightSave, setHighlightSave] = useState(false)
  const [showToast, setShowToast] = useState(false)
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false)
  const [deleteInput, setDeleteInput] = useState('')

  // ESTADOS
  const [isLive, setIsLive] = useState(false) 
  const [maxTickets, setMaxTickets] = useState(4)
  const [isTransferable, setIsTransferable] = useState(true)
  const [isResellable, setIsResellable] = useState(false)
  
  // ESTADO INTERNO: Fecha de fin para validación
  const [eventEndDate, setEventEndDate] = useState<string | null>(null)
  const [eventEndTime, setEventEndTime] = useState<string | null>(null)

  // 1. CARGA INICIAL
  useEffect(() => {
    const fetchLatestData = async () => {
      const { data: event, error } = await supabase
        .from('events')
        .select(`
            status, 
            max_tickets_per_person,
            is_transferable,
            is_resellable,
            date,
            end_date,
            end_time
        `) 
        .eq('id', eventId)
        .single()

      if (event && !error) {
        // CORREGIDO: Se activa si el status es 'active'
        setIsLive(event.status === 'active')
        if (event.max_tickets_per_person) setMaxTickets(event.max_tickets_per_person)
        setIsTransferable(event.is_transferable ?? true)
        setIsResellable(event.is_resellable ?? false)
        
        // Guardamos fechas para validar al guardar
        setEventEndDate(event.end_date || event.date)
        setEventEndTime(event.end_time || '23:59:59')
      }
    }

    fetchLatestData()
  }, [eventId])

  // BLOQUEO DE NAVEGACIÓN
  useEffect(() => {
    const handleBeforeUnload = (e: BeforeUnloadEvent) => {
      if (isDirty) {
        saveButtonRef.current?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        e.preventDefault(); e.returnValue = ''; 
      }
    };
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [isDirty]);

  const handleFinalDelete = async () => {
    if (deleteInput !== 'DELETE') return
    setIsDeleting(true)
    try {
      const { error } = await supabase.from('events').delete().eq('id', eventId)
      if (error) throw error
      setIsDeleteModalOpen(false)
      setIsDirty(false); router.push('/events') 
    } catch (error) { alert("No se pudo eliminar el evento.") } finally { setIsDeleting(false) }
  }

  const handleSaveChanges = async () => {
    setIsSaving(true)
    try {
      // CORRECCIÓN: Ahora usamos 'active' en lugar de 'published'
      let newStatus = isLive ? 'active' : 'draft'
      
      // --- VALIDACIÓN DE CADUCIDAD AL GUARDAR ---
      if (newStatus === 'active' && eventEndDate) {
          const now = new Date()
          const endDateTime = new Date(`${eventEndDate}T${eventEndTime}`)
          
          if (endDateTime < now) {
              alert("⚠️ No puedes activar este evento porque su fecha de término ya pasó. Se marcará como FINALIZADO.")
              newStatus = 'ended'
              setIsLive(false) 
          }
      }
      // ------------------------------------------

      const payload = { 
        status: newStatus,
        max_tickets_per_person: maxTickets,
        is_transferable: isTransferable, 
        is_resellable: isResellable      
      }

      const { error } = await supabase.from('events').update(payload).eq('id', eventId)
      
      if (error) {
        console.error("Supabase error:", error) // Logueamos el error específico de Supabase
        throw error
      }
      
      // IMPORTANTE: Actualizamos también 'isPrivate' en el store para que el panel lateral reaccione inmediatamente
      await updateSettings({ 
        status: newStatus, // Esto actualizará el store localmente también
        isPrivate: newStatus === 'draft'
      })
      
      setIsDirty(false); setShowToast(true); setTimeout(() => setShowToast(false), 3000);
      router.refresh() // Forzamos refresco para asegurar sincronización visual global
    } catch (error) {
      console.error("Error al guardar:", error)
      alert("Error al sincronizar. Revisa la consola para más detalles.")
    } finally { setIsSaving(false) }
  }

  return (
    // CONTENEDOR LIMPIO (Sin fondo, ya está en el Layout)
    <div className="relative z-10 max-w-[1600px] mx-auto space-y-8 animate-in fade-in pt-4">
      
        {/* HEADER */}
        <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-white/5 pb-8">
            <div>
                <h1 className="text-3xl md:text-4xl font-black text-white tracking-tighter mb-2 flex items-center gap-3">
                    <SettingsIcon className="text-[#8A2BE2]" size={32}/>
                    Ajustes del <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#8A2BE2] to-[#FF007F]">Evento</span>
                </h1>
                <p className="text-white/40 text-sm font-medium">Control total sobre la visibilidad, seguridad y distribución.</p>
            </div>
            
            <button 
                onClick={handleSaveChanges}
                disabled={isSaving || !isDirty}
                className={`hidden md:flex px-8 py-3.5 text-xs font-black rounded-xl transition-all items-center gap-3 uppercase tracking-[0.15em] ${
                isDirty ? 'bg-white text-black hover:scale-105 shadow-[0_0_30px_rgba(255,255,255,0.1)]' : 'bg-white/5 text-white/20 cursor-not-allowed border border-white/5'
                }`}
            >
                {isSaving ? <Loader2 size={16} className="animate-spin" /> : <Save size={16} />}
                {isSaving ? 'Guardando...' : 'Guardar Cambios'}
            </button>
        </div>
        
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 relative z-10">

            {/* COLUMNA IZQUIERDA (PRINCIPAL) */}
            <div className="lg:col-span-8 space-y-8">
                
                {/* 1. VISIBILIDAD */}
                <section className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2.5rem] p-8 relative overflow-hidden shadow-2xl">
                    <div className="flex items-center gap-4 mb-8">
                        <div className="p-3 bg-[#8A2BE2]/10 rounded-2xl text-[#8A2BE2] border border-[#8A2BE2]/20 shadow-[0_0_15px_rgba(138,43,226,0.2)]"><Globe size={24} /></div>
                        <div><h3 className="text-xl font-black text-white uppercase tracking-tight">Estado del Evento</h3><p className="text-white/40 text-xs font-medium tracking-wide">Controla la visibilidad pública.</p></div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Botón Público */}
                        <button 
                            onClick={() => { setIsLive(true); setIsDirty(true); }}
                            className={`relative p-6 rounded-[2rem] text-left transition-all group/btn overflow-hidden border ${
                                isLive 
                                ? 'bg-[#00D15B]/10 border-[#00D15B]/50 shadow-[0_0_20px_rgba(0,209,91,0.1)]' 
                                : 'bg-black/40 border-white/5 hover:border-white/20 hover:bg-white/5'
                            }`}
                        >
                            <div className="flex justify-between items-start mb-3">
                                <span className={`text-sm font-black uppercase tracking-wider ${isLive ? 'text-[#00D15B]' : 'text-white'}`}>Público (Live)</span>
                                {isLive && <CheckCircle2 size={18} className="text-[#00D15B]" />}
                            </div>
                            <p className="text-[10px] text-white/40 font-medium leading-relaxed">El evento es visible en la cartelera y se pueden comprar tickets.</p>
                        </button>

                        {/* Botón Borrador */}
                        <button 
                            onClick={() => { setIsLive(false); setIsDirty(true); }}
                            className={`relative p-6 rounded-[2rem] text-left transition-all group/btn overflow-hidden border ${
                                !isLive 
                                ? 'bg-white/10 border-white/30 shadow-[0_0_20px_rgba(255,255,255,0.05)]' 
                                : 'bg-black/40 border-white/5 hover:border-white/20 hover:bg-white/5'
                            }`}
                        >
                            <div className="flex justify-between items-start mb-3">
                                <span className={`text-sm font-black uppercase tracking-wider ${!isLive ? 'text-white' : 'text-white/60'}`}>Borrador (Draft)</span>
                                {!isLive && <CheckCircle2 size={18} className="text-white/60" />}
                            </div>
                            <p className="text-[10px] text-white/40 font-medium leading-relaxed">Oculto al público. Solo administradores pueden verlo.</p>
                        </button>
                    </div>
                </section>

                {/* 2. SEGURIDAD Y DISTRIBUCIÓN */}
                <section className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2.5rem] p-8 relative overflow-hidden shadow-2xl">
                    <div className="flex items-center gap-4 mb-8">
                        <div className="p-3 bg-[#3b82f6]/10 rounded-2xl text-[#3b82f6] border border-[#3b82f6]/20 shadow-[0_0_15px_rgba(59,130,246,0.2)]"><ShieldCheck size={24} /></div>
                        <div><h3 className="text-xl font-black text-white uppercase tracking-tight">Seguridad y Distribución</h3><p className="text-white/40 text-xs font-medium tracking-wide">Reglas de transferencia y compra.</p></div>
                    </div>

                    <div className="space-y-4">
                        <div className="flex items-center justify-between p-6 bg-black/40 rounded-[2rem] border border-white/5 hover:border-white/10 transition-colors">
                            <div className="flex items-center gap-5">
                                <div className="p-2.5 bg-white/5 rounded-xl text-white/60 border border-white/5"><RefreshCcw size={20} /></div>
                                <div>
                                    <p className="text-sm font-bold text-white uppercase tracking-wide">Transferencia de Tickets</p>
                                    <p className="text-[10px] text-white/40 font-medium mt-0.5">Permitir a usuarios enviar sus tickets a otros.</p>
                                </div>
                            </div>
                            <button 
                                onClick={() => { setIsTransferable(!isTransferable); setIsDirty(true); }}
                                className={`w-14 h-8 rounded-full transition-all relative shadow-inner ${isTransferable ? 'bg-[#3b82f6]' : 'bg-white/10'}`}
                            >
                                <div className={`absolute top-1 w-6 h-6 rounded-full bg-white transition-all shadow-md ${isTransferable ? 'left-7' : 'left-1'}`} />
                            </button>
                        </div>

                        <div className="flex items-center justify-between p-6 bg-black/40 rounded-[2rem] border border-white/5 hover:border-white/10 transition-colors">
                            <div className="flex items-center gap-5">
                                <div className="p-2.5 bg-white/5 rounded-xl text-white/60 border border-white/5"><Zap size={20} /></div>
                                <div>
                                    <p className="text-sm font-bold text-white uppercase tracking-wide">Reventa Oficial</p>
                                    <p className="text-[10px] text-white/40 font-medium mt-0.5">Habilitar marketplace secundario seguro.</p>
                                </div>
                            </div>
                            <button 
                                onClick={() => { setIsResellable(!isResellable); setIsDirty(true); }}
                                className={`w-14 h-8 rounded-full transition-all relative shadow-inner ${isResellable ? 'bg-[#8A2BE2]' : 'bg-white/10'}`}
                            >
                                <div className={`absolute top-1 w-6 h-6 rounded-full bg-white transition-all shadow-md ${isResellable ? 'left-7' : 'left-1'}`} />
                            </button>
                        </div>

                        <div className="p-6 bg-black/40 rounded-[2rem] border border-white/5 flex flex-col md:flex-row md:items-center justify-between gap-4 hover:border-white/10 transition-colors">
                            <div className="flex items-center gap-5">
                                <div className="p-2.5 bg-white/5 rounded-xl text-white/60 border border-white/5"><Users size={20} /></div>
                                <div>
                                    <p className="text-sm font-bold text-white uppercase tracking-wide">Límite por Persona</p>
                                    <p className="text-[10px] text-white/40 font-medium mt-0.5">Máximo de tickets en una sola compra.</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4 bg-black/60 border border-white/10 rounded-2xl px-2 py-2 shadow-inner">
                                <button onClick={() => { setMaxTickets(Math.max(1, maxTickets - 1)); setIsDirty(true); }} className="w-10 h-10 flex items-center justify-center bg-white/5 hover:bg-white/10 rounded-xl text-white transition-all font-bold text-lg border border-white/5">-</button>
                                <span className="text-white font-black font-mono w-8 text-center text-xl">{maxTickets}</span>
                                <button onClick={() => { setMaxTickets(maxTickets + 1); setIsDirty(true); }} className="w-10 h-10 flex items-center justify-center bg-white/5 hover:bg-white/10 rounded-xl text-white transition-all font-bold text-lg border border-white/5">+</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            {/* COLUMNA DERECHA (PELIGRO) */}
            <div className="lg:col-span-4 space-y-8">
                <section className="bg-[#FF007F]/5 border border-[#FF007F]/20 rounded-[2.5rem] p-8 relative overflow-hidden flex flex-col backdrop-blur-xl shadow-[0_0_40px_rgba(255,0,127,0.05)]">
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_right,rgba(255,0,127,0.1),transparent_70%)] pointer-events-none" />
                    
                    <div className="flex items-center gap-3 mb-6 text-[#FF007F] relative z-10">
                        <div className="p-2 bg-[#FF007F]/10 rounded-xl border border-[#FF007F]/20"><AlertTriangle size={20} /></div>
                        <h3 className="text-lg font-black uppercase tracking-wide">Zona de Peligro</h3>
                    </div>
                    
                    <p className="text-xs text-[#FF007F]/70 font-medium mb-8 leading-relaxed relative z-10 bg-[#FF007F]/5 p-4 rounded-2xl border border-[#FF007F]/10">
                        Las acciones en esta zona son irreversibles. Eliminar el evento borrará permanentemente todos los datos asociados, incluyendo tickets y registros de ventas.
                    </p>
                    
                    <div className="relative z-10">
                        <button 
                            onClick={() => setIsDeleteModalOpen(true)} 
                            className="w-full py-4 bg-[#FF007F]/10 hover:bg-[#FF007F] text-[#FF007F] hover:text-white border border-[#FF007F]/30 hover:border-[#FF007F] text-xs font-black rounded-2xl transition-all flex items-center justify-center gap-2 uppercase tracking-widest group shadow-[0_0_20px_rgba(255,0,127,0.1)] hover:shadow-[0_0_30px_rgba(255,0,127,0.4)]"
                        >
                            <Trash2 size={16} className="group-hover:scale-110 transition-transform"/> Eliminar Evento
                        </button>
                    </div>
                </section>
            </div>

        </div>

        {/* FOOTER MOVIL */}
        <div className="md:hidden fixed bottom-6 left-6 right-6 z-50">
            <button 
            onClick={handleSaveChanges}
            disabled={isSaving || !isDirty}
            className={`w-full py-4 text-xs font-black rounded-2xl transition-all flex items-center justify-center gap-3 shadow-2xl uppercase tracking-[0.15em] ${
                isDirty ? 'bg-white text-black' : 'bg-zinc-800 text-zinc-500'
            }`}
            >
            {isSaving ? 'Guardando...' : 'Guardar Cambios'}
            </button>
        </div>

        {/* TOASTS Y MODALES */}
        {showUnsavedWarning && (
            <div className="fixed top-10 left-1/2 -translate-x-1/2 z-[200] animate-in fade-in slide-in-from-top-5 duration-300">
            <div className="bg-[#0e0e11]/90 border border-[#eab308]/30 backdrop-blur-xl rounded-2xl px-6 py-4 flex items-center gap-4 shadow-[0_0_30px_rgba(245,158,11,0.2)]">
                <div className="p-2 bg-[#eab308]/20 rounded-full text-[#eab308]"><AlertCircle size={20} /></div>
                <div className="text-left"><p className="text-sm font-black text-[#eab308] leading-tight uppercase tracking-widest">Cambios sin guardar</p><p className="text-[10px] text-[#eab308]/60 font-bold uppercase">Sincroniza antes de salir</p></div>
            </div>
            </div>
        )}
        {showToast && (
            <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] animate-in slide-in-from-bottom-5 duration-300">
            <div className="bg-[#050505]/90 border border-[#00D15B]/30 backdrop-blur-xl rounded-2xl px-8 py-5 flex items-center gap-4 shadow-[0_0_50px_rgba(0,0,0,0.8)]">
                <div className="p-2 bg-[#00D15B]/20 rounded-full text-[#00D15B] shadow-[0_0_15px_rgba(34,197,94,0.3)]"><CheckCircle2 size={24} /></div>
                <div className="text-left"><p className="text-sm font-black text-white leading-tight uppercase tracking-widest">Éxito</p><p className="text-[10px] text-white/40 font-bold uppercase">Ajustes sincronizados</p></div>
            </div>
            </div>
        )}

        {/* MODAL ELIMINAR */}
        {isDeleteModalOpen && (
            <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 animate-in fade-in duration-300">
            <div className="absolute inset-0 bg-black/90 backdrop-blur-xl" onClick={() => setIsDeleteModalOpen(false)} />
            <div className="relative w-full max-w-xl bg-[#050505]/95 backdrop-blur-2xl border border-[#FF007F]/20 rounded-[3rem] p-12 shadow-[0_0_60px_rgba(255,0,127,0.15)] animate-in zoom-in-95 text-center">
                <div className="flex justify-center mb-8"><div className="p-6 bg-[#FF007F]/10 rounded-full text-[#FF007F] animate-pulse ring-1 ring-[#FF007F]/20 shadow-[0_0_30px_rgba(255,0,127,0.2)]"><AlertCircle size={56} /></div></div>
                <h3 className="text-3xl font-black text-white tracking-tighter leading-none mb-4 uppercase">¿Estás seguro?</h3>
                <p className="text-white/60 text-sm font-medium mb-10 leading-relaxed px-4">Esta acción eliminará <span className="text-white font-bold">permanentemente</span> el evento. Escribe <span className="text-[#FF007F] font-black tracking-widest uppercase">DELETE</span> para confirmar.</p>
                <div className="space-y-6">
                <input value={deleteInput} onChange={(e) => setDeleteInput(e.target.value)} placeholder="Escribe DELETE..." className="w-full bg-black/40 border border-white/10 rounded-2xl px-6 py-5 text-center text-sm font-black text-white focus:border-[#FF007F] outline-none shadow-inner transition-all tracking-[0.2em] placeholder:text-white/20" />
                <div className="flex gap-4">
                    <button onClick={() => { setIsDeleteModalOpen(false); setDeleteInput(''); }} className="flex-1 py-5 bg-white/5 text-white/40 font-bold rounded-2xl hover:text-white transition-all text-xs uppercase tracking-widest border border-white/5 hover:bg-white/10">Cancelar</button>
                    <button onClick={handleFinalDelete} disabled={deleteInput !== 'DELETE' || isDeleting} className="flex-[1.5] py-5 bg-[#FF007F] text-white font-black rounded-2xl disabled:opacity-20 disabled:grayscale hover:bg-[#FF007F]/90 transition-all shadow-[0_0_30px_rgba(255,0,127,0.4)] uppercase tracking-widest text-xs flex items-center justify-center gap-3">{isDeleting ? <Loader2 className="animate-spin" size={18} /> : <Trash2 size={18} />} Borrar Evento</button>
                </div>
                </div>
            </div>
            </div>
        )}
      
      </div>
  )
}
</file>

<file path="app/(dashboard)/events/[id]/staff/page.tsx">
'use client'
import { useEffect, useState, use, useCallback } from 'react'
import { supabase } from '@/lib/supabase'
import { 
  Loader2, Plus, Search, ShieldCheck, QrCode, BarChart3, 
  Trash2, Copy, RefreshCw, Power, Lock, X, Clock, Dices, 
  Lightbulb, Zap, AlertTriangle, TrendingUp
} from 'lucide-react'

// Interfaz Staff
interface StaffMember {
  id: string
  name: string
  role: string
  access_code: string
  is_active: boolean
  created_at: string
}

// Interfaz Métricas
interface StaffMetrics {
  [key: string]: {
      total_scans: number
      last_scan: string | null
      scans_per_minute: number
      insight_label: string
      insight_color: string
      insight_icon: any
  }
}

// Interfaz Insight Global
interface TeamStats {
  total_staff_scans: number
  avg_team_speed: number
  active_validators: number
  global_recommendation: string
  status_color: string
}

export default function StaffPage({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const eventId = resolvedParams.id

  const [loading, setLoading] = useState(true)
  const [staffList, setStaffList] = useState<StaffMember[]>([])
  const [metrics, setMetrics] = useState<StaffMetrics>({})
  const [teamStats, setTeamStats] = useState<TeamStats | null>(null)
  
  const [searchTerm, setSearchTerm] = useState('')
  const [isAddingValidator, setIsAddingValidator] = useState(false)
  const [newValidatorData, setNewValidatorData] = useState({ name: '', code: '' })

  // --- 1. FUNCIÓN DE CARGA Y ANÁLISIS DE DATOS ---
  const fetchStaffAndMetrics = useCallback(async (isSilent = false) => {
    try {
      if (!isSilent) setLoading(true)
      
      const { data: staffData, error } = await supabase
        .from('event_staff')
        .select('*')
        .eq('event_id', eventId)
        .order('created_at', { ascending: false })

      if (error) throw error
      
      setStaffList(currentList => {
          if (JSON.stringify(currentList) === JSON.stringify(staffData)) return currentList;
          return staffData || [];
      })

      if (staffData && staffData.length > 0) {
          const staffIds = staffData.map(s => s.id)
          const { data: scansData } = await supabase
            .from('scans')
            .select('staff_id, created_at')
            .in('staff_id', staffIds)
            .eq('event_id', eventId)

          const newMetrics: StaffMetrics = {}
          let totalTeamScans = 0
          let sumSpeeds = 0
          let activeSpeedCount = 0

          staffData.forEach(staff => {
              const staffScans = scansData?.filter(scan => scan.staff_id === staff.id) || []
              const total = staffScans.length
              totalTeamScans += total
              
              const last = staffScans.length > 0 
                ? staffScans.sort((a,b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())[0].created_at 
                : null
              
              const firstScan = staffScans.length > 0 
                ? staffScans.sort((a,b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())[0].created_at 
                : null
              
              let minutesActive = 1
              if (firstScan && last) {
                  const diffMs = new Date(last).getTime() - new Date(firstScan).getTime()
                  minutesActive = Math.max(1, diffMs / (1000 * 60))
              }

              const spm = total > 0 ? Math.round(total / minutesActive) : 0
              
              if (staff.is_active && total > 0) {
                  sumSpeeds += spm
                  activeSpeedCount++
              }

              // --- GENERAR INSIGHT INDIVIDUAL ---
              let label = "Esperando datos..."
              let color = "text-white/40"
              let icon = Clock

              if (total > 0) {
                  if (spm >= 6) {
                      label = "🔥 Máquina: ¡Rendimiento Top!"
                      color = "text-[#FF007F]"
                      icon = Zap
                  } else if (spm >= 3) {
                      label = "✅ Constante: Buen ritmo"
                      color = "text-[#00D15B]"
                      icon = TrendingUp
                  } else if (spm >= 1) {
                      label = "⚠️ Lento: Revisar conexión"
                      color = "text-[#eab308]"
                      icon = AlertTriangle
                  } else {
                      label = "💤 Detenido: Sin actividad reciente"
                      color = "text-white/40"
                      icon = Clock
                  }
              }

              newMetrics[staff.id] = {
                  total_scans: total,
                  last_scan: last,
                  scans_per_minute: spm,
                  insight_label: label,
                  insight_color: color,
                  insight_icon: icon
              }
          })
          setMetrics(newMetrics)

          // --- GENERAR INSIGHT GLOBAL ---
          const avgTeamSpeed = activeSpeedCount > 0 ? Math.round(sumSpeeds / activeSpeedCount) : 0
          let globalRec = "Esperando inicio del evento..."
          let statusColor = "bg-white/5 border-white/10"

          if (totalTeamScans > 0) {
              if (avgTeamSpeed >= 5) {
                  globalRec = "🚀 Flujo Excelente: El equipo está volando. No se requieren cambios."
                  statusColor = "bg-[#FF007F]/5 border-[#FF007F]/20 shadow-[0_0_30px_rgba(255,0,127,0.1)]"
              } else if (avgTeamSpeed >= 3) {
                  globalRec = "✅ Flujo Saludable: El ingreso es fluido. Mantener este ritmo."
                  statusColor = "bg-[#00D15B]/5 border-[#00D15B]/20 shadow-[0_0_30px_rgba(0,209,91,0.1)]"
              } else {
                  globalRec = "⚠️ Cuello de Botella: Flujo lento. Considera agregar más validadores o revisar problemas técnicos en puerta."
                  statusColor = "bg-[#eab308]/5 border-[#eab308]/20 shadow-[0_0_30px_rgba(234,179,8,0.1)]"
              }
          }

          setTeamStats({
              total_staff_scans: totalTeamScans,
              avg_team_speed: avgTeamSpeed,
              active_validators: staffData.filter(s => s.is_active).length,
              global_recommendation: globalRec,
              status_color: statusColor
          })

      } else {
          setMetrics({})
          setTeamStats(null)
      }

    } catch (error) {
      console.error('Error cargando staff:', error)
    } finally {
      if (!isSilent) setLoading(false)
    }
  }, [eventId])

  // --- 2. EFECTO REALTIME ---
  useEffect(() => {
    fetchStaffAndMetrics()

    const channel = supabase.channel(`staff_tracking:${eventId}`)
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'event_staff', filter: `event_id=eq.${eventId}` },
        () => fetchStaffAndMetrics(true) 
      )
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'scans', filter: `event_id=eq.${eventId}` },
        () => fetchStaffAndMetrics(true) 
      )
      .subscribe()

    return () => {
      supabase.removeChannel(channel)
    }
  }, [eventId, fetchStaffAndMetrics])

  // --- ACCIONES ---
  const generateRandomCode = () => {
    const randomCode = Math.floor(100000 + Math.random() * 900000).toString()
    setNewValidatorData(prev => ({ ...prev, code: randomCode }))
  }

  const handleAddValidator = async () => {
    if (!newValidatorData.name || !newValidatorData.code) return alert("Completa todos los campos")
    if (newValidatorData.code.length !== 6) return alert("El código debe tener 6 dígitos")

    try {
        const { error } = await supabase.from('event_staff').insert({
            event_id: eventId,
            name: newValidatorData.name,
            role: 'Validador', 
            access_code: newValidatorData.code,
            is_active: true
        })

        if (error) {
            if (error.code === '23505') throw new Error("Código en uso. Genera otro.")
            throw error
        }
        
        setIsAddingValidator(false)
        setNewValidatorData({ name: '', code: '' })
    } catch (err: any) {
        alert(err.message) 
    }
  }

  const handleDelete = async (id: string) => {
      if(!confirm("¿Estás seguro?")) return
      await supabase.from('event_staff').delete().eq('id', id)
  }

  const toggleStatus = async (id: string, currentStatus: boolean) => {
      const newStatus = !currentStatus;
      setStaffList(prev => prev.map(s => s.id === id ? { ...s, is_active: newStatus } : s))
      try {
        const { error } = await supabase.from('event_staff').update({ is_active: newStatus }).eq('id', id)
        if (error) throw error;
      } catch (error: any) {
          alert("Error al guardar: " + error.message)
          setStaffList(prev => prev.map(s => s.id === id ? { ...s, is_active: currentStatus } : s))
      }
  }

  const filteredList = staffList.filter(s => 
    s.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
    s.role.toLowerCase().includes(searchTerm.toLowerCase())
  )

  if (loading && staffList.length === 0) return (
    <div className="flex items-center justify-center h-full pt-40">
        <Loader2 className="animate-spin text-[#8A2BE2]" size={40} />
    </div>
  )

  return (
    // CONTENEDOR LIMPIO (Sin fondo, ya está en el Layout)
    <div className="relative z-10 max-w-[1600px] mx-auto space-y-8 animate-in fade-in pt-4">
        
        {/* HEADER */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 border-b border-white/5 pb-6">
            <div>
                <h2 className="text-3xl font-black text-white flex items-center gap-3 uppercase tracking-tighter">
                    <ShieldCheck className="text-[#8A2BE2]" size={32}/> Control de Accesos
                </h2>
                <p className="text-white/40 text-sm font-medium mt-1 ml-11">
                    Monitoreo inteligente de flujo y rendimiento de staff.
                    <span className="ml-2 inline-flex items-center gap-1 text-[10px] bg-[#00D15B]/10 text-[#00D15B] px-2 py-0.5 rounded-full border border-[#00D15B]/20 animate-pulse font-black tracking-wider">● LIVE</span>
                </p>
            </div>
            <button 
                onClick={() => setIsAddingValidator(true)}
                className="px-6 py-3 bg-white text-black font-black text-xs uppercase tracking-widest rounded-xl transition-all flex items-center gap-2 shadow-[0_0_20px_rgba(255,255,255,0.15)] hover:scale-105 active:scale-95"
            >
                <Plus size={16} strokeWidth={3} /> Nueva Puerta
            </button>
        </div>

        {/* --- INSIGHT GLOBAL --- */}
        {teamStats && (
            <div className={`p-8 rounded-[2.5rem] border backdrop-blur-xl animate-in zoom-in-95 duration-500 relative overflow-hidden ${teamStats.status_color}`}>
                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent opacity-50" />
                
                <div className="flex flex-col md:flex-row items-center justify-between gap-8 relative z-10">
                    <div className="flex items-center gap-6">
                        <div className="p-4 bg-white/10 rounded-full backdrop-blur-md shadow-lg border border-white/10">
                            <Lightbulb size={32} className="text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]" />
                        </div>
                        <div>
                            <h3 className="text-xl font-black text-white uppercase tracking-tight mb-1">Diagnóstico del Evento</h3>
                            <p className="text-white/80 text-sm font-medium max-w-xl leading-relaxed">
                                {teamStats.global_recommendation}
                            </p>
                        </div>
                    </div>
                    <div className="flex gap-8 text-center bg-black/30 p-5 rounded-3xl backdrop-blur-md border border-white/10 shadow-xl">
                        <div>
                            <p className="text-4xl font-black text-white tracking-tighter">{teamStats.avg_team_speed}</p>
                            <p className="text-[9px] font-bold text-white/40 uppercase tracking-widest mt-1">Scans/Min Promedio</p>
                        </div>
                        <div className="w-px bg-white/10" />
                        <div>
                            <p className="text-4xl font-black text-white tracking-tighter">{teamStats.active_validators}</p>
                            <p className="text-[9px] font-bold text-white/40 uppercase tracking-widest mt-1">Puertas Activas</p>
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* FORMULARIO */}
        {isAddingValidator && (
            <div className="p-8 bg-white/5 backdrop-blur-2xl border border-white/10 rounded-[2rem] grid grid-cols-1 md:grid-cols-3 gap-6 animate-in zoom-in-95 shadow-2xl relative overflow-hidden group">
                <div className="absolute top-0 right-0 w-64 h-64 bg-[#8A2BE2]/10 rounded-full blur-[80px] pointer-events-none" />
                
                <div className="space-y-3 relative z-10">
                    <label className="text-[10px] font-black text-white/40 uppercase tracking-[0.2em] ml-2">Nombre Puerta</label>
                    <input value={newValidatorData.name} onChange={e => setNewValidatorData({...newValidatorData, name: e.target.value})} placeholder="Ej: Acceso VIP" className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white focus:border-[#8A2BE2] outline-none font-bold placeholder:text-white/20 transition-all shadow-inner" />
                </div>
                
                <div className="space-y-3 relative z-10">
                    <label className="text-[10px] font-black text-white/40 uppercase tracking-[0.2em] ml-2">Código Acceso</label>
                    <div className="flex gap-3">
                        <input value={newValidatorData.code} onChange={e => { const val = e.target.value.replace(/\D/g, '').slice(0, 6); setNewValidatorData({...newValidatorData, code: val}) }} placeholder="Ej: 123456" className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white focus:border-[#8A2BE2] outline-none font-mono font-bold tracking-[0.2em] text-center placeholder:text-white/10 transition-all shadow-inner" />
                        <button onClick={generateRandomCode} className="p-4 bg-white/5 hover:bg-white/10 text-white/60 hover:text-white rounded-2xl border border-white/10 transition-all"><Dices size={20} /></button>
                    </div>
                </div>
                
                <div className="flex gap-3 items-end relative z-10">
                    <button onClick={handleAddValidator} className="flex-1 py-4 bg-gradient-to-r from-[#8A2BE2] to-[#FF007F] text-white font-black rounded-2xl text-xs hover:opacity-90 uppercase tracking-[0.2em] transition-all shadow-[0_0_30px_rgba(138,43,226,0.3)] hover:scale-[1.02] active:scale-95">Crear Acceso</button>
                    <button onClick={() => setIsAddingValidator(false)} className="p-4 text-white/40 hover:text-white bg-white/5 rounded-2xl transition-colors border border-white/5 hover:bg-white/10 hover:scale-110"><X size={20}/></button>
                </div>
            </div>
        )}

        <div className="bg-white/5 border border-white/10 rounded-2xl p-2 flex items-center gap-3 shadow-lg backdrop-blur-md w-full max-w-md mx-auto xl:mx-0">
            <Search size={20} className="text-white/30 ml-3" />
            <input type="text" placeholder="Buscar personal..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="bg-transparent border-none outline-none text-sm font-medium text-white flex-1 p-2 placeholder:text-white/20" />
        </div>

        {staffList.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-32 px-4 border-2 border-dashed border-white/10 rounded-[3rem] bg-white/5 text-center backdrop-blur-sm">
                <div className="bg-white/5 p-6 rounded-full mb-6 border border-white/5 shadow-xl"><ShieldCheck size={48} className="text-white/20" /></div>
                <h3 className="text-2xl font-black text-white mb-2 uppercase tracking-wide">Sin Personal Activo</h3>
                <p className="text-white/40 text-sm font-medium max-w-md">Crea tu primer acceso para comenzar a validar tickets.</p>
            </div>
        ) : (
            <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                {filteredList.map((member) => (
                    <StaffAnalyticsCard 
                        key={member.id} 
                        member={member} 
                        metrics={metrics[member.id] || { total_scans: 0, last_scan: null, scans_per_minute: 0, insight_label: 'Sin datos', insight_color: 'text-white/40', insight_icon: Clock }}
                        onDelete={() => handleDelete(member.id)} 
                        onToggle={() => toggleStatus(member.id, member.is_active)}
                    />
                ))}
            </div>
        )}
    </div>
  )
}

// TARJETAS MÁS COMPACTAS
function StaffAnalyticsCard({ member, metrics, onDelete, onToggle }: { member: StaffMember, metrics: StaffMetrics[string], onDelete: () => void, onToggle: () => void }) {
    const copyCode = () => { navigator.clipboard.writeText(member.access_code); alert("Código copiado") }
    const lastScanTime = metrics.last_scan ? new Date(metrics.last_scan).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '--:--'
    const InsightIcon = metrics.insight_icon || Clock

    return (
        <div className={`bg-white/5 backdrop-blur-xl border rounded-[2rem] p-6 transition-all duration-500 group relative overflow-hidden shadow-2xl ${member.is_active ? 'border-white/10 hover:border-white/20' : 'border-[#FF007F]/20 opacity-60 grayscale hover:grayscale-0'}`}>
            
            <div className="absolute top-0 right-0 w-64 h-64 bg-[#8A2BE2]/10 rounded-full blur-[80px] pointer-events-none transition-opacity opacity-0 group-hover:opacity-100" />

            <div className="flex justify-between items-start mb-6 relative z-10">
                <div className="flex items-center gap-4">
                    <div className="h-12 w-12 rounded-2xl bg-black/40 flex items-center justify-center border border-white/10 shadow-inner text-white font-black text-lg">
                        {member.name.substring(0,2).toUpperCase()}
                    </div>
                    <div>
                        <h3 className="text-xl font-black text-white tracking-tight">{member.name}</h3>
                        <div className="flex items-center gap-2 mt-1">
                            <span className="text-white/40 text-xs font-bold uppercase tracking-wider bg-white/5 px-2 py-0.5 rounded-lg border border-white/5">{member.role}</span>
                            <span className={`w-2 h-2 rounded-full shadow-[0_0_10px_currentColor] ${member.is_active ? 'bg-[#00D15B] text-[#00D15B]' : 'bg-[#FF007F] text-[#FF007F]'}`} />
                        </div>
                    </div>
                </div>
                
                <button onClick={copyCode} className="flex flex-col items-end group/code cursor-pointer">
                    <span className="text-[9px] font-black text-white/30 uppercase tracking-[0.2em] mb-1 group-hover/code:text-[#8A2BE2] transition-colors">Código</span>
                    <div className="flex items-center gap-2 bg-black/40 border border-white/10 px-3 py-1.5 rounded-xl group-hover/code:border-[#8A2BE2]/50 transition-all shadow-inner">
                        <Lock size={12} className="text-white/30 group-hover/code:text-[#8A2BE2]" />
                        <span className="text-white font-mono font-bold tracking-[0.2em] text-base">{member.access_code}</span>
                    </div>
                </button>
            </div>

            <div className="mb-6 p-3 rounded-2xl bg-black/20 border border-white/5 flex items-center gap-3 shadow-inner">
                <div className={`p-1.5 rounded-xl bg-white/5 border border-white/5 ${metrics.insight_color.replace('text-', 'text-')}`}>
                    <InsightIcon size={16} />
                </div>
                <span className={`text-xs font-black uppercase tracking-wide ${metrics.insight_color}`}>
                    {metrics.insight_label}
                </span>
            </div>

            <div className="grid grid-cols-3 gap-3 mb-6 relative z-10">
                <div className="bg-white/5 border border-white/5 rounded-2xl p-4 flex flex-col justify-between h-24 hover:bg-white/10 transition-colors group/stat">
                    <div className="text-white/20 group-hover/stat:text-white transition-colors"><QrCode size={18}/></div>
                    <div>
                        <span className="text-2xl font-black text-white tracking-tighter">{metrics.total_scans}</span>
                        <p className="text-[9px] font-bold text-white/30 uppercase tracking-[0.1em] mt-1">Total Scans</p>
                    </div>
                </div>
                <div className="bg-white/5 border border-white/5 rounded-2xl p-4 flex flex-col justify-between h-24 hover:bg-white/10 transition-colors group/stat">
                    <div className="text-white/20 group-hover/stat:text-white transition-colors"><Clock size={18}/></div>
                    <div>
                        <span className="text-2xl font-black text-white tracking-tighter">{lastScanTime}</span>
                        <p className="text-[9px] font-bold text-white/30 uppercase tracking-[0.1em] mt-1">Último Ingreso</p>
                    </div>
                </div>
                <div className="bg-white/5 border border-white/5 rounded-2xl p-4 flex flex-col justify-between h-24 hover:bg-white/10 transition-colors group/stat">
                    <div className="text-white/20 group-hover/stat:text-white transition-colors"><BarChart3 size={18}/></div>
                    <div>
                        <span className="text-2xl font-black text-white tracking-tighter">{metrics.scans_per_minute}</span>
                        <p className="text-[9px] font-bold text-white/30 uppercase tracking-[0.1em] mt-1">~ Scans / Min</p>
                    </div>
                </div>
            </div>

            <div className="flex items-center justify-between pt-4 border-t border-white/5 relative z-10">
                <button onClick={onToggle} className={`flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.2em] px-4 py-2.5 rounded-xl transition-all shadow-lg ${
                    member.is_active 
                    ? 'bg-black/40 text-white/40 hover:text-white border border-white/5 hover:bg-white/5' 
                    : 'bg-[#00D15B]/10 text-[#00D15B] border border-[#00D15B]/20 hover:bg-[#00D15B]/20 shadow-[0_0_15px_rgba(0,209,91,0.1)]'
                }`}>
                    {member.is_active ? <><Power size={12}/> Desactivar</> : <><RefreshCw size={12}/> Reactivar</>}
                </button>
                
                <button onClick={onDelete} className="p-2.5 text-white/20 hover:text-[#FF007F] hover:bg-[#FF007F]/10 rounded-xl transition-all border border-transparent hover:border-[#FF007F]/20">
                    <Trash2 size={18} />
                </button>
            </div>
        </div>
    )
}
</file>

<file path="app/(dashboard)/events/[id]/layout.tsx">
'use client'
import React, { useEffect, useState, use } from 'react'
import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { ArrowLeft, Settings, Users, BarChart3, Share2, Edit3, Loader2, Gift, IdCard } from 'lucide-react'
import { supabase } from '@/lib/supabase'

export default function EventLayout({ children, params }: { children: React.ReactNode, params: Promise<{ id: string }> }) {
  const pathname = usePathname()
  
  const resolvedParams = use(params)
  const eventId = resolvedParams.id

  const [event, setEvent] = useState<any>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function getEventTitle() {
      const { data } = await supabase
        .from('events')
        .select('title, club_name, date, status')
        .eq('id', eventId)
        .single()
      
      if (data) setEvent(data)
      setLoading(false)
    }
    getEventTitle()
  }, [eventId])

  if (loading) return (
    <div className="h-screen w-full flex items-center justify-center bg-black">
      <Loader2 className="animate-spin text-purple-500" />
    </div>
  )

  return (
    <div className="flex flex-col h-full space-y-6">
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-white/5 pb-6">
        <div className="flex items-center gap-4">
            <Link href="/events" className="p-2 hover:bg-white/10 rounded-xl transition-colors text-zinc-400 hover:text-white">
                <ArrowLeft size={20} />
            </Link>
            <div>
                <div className="flex items-center gap-2">
                    <h1 className="text-2xl font-bold text-white tracking-tight">{event?.title}</h1>
                    <span className="px-2 py-0.5 rounded bg-green-500/10 text-green-400 text-[10px] font-bold border border-green-500/20 uppercase">
                        {event?.status === 'active' ? 'En Venta' : event?.status}
                    </span>
                </div>
                <p className="text-zinc-400 text-xs mt-0.5 flex items-center gap-2">
                    ID: {eventId.slice(0,8)}... • {event?.club_name} • {event?.date}
                </p>
            </div>
        </div>

        <div className="flex gap-2">
            <button className="px-4 py-2 bg-zinc-900 border border-zinc-800 text-zinc-300 font-medium text-sm rounded-lg hover:text-white transition-all flex items-center gap-2">
                <Share2 size={16} /> Link Evento
            </button>
            <Link href={`/events/create?id=${eventId}`}>
                <button className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold text-sm rounded-lg transition-all flex items-center gap-2 shadow-lg shadow-purple-900/20">
                    <Edit3 size={16} /> Editar
                </button>
            </Link>
        </div>
      </div>

      <div className="flex gap-1 bg-zinc-900/50 p-1 rounded-xl w-fit border border-zinc-800 overflow-x-auto">
         <EventTab href={`/events/${eventId}`} active={pathname === `/events/${eventId}`} label="Dashboard" icon={<BarChart3 size={14} />} />
         <EventTab href={`/events/${eventId}/attendees`} active={pathname.includes('/attendees')} label="Asistentes" icon={<Users size={14} />} />
         <EventTab href={`/events/${eventId}/rrpp`} active={pathname.includes('/rrpp')} label="RRPP" icon={<Gift size={14} />} />
         
         {/* NUEVA SECCIÓN STAFF */}
         <EventTab href={`/events/${eventId}/staff`} active={pathname.includes('/staff')} label="Staff" icon={<IdCard size={14} />} />
         
         <EventTab href={`/events/${eventId}/settings`} active={pathname.includes('/settings')} label="Ajustes" icon={<Settings size={14} />} />
      </div>

      <div className="animate-in fade-in zoom-in-95 duration-300">
        {children}
      </div>
    </div>
  )
}

function EventTab({ href, active, label, icon }: any) {
    return (
        <Link href={href} className={`px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition-all whitespace-nowrap ${active ? 'bg-white text-black' : 'text-zinc-500 hover:text-zinc-300'}`}>
            {icon} {label}
        </Link>
    )
}
</file>

<file path="app/(dashboard)/events/[id]/page.tsx">
'use client'
import React, { useEffect, useState, use } from 'react'
import { Ticket, Users, Clock, TrendingUp, Loader2, BarChart3, PieChart } from 'lucide-react'
import { supabase } from '@/lib/supabase'

export default function EventDashboardPage({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const eventId = resolvedParams.id

  const [data, setData] = useState<any>(null)
  const [loading, setLoading] = useState(true)
  const [checkInCount, setCheckInCount] = useState(0)

  useEffect(() => {
    async function fetchStats() {
      // 1. Traemos evento y tipos de tickets
      const { data: eventRaw } = await supabase
        .from('events')
        .select('*, ticket_tiers(*)')
        .eq('id', eventId)
        .single()
      
      // 2. Traemos tickets VENDIDOS para contar los usados (validadaos)
      const { data: soldTickets } = await supabase
        .from('tickets')
        .select('used')
        .eq('event_id', eventId)

      if (eventRaw) {
        // Cálculo de acreditados
        const totalUsed = soldTickets?.filter((t: any) => t.used).length || 0
        setCheckInCount(totalUsed)

        const adaptedData = {
            ...eventRaw,
            status: eventRaw.status || 'draft',
            tickets: eventRaw.ticket_tiers ? eventRaw.ticket_tiers.map((t: any) => ({
                id: t.id,
                name: t.name,
                price: t.price,
                quantity: t.total_stock,      
                quantity_sold: t.sold_tickets, 
                color: 'purple' 
            })) : []
        }
        setData(adaptedData)
      }
      setLoading(false)
    }
    fetchStats()
  }, [eventId])

  if (loading) return (
    <div className="flex items-center justify-center h-full pt-40">
        <Loader2 className="animate-spin text-[#8A2BE2]" size={40} />
    </div>
  )

  const totalSold = data?.tickets?.reduce((acc: number, t: any) => acc + (t.quantity_sold || 0), 0) || 0
  const totalCapacity = data?.tickets?.reduce((acc: number, t: any) => acc + (t.quantity || 0), 0) || 0
  const totalRevenue = data?.tickets?.reduce((acc: number, t: any) => acc + (t.price * (t.quantity_sold || 0)), 0) || 0

  return (
    // CONTENEDOR LIMPIO (Sin fondo, ya está en el Layout)
    <div className="relative z-10 max-w-[1600px] mx-auto space-y-8 animate-in fade-in pt-4">
      
      {/* STATS GRID */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <StatCard 
              label="Tickets Vendidos" 
              value={totalSold} 
              subtext={`de ${totalCapacity} capacidad`} 
              icon={<Ticket size={20} />} 
              color="text-[#8A2BE2]" 
              bg="bg-[#8A2BE2]/10" 
              border="border-[#8A2BE2]/20"
          />
          <StatCard 
              label="Recaudación" 
              value={`$${totalRevenue.toLocaleString('es-CL')}`} 
              subtext="Ingreso bruto total" 
              icon={<TrendingUp size={20} />} 
              color="text-[#00D15B]" 
              bg="bg-[#00D15B]/10" 
              border="border-[#00D15B]/20"
          />
          <StatCard 
              label="Acreditados" 
              value={checkInCount} 
              subtext="Check-in en tiempo real" 
              icon={<Users size={20} />} 
              color="text-[#3b82f6]" 
              bg="bg-[#3b82f6]/10" 
              border="border-[#3b82f6]/20"
          />
          <StatCard 
              label="Estado Actual" 
              value={data?.status?.toUpperCase() || 'DRAFT'} 
              subtext="Status del evento" 
              icon={<Clock size={20} />} 
              color="text-[#eab308]" 
              bg="bg-[#eab308]/10" 
              border="border-[#eab308]/20"
          />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* RENDIMIENTO */}
          <div className="lg:col-span-2 bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 shadow-2xl shadow-purple-900/10 flex flex-col h-full min-h-[320px]">
              <div className="flex justify-between items-start mb-6">
                  <h3 className="text-sm font-bold text-white flex items-center gap-3 uppercase tracking-widest">
                      <BarChart3 size={16} className="text-[#8A2BE2]"/> Rendimiento
                  </h3>
              </div>
              
              <div className="flex-1 rounded-2xl bg-black/40 border border-white/5 flex flex-col items-center justify-center relative overflow-hidden group">
                  <div className="absolute inset-0 bg-[linear-gradient(45deg,transparent_25%,rgba(255,255,255,0.02)_50%,transparent_75%)] bg-[length:20px_20px]" />
                  <div className="absolute bottom-0 left-0 right-0 h-1/2 bg-gradient-to-t from-[#8A2BE2]/10 to-transparent opacity-50" />
                  
                  <BarChart3 size={48} className="text-white/10 mb-4 group-hover:scale-110 transition-transform duration-500" />
                  <p className="text-zinc-500 text-xs font-medium uppercase tracking-wider text-center px-6">
                      El gráfico se activará al recibir<br/>las primeras ventas reales
                  </p>
              </div>
          </div>

          {/* VENTAS POR TIPO */}
          <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 shadow-2xl shadow-purple-900/10 flex flex-col">
              <h3 className="text-sm font-bold text-white flex items-center gap-3 uppercase tracking-widest mb-8">
                  <PieChart size={16} className="text-[#FF007F]"/> Ventas por Tipo
              </h3>
              
              <div className="space-y-6 overflow-y-auto pr-2 custom-scrollbar">
                  {data?.tickets?.map((t: any, i: number) => (
                      <TicketProgress 
                          key={t.id} 
                          name={t.name} 
                          sold={t.quantity_sold || 0} 
                          total={t.quantity} 
                          color={i % 2 === 0 ? 'from-[#8A2BE2] to-[#6366f1]' : 'from-[#FF007F] to-[#ec4899]'} 
                      />
                  ))}
                  {(!data?.tickets || data.tickets.length === 0) && (
                      <div className="text-center py-10 text-white/20 text-xs">
                          No hay tipos de tickets configurados.
                      </div>
                  )}
              </div>
          </div>
      </div>
    </div>
  )
}

// --- SUB-COMPONENTES ESTILIZADOS ---

function StatCard({ label, value, subtext, icon, color, bg, border }: any) {
  return (
      <div className="bg-white/5 backdrop-blur-xl border border-white/10 p-6 rounded-[2rem] hover:border-white/20 transition-all hover:scale-[1.02] group shadow-lg">
          <div className="flex justify-between items-start">
              <div>
                  <p className="text-white/40 text-[10px] font-bold uppercase tracking-[0.2em] mb-2">{label}</p>
                  <h4 className="text-3xl font-black text-white tracking-tight">{value}</h4>
                  <p className="text-white/30 text-[10px] mt-2 font-medium bg-black/20 w-fit px-2 py-1 rounded-lg">{subtext}</p>
              </div>
              <div className={`p-3.5 rounded-2xl ${bg} ${border} border ${color} shadow-[0_0_15px_rgba(0,0,0,0.2)]`}>
                  {icon}
              </div>
          </div>
      </div>
  )
}

function TicketProgress({ name, sold, total, color }: any) {
  const percent = total > 0 ? Math.min((sold / total) * 100, 100) : 0
  return (
      <div className="group">
          <div className="flex justify-between text-xs mb-2 font-bold uppercase tracking-wide">
              <span className="text-white group-hover:text-[#FF007F] transition-colors">{name}</span>
              <span className="text-white/40 font-mono">{sold} <span className="text-white/20">/ {total}</span></span>
          </div>
          <div className="h-2.5 w-full bg-black/40 rounded-full overflow-hidden border border-white/5">
              <div 
                  className={`h-full rounded-full bg-gradient-to-r ${color} transition-all duration-1000 shadow-[0_0_10px_currentColor] opacity-90`} 
                  style={{ width: `${percent}%` }} 
              />
          </div>
      </div>
  )
}
</file>

<file path="app/(dashboard)/events/create/page.tsx">
'use client'
import React, { useState, useEffect } from 'react'
import LivePreview from '@/components/hud/LivePreview'

// Imports de Paneles
import GeneralPanel from '@/components/hud/GeneralPanel'
import TicketPanel from '@/components/hud/TicketPanel'
import DesignPanel from '@/components/hud/DesignPanel'
import SettingsPanel from '@/components/hud/SettingsPanel'
import ExperiencePanel from '@/components/hud/ExperiencePanel' 

import { Ticket, Sparkles, LayoutDashboard, Palette, Settings, Loader2, AlignLeft } from 'lucide-react'
import { useEventStore } from '@/store/useEventStore'
import { supabase } from '@/lib/supabase'
import { useRouter, useSearchParams } from 'next/navigation'

// --- GENERADOR DE ID SEGURO ---
function safeUUID() {
  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
    return crypto.randomUUID();
  }
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// --- FUNCIÓN DE GEOLOCALIZACIÓN (LIMPIA) ---
async function getCoordinates(address: string) {
  try {
    const queryAddress = address.toLowerCase().includes('chile') ? address : `${address}, Chile`;
    const query = encodeURIComponent(queryAddress);
    
    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`, {
        headers: {
            'User-Agent': 'DyzGO-AdminPanel' 
        }
    });
    
    const data = await response.json();
    
    if (data && data.length > 0) {
        return {
            lat: parseFloat(data[0].lat),
            lon: parseFloat(data[0].lon)
        };
    }
    return null;
  } catch (error) {
    console.warn("No se pudieron obtener coordenadas automáticas:", error);
    return null;
  }
}

export default function CreateEventPage() {
  const { activeSection, setActiveSection, eventData } = useEventStore()
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  const searchParams = useSearchParams()
  const eventId = searchParams.get('id')

  // --- LÓGICA DE CARGA ---
  useEffect(() => {
    if (eventId) {
      const loadEventData = async () => {
        const { data: event, error } = await supabase
          .from('events')
          .select('*, ticket_tiers(*)')
          .eq('id', eventId)
          .single()

        if (event && !error) {
          useEventStore.setState((state) => ({
            ...state,
            eventData: {
              ...state.eventData,
              id: event.id,
              name: event.title || '',
              venue: event.club_name || '',
              address: event.location || '',
              date: event.date || '',
              startTime: event.hour || '', 
              endTime: event.end_time || '',
              // Aseguramos cargar también la fecha de fin si existe
              endDate: event.end_date || '', // <--- CORRECCIÓN AQUÍ TAMBIÉN PARA CARGAR EL DATO
              description: event.description || '',
              coverImage: event.image_url,
              themeColor: event.theme_color || '#8A2BE2',
              category: event.category || '',
              dressCode: event.dress_code || '',
              minAgeMen: event.min_age_men || 0,
              minAgeWomen: event.min_age_women || 0,
              prohibitedItems: event.prohibited_items || [],
              socialLinks: { instagram: event.instagram_url || '' },
              
              tickets: event.ticket_tiers ? event.ticket_tiers.map((t: any) => ({
                id: t.id,
                name: t.name,
                price: t.price,
                quantity: t.total_stock,
                sold: t.sold_tickets || 0, 
                description: t.description,
                isActive: t.is_active,
                isNominative: t.nominative,
                isGhostSoldOut: t.fake_sold,
                startDate: t.sales_start_at ? new Date(t.sales_start_at).toISOString().slice(0, 16) : '',
                endDate: t.sales_end_at ? new Date(t.sales_end_at).toISOString().slice(0, 16) : '',
                color: 'purple', 
                dependencyId: '' 
              })) : [],

              settings: {
                isPrivate: false,
                absorbFee: false,
                showRemaining: true,
                allowMarketplace: true,
                allowOverprice: false,
                showInstagram: !!event.instagram_url
              }
            }
          }))
        }
      }
      loadEventData()
    }
  }, [eventId])

  // --- LÓGICA DE PUBLICACIÓN ---
  const handlePublish = async () => {
    if (!eventData.name?.trim()) return alert("Error: El nombre del evento es obligatorio.")
    if (!eventData.date || !eventData.startTime) return alert("Error: Fecha y hora son obligatorias.")
    if (!eventData.venue?.trim()) return alert("Error: El lugar es obligatorio.")
    if (eventData.tickets.length === 0) return alert("Error: Crea al menos un ticket.")
    
    for (const t of eventData.tickets) {
        // @ts-ignore
        const soldCount = t.sold || 0;
        if (t.quantity < soldCount) {
            alert(`Error: El stock del ticket "${t.name}" (${t.quantity}) no puede ser menor a la cantidad ya vendida (${soldCount}).`);
            return;
        }
    }

    setLoading(true)
    try {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        alert("Debes estar logueado")
        return
      }

      let finalImageUrl = eventData.coverImage
      // @ts-ignore
      const fileToUpload = useEventStore.getState().tempFile 

      if (fileToUpload) {
        const fileExt = fileToUpload.name.split('.').pop()
        const fileName = `${user.id}/${Math.random()}.${fileExt}`
        const { error: uploadError } = await supabase.storage
          .from('flyers')
          .upload(fileName, fileToUpload)
        
        if (uploadError) throw uploadError
        const { data: { publicUrl } } = supabase.storage.from('flyers').getPublicUrl(fileName)
        finalImageUrl = publicUrl
      }

      let lat = null;
      let lon = null;
      
      if (eventData.address) {
          const coords = await getCoordinates(eventData.address);
          if (coords) {
              lat = coords.lat;
              lon = coords.lon;
          }
      }

      // 2. Guardar Evento
      const eventPayload = {
        organizer_id: user.id,
        title: eventData.name,
        location: eventData.address,
        latitude: lat, 
        longitude: lon, 
        club_name: eventData.venue,
        date: eventData.date,
        // --- CORRECCIÓN CLAVE: Usar la fecha de fin del estado ---
        end_date: eventData.endDate || eventData.date, // Si no hay fecha fin, usa la de inicio
        // --------------------------------------------------------
        hour: eventData.startTime,
        end_time: eventData.endTime,
        image_url: finalImageUrl,
        description: eventData.description,
        music_genre: eventData.musicGenre,
        dress_code: eventData.dressCode,
        min_age_men: Number(eventData.minAgeMen),
        min_age_women: Number(eventData.minAgeWomen),
        prohibited_items: eventData.prohibitedItems,
        instagram_url: eventData.socialLinks.instagram,
        category: eventData.category,
        theme_color: eventData.themeColor,
        is_active: true
      }

      let currentEventId = eventId

      if (eventId) {
        const { error } = await supabase.from('events').update(eventPayload).eq('id', eventId)
        if (error) throw error
      } else {
        const { data: event, error: eventError } = await supabase.from('events').insert([eventPayload]).select().single()
        if (eventError) throw eventError
        currentEventId = event.id
      }

      if (currentEventId) {
          try {
            const { data: existingTiers } = await supabase
                .from('ticket_tiers')
                .select('id')
                .eq('event_id', currentEventId)

            if (existingTiers) {
                const uiIds = eventData.tickets.map(t => t.id).filter(id => id && id.length > 20) 
                const idsToDelete = existingTiers.map(t => t.id).filter(dbId => !uiIds.includes(dbId))

                if (idsToDelete.length > 0) {
                    await supabase.from('ticket_tiers').delete().in('id', idsToDelete)
                }
            }
          } catch (delErr) { console.warn(delErr) }
      }

      if (eventData.tickets.length > 0) {
        const ticketsToSave = eventData.tickets.map(t => {
            const startHourStr = t.startDate ? new Date(t.startDate).toTimeString().slice(0, 5) : null
            const endHourStr = t.endDate ? new Date(t.endDate).toTimeString().slice(0, 5) : null

            return {
                id: (t.id && t.id.length > 20) ? t.id : safeUUID(),
                event_id: currentEventId,
                name: t.name,
                price: t.price,
                total_stock: t.quantity,
                description: t.description,
                sales_end_at: t.endDate || null,
                is_active: t.isActive,
                nominative: t.isNominative,
                fake_sold: t.isGhostSoldOut,
                sales_start_at: t.startDate || null,
                hour_start: startHourStr,
                end_hour: endHourStr,
            }
        })

        const { error: ticketError } = await supabase.from('ticket_tiers').upsert(ticketsToSave)
        if (ticketError) throw ticketError
      }

      alert(eventId ? "¡Evento actualizado exitosamente!" : "¡Evento publicado exitosamente!")
      router.push('/events')

    } catch (error: any) {
      console.error(error)
      alert("Error al guardar: " + error.message)
    } finally {
      setLoading(false)
    }
  }

  const renderActivePanel = () => {
    switch (activeSection) {
        case 'info': return <GeneralPanel />
        case 'experience': return <ExperiencePanel />
        case 'tickets': return <TicketPanel />
        case 'design': return <DesignPanel />
        case 'settings': return <SettingsPanel />
        default: return <GeneralPanel />
    }
  }

  return (
    <div className="flex h-screen w-full bg-[#09090b] text-white overflow-hidden font-sans">
      <aside className="w-[450px] border-r border-white/5 flex flex-col z-20 bg-[#09090b] shadow-2xl">
        <div className="h-16 border-b border-white/5 flex items-center px-6 gap-3 shrink-0">
            <div className="h-8 w-8 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-500/20">
                <Sparkles size={16} className="text-white" />
            </div>
            <span className="font-bold tracking-tight text-lg">
                {eventId ? 'Editando Evento' : 'DyzGO Creator'}
            </span>
        </div>

        <div className="flex flex-1 overflow-hidden">
             <div className="w-20 border-r border-white/5 flex flex-col items-center py-6 gap-6 bg-zinc-950/50">
                <NavButton active={activeSection === 'info'} onClick={() => setActiveSection('info')} icon={<LayoutDashboard size={24} />} label="Info" />
                <NavButton active={activeSection === 'experience'} onClick={() => setActiveSection('experience')} icon={<AlignLeft size={24} />} label="Experiencia" />
                <NavButton active={activeSection === 'tickets'} onClick={() => setActiveSection('tickets')} icon={<Ticket size={24} />} label="Tickets" />
                <NavButton active={activeSection === 'design'} onClick={() => setActiveSection('design')} icon={<Palette size={24} />} label="Diseño" />
                <div className="h-px w-8 bg-white/10 my-2" />
                <NavButton active={activeSection === 'settings'} onClick={() => setActiveSection('settings')} icon={<Settings size={24} />} label="Ajustes" />
             </div>
             <div className="flex-1 overflow-y-auto p-8 scrollbar-hide bg-[#09090b]">
                {renderActivePanel()}
             </div>
        </div>

        <div className="p-4 border-t border-white/5 bg-zinc-950/30">
            <button 
              onClick={handlePublish}
              disabled={loading}
              className="w-full py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold hover:brightness-110 transition-all shadow-lg shadow-green-900/20 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                {loading ? <Loader2 className="animate-spin" size={18} /> : <Sparkles size={18} />}
                {loading ? "Guardando..." : (eventId ? "Guardar Cambios" : "Publicar Evento")}
            </button>
        </div>
      </aside>

      <main className="flex-1 relative flex items-center justify-center bg-black">
        <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-zinc-900/50 via-[#050505] to-black"></div>
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#80808008_1px,transparent_1px),linear-gradient(to_bottom,#80808008_1px,transparent_1px)] bg-[size:32px_32px]"></div>
        <div className="z-10 animate-in zoom-in-95 duration-500"><LivePreview /></div>
      </main>
    </div>
  )
}

function NavButton({ active, onClick, icon, label }: any) {
    return (
        <button onClick={onClick} className={`group flex flex-col items-center gap-1 transition-all duration-300 ${active ? 'scale-105' : 'opacity-50 hover:opacity-100'}`}>
            <div className={`p-3 rounded-2xl transition-all duration-300 ${active ? 'bg-zinc-800 text-white shadow-[0_0_20px_rgba(255,255,255,0.1)]' : 'text-zinc-400 group-hover:bg-zinc-900'}`}>{icon}</div>
            <span className={`text-[10px] font-medium transition-colors ${active ? 'text-white' : 'text-zinc-500'}`}>{label}</span>
        </button>
    )
}
</file>

<file path="app/(dashboard)/events/page.tsx">
'use client'
import { useEffect, useState } from 'react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import { Search, Plus, Calendar, MapPin, Users, Loader2 } from 'lucide-react'
import { supabase } from '@/lib/supabase'
import { useEventStore } from '@/store/useEventStore'
import { useOrg } from '@/components/providers/org-provider'

export default function EventsPage() {
  const router = useRouter()
  const { resetEvent } = useEventStore() 
  const { currentOrgId, currentRole } = useOrg()
  const [events, setEvents] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [activeTab, setActiveTab] = useState('Todos')

  const canCreate = currentRole === 'owner' || currentRole === 'admin'

  useEffect(() => {
    async function fetchEvents() {
      if (!currentOrgId) return

      setLoading(true)
      
      const { data, error } = await supabase
        .from('events')
        .select('*, ticket_tiers(total_stock, sold_tickets)')
        .eq('experience_id', currentOrgId)
        .order('created_at', { ascending: false })

      if (data) {
        const now = new Date()

        const adaptedEvents = data.map((e: any) => {
            let currentStatus = e.status || 'draft'
            
            // --- LÓGICA DE CADUCIDAD (AUTO-FINALIZAR) ---
            // Solo verificamos si no está ya marcado como 'ended'
            if (currentStatus !== 'ended') {
                // Prioridad: end_date > date
                const targetDateStr = e.end_date || e.date
                
                if (targetDateStr) {
                    // Hora por defecto: fin del día si no hay hora específica
                    const timePart = e.end_time || '23:59:59'
                    
                    // Construimos la fecha de término exacta
                    // Nota: Asegúrate que el formato de fecha sea compatible (YYYY-MM-DD)
                    const eventEndDateTime = new Date(`${targetDateStr}T${timePart}`)
                    
                    // Si la fecha de término es válida y YA PASÓ
                    if (!isNaN(eventEndDateTime.getTime()) && eventEndDateTime < now) {
                        currentStatus = 'ended'
                        
                        // Actualizamos silenciosamente en Supabase para que persista
                        // Solo si en la BD no estaba ya como 'ended' para no saturar requests
                        if (e.status !== 'ended') {
                            supabase.from('events').update({ status: 'ended' }).eq('id', e.id).then(() => {
                                console.log(`Evento ${e.id} finalizado por caducidad temporal.`)
                            })
                        }
                    }
                }
            }
            // ------------------------------

            return {
                id: e.id,
                created_at: e.created_at,
                name: e.title,
                venue: e.club_name,
                date: e.date,
                end_time: e.end_time,
                cover_image: e.image_url,
                status: currentStatus, 
                tickets: e.ticket_tiers?.map((t: any) => ({
                    quantity: t.total_stock,
                    quantity_sold: t.sold_tickets
                })) || []
            }
        })
        setEvents(adaptedEvents)
      }
      if (error) console.error("Error fetching events:", error)
      
      setLoading(false)
    }
    fetchEvents()
  }, [currentOrgId])

  const handleCreateEvent = () => {
    resetEvent() 
    router.push('/events/create')
  }

  const filteredEvents = events.filter(event => {
    const matchesSearch = event.name?.toLowerCase().includes(searchTerm.toLowerCase())
    if (!matchesSearch) return false
    
    if (activeTab === 'Todos') return true
    if (activeTab === 'Finalizados') return event.status === 'ended'
    if (activeTab === 'Activos') return event.status === 'active'
    if (activeTab === 'Borradores') return event.status === 'draft'

    return true
  })

  if (loading) return (
    <div className="flex items-center justify-center h-full pt-40">
        <Loader2 className="animate-spin text-[#8A2BE2]" size={40} />
    </div>
  )

  return (
    // CONTENEDOR LIMPIO (Sin fondo, ya está en el Layout)
    <div className="max-w-[1600px] mx-auto space-y-8 animate-in fade-in pt-0">
        
        {/* HEADER */}
        <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-white/5 pb-6">
            <div>
                <h1 className="text-4xl md:text-5xl font-black text-white tracking-tighter mb-1">
                    Mis <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#8A2BE2] to-[#FF007F]">Eventos</span>
                </h1>
                <p className="text-white/40 text-sm font-medium">Gestiona, edita y monitorea tus fiestas.</p>
            </div>
            
            <div className="flex flex-wrap items-center gap-3">
                <div className="relative group">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-white/60 pointer-events-none z-20" size={18} />
                    <input 
                        type="text" 
                        placeholder="Buscar evento..." 
                        value={searchTerm} 
                        onChange={(e) => setSearchTerm(e.target.value)} 
                        className="h-12 pl-12 pr-6 bg-white/5 hover:bg-white/10 backdrop-blur-md border border-white/10 rounded-2xl text-sm text-white focus:outline-none focus:border-[#8A2BE2]/50 transition-all w-64 shadow-lg shadow-purple-900/5 placeholder:text-white/20 relative z-10" 
                    />
                </div>
                {canCreate && (
                    <button 
                        onClick={handleCreateEvent} 
                        className="h-12 px-6 bg-white text-black font-bold rounded-2xl hover:scale-105 active:scale-95 transition-all flex items-center gap-2 shadow-[0_0_20px_rgba(255,255,255,0.15)] uppercase text-xs tracking-wider"
                    >
                        <Plus size={18} /> Crear
                    </button>
                )}
            </div>
        </div>

        {/* TABS */}
        <div className="flex gap-2 p-1 bg-white/5 backdrop-blur-md border border-white/10 w-fit rounded-2xl">
            {['Todos', 'Activos', 'Borradores', 'Finalizados'].map((tab) => (
                <button 
                    key={tab} 
                    onClick={() => setActiveTab(tab)} 
                    className={`px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all duration-300 ${
                        activeTab === tab 
                        ? 'bg-white text-black shadow-lg' 
                        : 'text-white/40 hover:text-white hover:bg-white/5'
                    }`}
                >
                    {tab}
                </button>
            ))}
        </div>

        {/* GRID */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-8">
            {filteredEvents.map((event) => (
                <EventCard 
                    key={event.id} 
                    id={event.id} 
                    title={event.name} 
                    date={event.date || 'Fecha por definir'} 
                    location={event.venue || 'Ubicación por definir'} 
                    image={event.cover_image || "https://images.unsplash.com/photo-1540039155733-5bb30b53aa14?q=80&w=1000&auto=format&fit=crop"} 
                    status={event.status} 
                    sold={event.tickets?.reduce((acc: number, t: any) => acc + (t.quantity_sold || 0), 0) || 0} 
                    total={event.tickets?.reduce((acc: number, t: any) => acc + (t.quantity || 0), 0) || 0} 
                    canEdit={canCreate} 
                />
            ))}
        </div>
      </div>
  )
}

function EventCard({ id, title, date, location, image, status, sold, total, canEdit }: any) {
    const percentage = total > 0 ? Math.round((sold / total) * 100) : 0
    const formattedDate = date && date !== 'Fecha por definir' ? date.split('-').reverse().join('-') : date

    const statusConfig: any = { 
        active: { style: 'bg-black/80 border-[#00D15B] text-[#00D15B] shadow-[0_0_20px_rgba(0,209,91,0.3)]', dot: 'bg-[#00D15B]', text: 'A LA VENTA' }, 
        draft: { style: 'bg-black/80 border-white/30 text-white/60', dot: 'bg-white/40', text: 'BORRADOR' }, 
        ended: { style: 'bg-black/80 border-[#8A2BE2] text-[#8A2BE2]', dot: 'bg-[#8A2BE2]', text: 'FINALIZADO' } 
    }
    
    const currentStatus = statusConfig[status] || statusConfig['draft']

    return (
        <div className="group bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] overflow-hidden hover:border-white/20 transition-all hover:scale-[1.01] shadow-xl shadow-purple-900/5 flex flex-col h-full">
            <div className="h-40 w-full relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-t from-[#030005] via-transparent to-transparent z-10 opacity-90" />
                <img src={image} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" alt={title} />
                <div className={`absolute top-4 right-4 px-3 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest border flex items-center gap-2 backdrop-blur-md z-20 transition-all ${currentStatus.style}`}>
                    <div className={`w-1.5 h-1.5 rounded-full ${currentStatus.dot} ${status === 'active' ? 'animate-pulse' : ''}`} />
                    {currentStatus.text}
                </div>
            </div>
            <div className="p-6 flex flex-col flex-1 relative z-20">
                <div className="flex justify-between items-start mb-4">
                    <div className="flex-1 pr-4">
                        <h3 className="text-xl font-black text-white mb-2 leading-none group-hover:text-[#FF007F] transition-colors line-clamp-1">{title}</h3>
                        <div className="flex flex-col gap-1.5 text-xs text-white/50 font-medium mt-2">
                            <span className="flex items-center gap-2"><Calendar size={12} className="text-[#8A2BE2]" /> {formattedDate}</span>
                            <span className="flex items-center gap-2"><MapPin size={12} className="text-[#8A2BE2]" /> {location}</span>
                        </div>
                    </div>
                </div>
                <div className="bg-white/5 rounded-xl p-4 border border-white/5 mb-6">
                    <div className="flex justify-between text-[10px] uppercase font-bold tracking-wider mb-2">
                        <span className="text-white/40 flex items-center gap-1.5"><Users size={12} /> Vendidos</span>
                        <span className="text-white">{sold} <span className="text-white/30">/ {total}</span></span>
                    </div>
                    <div className="h-1.5 w-full bg-black/40 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-[#8A2BE2] to-[#FF007F] rounded-full transition-all duration-1000" style={{ width: `${percentage}%` }} />
                    </div>
                </div>
                <div className="mt-auto grid grid-cols-2 gap-3">
                    <Link href={`/events/${id}`} className="w-full">
                        <button className="w-full py-3 rounded-xl bg-white text-black text-xs font-bold uppercase tracking-wider hover:scale-[1.02] active:scale-[0.98] transition-all shadow-[0_0_20px_rgba(255,255,255,0.15)]">Dashboard</button>
                    </Link>
                    {canEdit ? (
                        <Link href={`/events/create?id=${id}`} className="w-full">
                            <button className="w-full py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-xs font-bold text-white uppercase tracking-wider transition-colors hover:border-white/30">Editar</button>
                        </Link>
                    ) : (
                        <button disabled className="w-full py-3 rounded-xl border border-white/5 text-xs font-bold text-white/20 uppercase tracking-wider cursor-not-allowed">Solo Lectura</button>
                    )}
                </div>
            </div>
        </div>
    )
}
</file>

<file path="app/(dashboard)/finance/page.tsx">
'use client'
import { useEffect, useState, useCallback } from 'react'
import { 
  DollarSign, Ticket, Activity, 
  TrendingUp, PieChart as PieIcon,
  Filter, CheckCircle2, QrCode, Users,
  Target, Clock, Repeat, FileDown,
  Info, RefreshCw, AlertTriangle, Lightbulb,
  HelpCircle, ChevronRight, UserCheck, Sparkles
} from 'lucide-react'
import { supabase } from '@/lib/supabase'
import { useOrg } from '@/components/providers/org-provider'
import { 
  AreaChart, Area, XAxis, YAxis, CartesianGrid, 
  Tooltip, ResponsiveContainer, PieChart, Pie, Cell,
  BarChart, Bar
} from 'recharts'
import { subHours, subDays, subYears, format, eachHourOfInterval, eachDayOfInterval } from 'date-fns'

// Paleta Neón Ajustada para Liquid Glass
const COLORS = { 
  primary: '#8b5cf6', secondary: '#06b6d4', accent: '#ec4899', 
  success: '#10b981', warning: '#eab308', error: '#ef4444',
  male: '#3b82f6', female: '#ec4899', other: '#a855f7'
}
const PIE_COLORS = [COLORS.primary, COLORS.secondary, COLORS.accent, COLORS.success, COLORS.warning]

export default function AnalyticsPage() {
  const { currentOrgId } = useOrg()
  const [loading, setLoading] = useState(true)
  const [events, setEvents] = useState<any[]>([])
  
  // Filtros
  const [selectedEventId, setSelectedEventId] = useState<string>('all')
  const [timeRange, setTimeRange] = useState<'24h' | '7d' | '30d' | '1y' | 'all'>('30d')
  const [refreshTrigger, setRefreshTrigger] = useState(0) 

  // --- ESTADO MAESTRO ---
  const [metrics, setMetrics] = useState({
    totalRevenue: 0,
    revenueGoal: 0,
    avgTicketPrice: 0,
    totalViews: 0,
    conversionRate: 0,
    recurringRate: 0,
    ticketsSold: 0,
    ticketsAvailable: 0,
    totalStock: 0,
    ticketsScanned: 0,
    attendanceRate: 0,
    salesByTier: [] as any[],
    stockVsSold: [] as any[],
    entryTimeData: [] as any[],
    attendanceByTier: [] as any[], 
    uniqueUsersCount: 0,
    uniqueUsersGraph: [] as any[],
    uniqueUsersList: [] as any[],
    genderStats: [] as any[],
    ageStats: [] as any[]
  })

  const [rawTickets, setRawTickets] = useState<any[]>([])

  // 1. CARGA DE DATOS
  const fetchData = useCallback(async () => {
    if (!currentOrgId) return
    if (loading && refreshTrigger === 0) setLoading(true)
    
    try {
      // 1. Traer Eventos SOLO de la Org actual
      const { data: eventsList } = await supabase
        .from('events')
        .select('id, title, views, date')
        .eq('experience_id', currentOrgId)
      
      if (eventsList) setEvents(eventsList)

      const targetEventIds = selectedEventId === 'all' 
          ? (eventsList?.map(e => e.id) || [])
          : [selectedEventId]

      // --- CORRECCIÓN DE SEGURIDAD ---
      // Si no hay eventos en esta Org (o el array está vacío), detenemos aquí.
      // Esto evita que la query de tickets corra sin filtro 'in()' y traiga datos ajenos.
      if (targetEventIds.length === 0) {
        processAllMetrics([], eventsList || [], timeRange, [])
        setRawTickets([])
        setLoading(false)
        return
      }
      // ------------------------------

      const { data: allTiers } = await supabase
          .from('ticket_tiers')
          .select('id, name, price, total_stock, event_id')
          .in('event_id', targetEventIds)

      let query = supabase
        .from('tickets')
        .select(`
            id, paid_price, status, created_at, scanned_at,
            tier_id, user_id, guest_email, guest_name,
            profiles:user_id ( full_name, email, gender, birth_date, rut ), 
            ticket_tiers ( id, name, price, total_stock ),
            events ( id, date, title )
        `)
        .neq('status', 'refunded')
        .order('created_at', { ascending: true })
      
      // Aquí ya es seguro usar targetEventIds porque validamos arriba que no esté vacío
      if (targetEventIds.length > 0) {
        query = query.in('event_id', targetEventIds)
      }

      if (timeRange !== 'all') {
        const now = new Date()
        let dateLimit = new Date()
        switch (timeRange) {
            case '24h': dateLimit = subHours(now, 24); break;
            case '7d': dateLimit = subDays(now, 7); break;
            case '30d': dateLimit = subDays(now, 30); break;
            case '1y': dateLimit = subYears(now, 1); break;
        }
        query = query.gte('created_at', dateLimit.toISOString())
      }

      const { data: tickets } = await query

      if (tickets) {
        processAllMetrics(tickets, eventsList || [], timeRange, allTiers || [])
        setRawTickets(tickets)
      }
    } catch (err) {
      console.error("Error fetch:", err)
    } finally {
      setLoading(false)
    }
  }, [currentOrgId, selectedEventId, timeRange])

  useEffect(() => { fetchData() }, [fetchData, refreshTrigger])

  useEffect(() => {
    if (!currentOrgId) return
    const channel = supabase.channel('finance_realtime_v7')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, () => {
              setTimeout(() => setRefreshTrigger(prev => prev + 1), 1500) 
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'scans' }, () => {
              setTimeout(() => setRefreshTrigger(prev => prev + 1), 1000)
      })
      .subscribe()
    return () => { supabase.removeChannel(channel) }
  }, [currentOrgId])

  // 4. PROCESAMIENTO
  const processAllMetrics = (tickets: any[], eventList: any[], range: string, allTiers: any[]) => {
    let revenue = 0
    let scanned = 0
    let sold = tickets.length
    
    const tierMap = new Map<string, any>()
    
    // Inicializar mapa con datos base
    allTiers.forEach(tier => {
        tierMap.set(tier.id, { 
            id: tier.id, 
            name: tier.name, 
            sold: 0, 
            revenue: 0, 
            stock: tier.total_stock, 
            scanned: 0, 
            staticPrice: Number(tier.price) // Aseguramos que sea número
        })
    })

    const hourlyScans = new Map<string, number>()
    const dateMap = new Map<string, number>() 
    const usersMap = new Map<string, any>()
    const userGrowthMap = new Map<string, number>()
    
    let maleCount = 0
    let femaleCount = 0
    let otherCount = 0
    const ageBuckets = { '18-24': 0, '25-34': 0, '35-44': 0, '45+': 0 }
    
    let cumulativeUsers = 0
    let recurringUsers = 0

    const targetEvents = selectedEventId === 'all' 
        ? eventList 
        : eventList.filter(e => e.id === selectedEventId)
    const totalViews = targetEvents.reduce((acc, e) => acc + (e.views || 0), 0)

    tickets.forEach(t => {
        const tId = t.tier_id
        const mappedTier = tierMap.get(tId)

        // --- LÓGICA ROBUSTA DE PRECIO ---
        let finalPrice = Number(t.paid_price)

        // Si el precio pagado es 0 o inválido, forzamos el precio del tier
        if (!finalPrice || finalPrice === 0) {
            // Intentamos obtenerlo del join
            finalPrice = Number(t.ticket_tiers?.price)
            // Si el join falla (es 0 o null), usamos el mapa de respaldo
            if ((!finalPrice || finalPrice === 0) && mappedTier) {
                finalPrice = mappedTier.staticPrice
            }
        }
        
        // Acumular Revenue Total
        revenue += finalPrice

        const tDate = new Date(t.created_at)
        let dateKey = ''
        if (range === '24h') dateKey = format(tDate, 'HH:00')
        else dateKey = format(tDate, 'dd/MM')
        
        dateMap.set(dateKey, (dateMap.get(dateKey) || 0) + finalPrice)

        if (t.scanned_at) {
            scanned++
            const hour = new Date(t.scanned_at).getHours()
            const timeKey = `${hour}:00`
            hourlyScans.set(timeKey, (hourlyScans.get(timeKey) || 0) + 1)
        }

        // Actualizar estadísticas por Tier en el mapa
        if (tId && tierMap.has(tId)) {
            const tierStat = tierMap.get(tId)
            tierStat.sold++
            tierStat.revenue += finalPrice // Usamos el precio corregido
            if (t.scanned_at) tierStat.scanned++
        } else if (tId) {
            // Caso borde: Tier no encontrado en allTiers pero presente en ticket
            const tName = t.ticket_tiers?.name || 'Desconocido'
            const tStock = t.ticket_tiers?.total_stock || 0
            tierMap.set(tId, { id: tId, name: tName, sold: 1, revenue: finalPrice, stock: tStock, scanned: t.scanned_at ? 1 : 0, staticPrice: finalPrice })
        }

        // Usuarios y Demografía
        const uniqueKey = t.user_id || t.guest_email || t.id
        const userName = t.profiles?.full_name || t.guest_name || 'Anónimo'
        const userEmail = t.profiles?.email || t.guest_email || 'Sin Email'
        const userRut = t.profiles?.rut || 'Sin RUT'

        if (!usersMap.has(uniqueKey)) {
            cumulativeUsers++
            usersMap.set(uniqueKey, { name: userName, email: userEmail, rut: userRut, totalSpent: 0, ticketsCount: 0, lastDate: t.created_at })
            userGrowthMap.set(dateKey, cumulativeUsers)
        } else {
            const u = usersMap.get(uniqueKey)
            // SI EL USUARIO REPITE COMPRA: Incrementamos recurrentes si es su segunda entrada detectada
            if (u.ticketsCount === 1) {
              recurringUsers++ 
            }
            if (!userGrowthMap.has(dateKey)) userGrowthMap.set(dateKey, cumulativeUsers)
            else userGrowthMap.set(dateKey, cumulativeUsers)
        }
        const user = usersMap.get(uniqueKey)
        user.totalSpent += finalPrice
        user.ticketsCount += 1
        if (new Date(t.created_at) > new Date(user.lastDate)) user.lastDate = t.created_at

        if (t.profiles) {
             if (t.profiles.gender === 'Masculino') maleCount++
             else if (t.profiles.gender === 'Femenino') femaleCount++
             else otherCount++

             if (t.profiles.birth_date) {
                 const birth = new Date(t.profiles.birth_date)
                 const today = new Date()
                 let age = today.getFullYear() - birth.getFullYear()
                 const m = today.getMonth() - birth.getMonth()
                 if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                     age--
                 }
                 if (age >= 18 && age <= 24) ageBuckets['18-24']++
                 else if (age >= 25 && age <= 34) ageBuckets['25-34']++
                 else if (age >= 35 && age <= 44) ageBuckets['35-44']++
                 else if (age >= 45) ageBuckets['45+']++
             }
        }
    })

    const now = new Date()
    let intervals: Date[] = []
    let formatKey = ''

    if (range === '24h') {
        intervals = eachHourOfInterval({ start: subHours(now, 24), end: now })
        formatKey = 'HH:00'
    } else {
        const days = range === '7d' ? 7 : range === '30d' ? 30 : range === '1y' ? 365 : 30
        intervals = eachDayOfInterval({ start: subDays(now, days), end: now })
        formatKey = 'dd/MM'
    }

    let lastAccumulated = 0
    const uniqueUsersGraph = intervals.map(date => {
        const key = format(date, formatKey)
        const val = userGrowthMap.get(key)
        if (val !== undefined) lastAccumulated = val
        return { date: key, count: lastAccumulated }
    })

    const tiersArray = Array.from(tierMap.values())
    const salesByTier = tiersArray.map(t => ({
        name: t.name, value: t.sold, revenue: t.revenue
    })).sort((a,b) => b.value - a.value)

    const totalStock = tiersArray.reduce((acc, t) => acc + t.stock, 0)
    const stockVsSold = [{ name: 'Vendidos', value: sold }, { name: 'Disponibles', value: Math.max(0, totalStock - sold) }]

    const entryTimeData = Array.from({length: 24}, (_, i) => {
        const key = `${i}:00`
        return { time: key, count: hourlyScans.get(key) || 0 }
    })

    const attendanceByTier = tiersArray.map(t => ({
        name: t.name, scanned: t.scanned, unscanned: Math.max(0, t.sold - t.scanned), rate: t.sold > 0 ? (t.scanned/t.sold)*100 : 0
    }))

    const potentialRev = tiersArray.reduce((acc, t) => acc + (t.stock * t.staticPrice), 0)

    const finalGenderStats = [
        { name: 'Mujeres', value: femaleCount, color: COLORS.female },
        { name: 'Hombres', value: maleCount, color: COLORS.male },
        { name: 'Otros', value: otherCount, color: COLORS.other },
    ].filter(g => g.value > 0)

    const finalAgeStats = [
        { range: '18-24', count: ageBuckets['18-24'] },
        { range: '25-34', count: ageBuckets['25-34'] },
        { range: '35-44', count: ageBuckets['35-44'] },
        { range: '45+', count: ageBuckets['45+'] },
    ]

    setMetrics({
        totalRevenue: revenue,
        revenueGoal: potentialRev > 0 ? potentialRev : revenue * 1.5,
        avgTicketPrice: sold > 0 ? revenue / sold : 0,
        totalViews,
        conversionRate: totalViews > 0 ? (sold / totalViews) * 100 : 0,
        recurringRate: usersMap.size > 0 ? (recurringUsers / usersMap.size) * 100 : 0,
        ticketsSold: sold,
        ticketsAvailable: Math.max(0, totalStock - sold),
        totalStock,
        ticketsScanned: scanned,
        attendanceRate: sold > 0 ? (scanned / sold) * 100 : 0,
        salesByTier,
        stockVsSold,
        entryTimeData,
        attendanceByTier,
        uniqueUsersCount: usersMap.size,
        uniqueUsersGraph,
        uniqueUsersList: Array.from(usersMap.values()).sort((a, b) => b.totalSpent - a.totalSpent),
        genderStats: finalGenderStats,
        ageStats: finalAgeStats
    })
  }

  // --- CORRECCIÓN EXPORTAR BASE DE DATOS CLIENTES ---
  const handleDownloadUsers = () => {
    const headers = 'Nombre,Correo,RUT,Total gastado,Tickets totales,Fecha de última compra'
    const rows = metrics.uniqueUsersList.map(u => {
      const fecha = format(new Date(u.lastDate), 'dd/MM/yyyy HH:mm')
      return `"${u.name}","${u.email}","${u.rut}",${u.totalSpent},${u.ticketsCount},"${fecha}"`
    })
    
    const csv = [headers, ...rows].join('\n')
    downloadCSV(csv, 'base_datos_clientes')
  }

  const handleExportAll = () => {
    const headers = 'ID,Precio,Fecha,Estado,Tipo de ticket,Nombre del evento,Email,RUT'
    const rows = rawTickets.map(t => {
      const id = t.id
      const precio = t.ticket_tiers?.price || 0
      const fecha = format(new Date(t.created_at), 'dd/MM/yyyy HH:mm')
      const estado = t.status
      const tipoTicket = t.ticket_tiers?.name || 'General'
      const nombreEvento = t.events?.title || 'Evento'
      const email = t.profiles?.email || t.guest_email || 'Sin Email'
      const rut = t.profiles?.rut || 'Sin RUT'
      
      return `"${id}",${precio},"${fecha}","${estado}","${tipoTicket}","${nombreEvento}","${email}","${rut}"`
    })

    const csv = [headers, ...rows].join('\n')
    downloadCSV(csv, 'transacciones_completa')
  }

  const downloadCSV = (content: string, prefix: string) => {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' })
    const url = window.URL.createObjectURL(blob)
    const a = document.createElement('a'); a.href = url; a.download = `${prefix}_${new Date().toISOString()}.csv`; a.click()
  }

  return (
    // CONTENEDOR LIMPIO - SIN FONDO (YA ESTÁ EN EL LAYOUT)
    <div className="max-w-[1600px] mx-auto space-y-12 animate-in fade-in pt-2">
      
        {/* HEADER */}
        <div className="flex flex-col xl:flex-row xl:items-center justify-between gap-6 border-b border-white/5 pb-6">
            <div>
                <h1 className="text-4xl md:text-5xl font-black text-white tracking-tighter mb-2">
                    Analíticas
                </h1>
                <p className="text-white/40 text-sm flex items-center gap-2 font-medium">
                    Acá podrás ver el resumen de tus analíticas y el rendimiento de tus eventos.
                </p>
            </div>

            <div className="flex flex-wrap xl:flex-nowrap items-center gap-3 bg-white/5 backdrop-blur-md p-2 rounded-2xl border border-white/10 shadow-lg shadow-purple-900/10">
                <div className="relative">
                    <select value={selectedEventId} onChange={(e) => setSelectedEventId(e.target.value)} className="bg-black/40 text-white text-xs font-bold px-4 py-2.5 pr-10 rounded-xl outline-none border border-white/10 cursor-pointer min-w-[220px] h-10 appearance-none hover:bg-black/60 transition-colors focus:border-[#8A2BE2]/50">
                        <option value="all">Todos los Eventos</option>
                        {events.map(e => <option key={e.id} value={e.id}>{e.title}</option>)}
                    </select>
                    <Filter className="absolute right-3.5 top-3 text-white/40 pointer-events-none" size={14} />
                </div>
                <div className="flex bg-black/40 rounded-xl p-1 border border-white/10 h-10 items-center">
                    {['24h', '7d', '30d', '1y', 'all'].map((range) => (
                        <button key={range} onClick={() => setTimeRange(range as any)} className={`px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all ${timeRange === range ? 'bg-white/10 text-white shadow-sm border border-white/5' : 'text-white/40 hover:text-white hover:bg-white/5'}`}>
                            {range === 'all' ? 'TODO' : range.toUpperCase()}
                        </button>
                    ))}
                </div>
                <button onClick={() => setRefreshTrigger(prev => prev + 1)} className="p-2.5 bg-black/40 hover:bg-white/10 border border-white/10 text-white/60 hover:text-white rounded-xl transition-all h-10 w-10 flex items-center justify-center" title="Recargar"><RefreshCw size={16} className={loading ? 'animate-spin' : ''}/></button>
                <button onClick={handleExportAll} className="flex items-center gap-2 px-5 bg-gradient-to-r from-[#8A2BE2] to-[#FF007F] hover:opacity-90 text-white rounded-xl shadow-lg text-xs font-bold transition-all h-10 uppercase tracking-wider"><FileDown size={16} /> Exportar</button>
            </div>
        </div>

        {/* KPIs */}
        <section className="space-y-6">
            <SectionHeader 
                title="Resumen Ejecutivo" 
                subtitle="KPIs" 
                description="Visión general de indicadores calculados sobre ventas brutas y comportamiento de compra."
            />
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <KpiCard title="Ingresos Totales" value={`$${metrics.totalRevenue.toLocaleString('es-CL')}`} sub={`Meta: $${metrics.revenueGoal.toLocaleString()}`} icon={<Target size={20}/>} progress={(metrics.totalRevenue / (metrics.revenueGoal || 1)) * 100} color="text-[#00D15B]" bg="bg-[#00D15B]/10" tooltip="Suma total de tickets pagados." />
                <KpiCard title="Ticket Promedio" value={`$${metrics.avgTicketPrice.toFixed(0)}`} sub="Ingreso medio" icon={<DollarSign size={20}/>} color="text-[#06b6d4]" bg="bg-[#06b6d4]/10" tooltip="Ingreso Total / Cantidad de Transacciones." />
                <KpiCard title="Tasa Conversión" value={`${metrics.conversionRate.toFixed(2)}%`} sub="Visitas vs Compras" icon={<Activity size={20}/>} color="text-[#FF007F]" bg="bg-[#FF007F]/10" tooltip="Porcentaje de visualizaciones que terminan en venta." />
                <KpiCard title="Fidelización" value={`${metrics.recurringRate.toFixed(1)}%`} sub="Clientes Recurrentes" icon={<Repeat size={20}/>} color="text-[#eab308]" bg="bg-[#eab308]/10" tooltip="Porcentaje de usuarios con más de una compra histórica." />
            </div>
            {/* NUEVO INSIGHT PARA KPIs */}
            <div className="w-full">
                <InsightBox 
                    type="info"
                    text="Tip Financiero: Si tu tasa de conversión es baja pero tienes muchas visitas, revisa si el precio es muy alto o si el proceso de compra es confuso. Si la fidelización es alta, crea un programa de recompensas."
                />
            </div>
        </section>

        {/* VENTAS */}
        <section className="space-y-6">
            <SectionHeader 
                title="Rendimiento Comercial" 
                subtitle="Ventas" 
                description="Cálculo de ocupación (Tickets Vendidos / Stock Total) y desglose de ingresos por tipo de ticket."
            />
            
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* Ocupación */}
                <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 flex flex-col justify-between shadow-2xl shadow-purple-900/10 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-[#8A2BE2]/20 rounded-full blur-[60px] pointer-events-none"/>
                    <div>
                        <h3 className="text-sm font-bold text-white flex items-center gap-3 mb-2 uppercase tracking-widest"><Ticket size={16} className="text-[#8A2BE2]"/> Ocupación</h3>
                    </div>
                    
                    <div className="h-[280px] w-full relative">
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie data={metrics.stockVsSold} cx="50%" cy="50%" innerRadius={80} outerRadius={110} paddingAngle={5} dataKey="value" stroke="none">
                                    <Cell fill="#8A2BE2" /><Cell fill="rgba(255,255,255,0.05)" />
                                </Pie>
                                <Tooltip contentStyle={{backgroundColor: '#000000cc', border: '1px solid #ffffff20', borderRadius: '12px', backdropFilter: 'blur(10px)'}} itemStyle={{color: '#fff'}}/>
                            </PieChart>
                        </ResponsiveContainer>
                        <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span className="text-[10px] text-white/40 font-bold uppercase tracking-widest">Vendido</span>
                            <span className="text-5xl font-black text-white mt-1">{((metrics.ticketsSold / (metrics.totalStock || 1)) * 100).toFixed(0)}%</span>
                        </div>
                    </div>

                    <InsightBox 
                        type={metrics.ticketsSold / (metrics.totalStock || 1) > 0.8 ? 'positive' : 'neutral'}
                        text={metrics.ticketsSold / (metrics.totalStock || 1) > 0.8 
                            ? "¡Excelente ocupación! Estás cerca del Sold Out. Considera liberar reservas." 
                            : "Aún tienes mucho inventario disponible. Intensifica la promoción en redes."
                        }
                    />
                </div>
                
                {/* Mix de Ventas */}
                <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 flex flex-col shadow-2xl shadow-purple-900/10">
                    <div>
                        <h3 className="text-sm font-bold text-white flex items-center gap-3 mb-2 uppercase tracking-widest"><PieIcon size={16} className="text-[#06b6d4]"/> Mix de Ventas</h3>
                    </div>

                    <div className="flex flex-col xl:flex-row gap-8 h-full items-center justify-center mt-4 mb-6">
                        <div className="w-full xl:w-1/2 h-[260px]">
                          <ResponsiveContainer width="100%" height="100%">
                              <PieChart>
                                  <Pie data={metrics.salesByTier} cx="50%" cy="50%" outerRadius={110} innerRadius={70} dataKey="revenue" stroke="none" paddingAngle={2}>
                                      {metrics.salesByTier.map((e, i) => <Cell key={i} fill={PIE_COLORS[i % PIE_COLORS.length]} />)}
                                  </Pie>
                                  <Tooltip formatter={(value: number) => `$${value.toLocaleString()}`} contentStyle={{backgroundColor: '#000000cc', border: '1px solid #ffffff20', borderRadius: '12px', backdropFilter: 'blur(10px)'}} itemStyle={{color:'#fff'}}/>
                              </PieChart>
                          </ResponsiveContainer>
                        </div>

                        <div className="w-full xl:w-1/2 flex flex-col justify-center space-y-3">
                            {metrics.salesByTier.slice(0, 5).map((t, i) => (
                                <div key={i} className="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition-all cursor-default">
                                    <div className="flex items-center gap-3">
                                        <div className="w-2 h-2 rounded-full shadow-[0_0_10px_currentColor]" style={{color: PIE_COLORS[i % PIE_COLORS.length], backgroundColor: PIE_COLORS[i % PIE_COLORS.length]}}/>
                                        <div>
                                            <span className="text-xs font-bold text-white block">{t.name}</span>
                                            <span className="text-[10px] text-white/40">{t.value} tix</span>
                                        </div>
                                    </div>
                                    <span className="text-xs font-mono font-bold text-white/80">${t.revenue.toLocaleString()}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="mt-auto">
                        <InsightBox 
                            type="info"
                            text="Analiza tu 'Best Seller'. Si un ticket barato se agota rápido y genera poco revenue, considera ajustar su precio o stock."
                        />
                    </div>
                </div>
            </div>
        </section>

        {/* ACCESOS */}
        <section className="space-y-6">
            <SectionHeader 
                title="Operativa" 
                subtitle="Accesos" 
                description="Datos de validación de tickets (QR Scans). Muestra el flujo de entrada por hora y la tasa de asistencia real."
            />

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* Asistencia */}
                <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 shadow-2xl shadow-purple-900/10 flex flex-col justify-between">
                    <div>
                        <div className="flex justify-between items-start mb-6">
                            <h3 className="text-sm font-bold text-white flex items-center gap-3 uppercase tracking-widest"><QrCode size={16} className="text-[#eab308]"/> Asistencia</h3>
                            <div className="bg-[#eab308]/10 px-3 py-1 rounded-lg border border-[#eab308]/20 text-[9px] text-[#eab308] font-bold uppercase tracking-wider animate-pulse">En Vivo</div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 items-center">
                            <div className="h-[220px]">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={[{name: 'Asistieron', value: metrics.ticketsScanned}, {name: 'No Asistieron', value: Math.max(0, metrics.ticketsSold - metrics.ticketsScanned)}]} cx="50%" cy="50%" innerRadius={70} outerRadius={100} startAngle={90} endAngle={-270} dataKey="value" stroke="none">
                                            <Cell fill="#eab308" /><Cell fill="rgba(255,255,255,0.05)" />
                                        </Pie>
                                        <Tooltip contentStyle={{backgroundColor: '#000000cc', border: '1px solid #ffffff20', borderRadius: '12px', backdropFilter: 'blur(10px)'}} itemStyle={{color: '#fff'}}/>
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="text-center">
                                <span className="text-6xl font-black text-white tracking-tighter block drop-shadow-lg">{metrics.attendanceRate.toFixed(0)}%</span>
                                <span className="text-[10px] text-white/40 font-bold uppercase mt-2 block tracking-widest">Tasa Global</span>
                            </div>
                        </div>
                    </div>

                    <div className="mt-6">
                        <InsightBox 
                            type={metrics.attendanceRate < 70 ? 'negative' : 'positive'}
                            text={metrics.attendanceRate < 70 
                                ? "Atención: Tasa de asistencia baja. Verifica posibles problemas en el acceso o clima." 
                                : "¡Buena convocatoria! Tus usuarios valoran el ticket y asisten al evento."
                            }
                        />
                    </div>
                </div>

                {/* Curva de Ingreso */}
                <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 flex flex-col justify-between shadow-2xl shadow-purple-900/10">
                    <div>
                        <h3 className="text-sm font-bold text-white flex items-center gap-3 mb-6 uppercase tracking-widest"><Clock size={16} className="text-[#3b82f6]"/> Curva de Ingreso</h3>
                    </div>
                    
                    <div className="flex-1 min-h-[250px]">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={metrics.entryTimeData}>
                                <defs>
                                    <linearGradient id="colorEntry" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.5}/>
                                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false}/>
                                <XAxis dataKey="time" stroke="#ffffff40" fontSize={10} axisLine={false} tickLine={false} minTickGap={30} />
                                <Tooltip contentStyle={{backgroundColor: '#000000cc', border: '1px solid #ffffff20', borderRadius: '12px'}} itemStyle={{color:'#fff'}}/>
                                <Area type="monotone" dataKey="count" stroke="#3b82f6" fill="url(#colorEntry)" strokeWidth={3}/>
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>

                    {/* NUEVO INSIGHT PARA CURVA DE INGRESO */}
                    <div className="mt-6">
                        <InsightBox 
                            type="info"
                            text="Usa la hora pico para gestionar tu personal. Refuerza la seguridad 1 hora antes del pico máximo previsto."
                        />
                    </div>
                </div>
            </div>
        </section>

        {/* AUDIENCIA */}
        <section className="space-y-6">
            <SectionHeader 
                title="Audiencia" 
                subtitle="Demografía" 
                description="Análisis del perfil del comprador basado en datos de registro (Edad, Género) y crecimiento de la base de datos."
            />

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                {/* Base de Usuarios */}
                <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 flex flex-col justify-between shadow-2xl shadow-purple-900/10">
                    <div>
                        <div className="flex justify-between items-start mb-6">
                            <h3 className="text-sm font-bold text-white flex items-center gap-3 uppercase tracking-widest"><Users size={16} className="text-[#3b82f6]"/> Usuarios unicos</h3>
                            <button onClick={handleDownloadUsers} className="p-2 bg-white/5 hover:bg-white/10 text-white/60 hover:text-white rounded-lg transition-colors border border-white/5">
                                <FileDown size={16}/>
                            </button>
                        </div>
                        
                        <div className="h-[250px] w-full -ml-2">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={metrics.uniqueUsersGraph}>
                                    <defs>
                                        <linearGradient id="userGradient" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.6}/>
                                            <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <XAxis dataKey="date" axisLine={false} tickLine={false} tick={{ fill: '#ffffff40', fontSize: 10 }} minTickGap={30}/>
                                    <Tooltip contentStyle={{ backgroundColor: '#000000cc', border: '1px solid #ffffff20', borderRadius: '12px' }} itemStyle={{ color: '#fff' }} cursor={{ stroke: '#ffffff20', strokeWidth: 1 }}/>
                                    <Area type="monotone" dataKey="count" stroke="#3b82f6" strokeWidth={3} fill="url(#userGradient)" />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                        
                        <div className="mt-6 mb-6">
                            <span className="text-[10px] text-white/40 font-bold uppercase tracking-widest block">Total Clientes</span>
                            <span className="text-5xl font-black text-white mt-2">{metrics.uniqueUsersCount}</span>
                        </div>
                    </div>

                    {/* NUEVO INSIGHT PARA CRECIMIENTO */}
                    <div className="mt-auto">
                        <InsightBox 
                            type="info"
                            text="Si la curva se aplana, activa campañas de 'Referidos' o promociones para nuevos usuarios para reactivar el crecimiento."
                        />
                    </div>
                </div>

                {/* Demografía */}
                <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 shadow-2xl shadow-purple-900/10 flex flex-col justify-between">
                    <div>
                        <div>
                            <h3 className="text-sm font-bold text-white flex items-center gap-3 mb-8 uppercase tracking-widest"><UserCheck size={16} className="text-[#a855f7]"/> Perfil Demográfico</h3>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-12 h-full pb-6">
                            {/* Género */}
                            <div className="flex flex-col items-center">
                                <h4 className="text-[10px] font-bold text-white/40 uppercase tracking-[0.2em] mb-6 w-full text-center border-b border-white/5 pb-2">Género</h4>
                                <div className="h-[200px] w-full relative">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie 
                                                data={metrics.genderStats.length > 0 ? metrics.genderStats : [{ name: 'Sin Datos', value: 1, color: '#333' }]} 
                                                cx="50%" cy="50%" 
                                                innerRadius={60} outerRadius={85} 
                                                paddingAngle={5} 
                                                dataKey="value" 
                                                stroke="none"
                                            >
                                                {(metrics.genderStats.length > 0 ? metrics.genderStats : [{ name: 'Sin Datos', value: 1, color: '#333' }]).map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                                ))}
                                            </Pie>
                                            <Tooltip contentStyle={{backgroundColor: '#000000cc', border: '1px solid #ffffff20', borderRadius: '12px'}} itemStyle={{color: '#fff'}} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="flex gap-4 justify-center mt-6 flex-wrap">
                                    {metrics.genderStats.map((g, i) => (
                                        <div key={i} className="flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full shadow-[0_0_8px_currentColor]" style={{ color: g.color, backgroundColor: g.color }} />
                                            <span className="text-[10px] text-white/60 font-bold">{g.name}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Edad */}
                            <div className="flex flex-col justify-start">
                                <h4 className="text-[10px] font-bold text-white/40 uppercase tracking-[0.2em] mb-6 w-full text-center border-b border-white/5 pb-2">Edad</h4>
                                <div className="h-[220px] w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={metrics.ageStats} layout="vertical" margin={{ left: 0, right: 30 }}>
                                            <XAxis type="number" hide />
                                            <YAxis 
                                                dataKey="range" 
                                                type="category" 
                                                width={40} 
                                                tick={{ fill: '#ffffff60', fontSize: 11, fontWeight: 'bold' }} 
                                                axisLine={false} 
                                                tickLine={false}
                                            />
                                            <Tooltip cursor={{fill: 'transparent'}} contentStyle={{backgroundColor: '#000000cc', border: '1px solid #ffffff20', borderRadius: '12px'}} itemStyle={{color:'#fff'}} />
                                            <Bar dataKey="count" fill="#8b5cf6" radius={[0, 6, 6, 0]} barSize={28} label={{ position: 'right', fill: 'white', fontSize: 10 }} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="mt-4">
                        <InsightBox 
                            type="info"
                            text="Usa estos datos para segmentar tus anuncios. Si tu público es mayoritariamente 25-34, enfócate en contenido de calidad y lifestyle."
                        />
                    </div>
                </div>
            </div>
        </section>

    </div>
  )
}

// --- SUB-COMPONENTES ESTILIZADOS ---

function SectionHeader({ title, subtitle, description }: any) {
    return (
        <div className="mb-6">
            <h2 className="text-xl font-black text-white tracking-tight flex items-center gap-3">
                {title} <span className="h-1 w-1 bg-white/20 rounded-full"></span> 
                <span className="text-base text-white/40 font-medium tracking-normal">{subtitle}</span>
            </h2>
            <p className="text-xs text-white/40 mt-1 max-w-2xl leading-relaxed font-medium">{description}</p>
        </div>
    )
}

function InsightBox({ type, text }: { type: 'positive'|'negative'|'info'|'neutral', text: string }) {
    const styles = {
        positive: "bg-[#00D15B]/5 border-[#00D15B]/20 text-[#00D15B]",
        negative: "bg-[#FF007F]/5 border-[#FF007F]/20 text-[#FF007F]",
        info: "bg-[#3b82f6]/5 border-[#3b82f6]/20 text-[#3b82f6]",
        neutral: "bg-white/5 border-white/10 text-white/40"
    }
    const icons = {
        positive: <TrendingUp size={16}/>,
        negative: <AlertTriangle size={16}/>,
        info: <Lightbulb size={16}/>,
        neutral: <Info size={16}/>
    }

    return (
        <div className={`p-4 rounded-xl border flex gap-3 items-start backdrop-blur-sm ${styles[type]}`}>
            <div className="mt-0.5 shrink-0">{icons[type]}</div>
            <div>
                <p className="text-xs font-medium leading-relaxed">{text}</p>
            </div>
        </div>
    )
}

function KpiCard({ title, value, sub, icon, color, bg, progress, tooltip }: any) {
    return (
        <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-6 relative overflow-hidden group hover:border-white/20 transition-all hover:scale-[1.02] shadow-xl shadow-purple-900/5">
            <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-50" />
            
            <div className="flex justify-between items-start mb-4">
                <div className={`p-3.5 rounded-2xl ${bg} ${color}`}>{icon}</div>
                {progress !== undefined && (
                   <div className="text-right">
                       <span className={`text-sm font-black ${color}`}>{progress.toFixed(0)}%</span>
                       <div className="w-12 h-1.5 bg-black/40 rounded-full mt-1 overflow-hidden">
                           <div className={`h-full rounded-full ${color.replace('text-', 'bg-')}`} style={{width: `${Math.min(progress, 100)}%`}}/>
                       </div>
                   </div>
                )}
            </div>
            <div>
                <div className="flex items-center gap-2 mb-1">
                    <p className="text-white/40 text-[10px] font-bold uppercase tracking-[0.2em]">{title}</p>
                    {tooltip && (
                        <div className="group/tip relative">
                            <HelpCircle size={12} className="text-white/20 cursor-help hover:text-white transition-colors"/>
                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-3 bg-black/90 backdrop-blur-md border border-white/10 rounded-xl text-[10px] text-white/80 hidden group-hover/tip:block z-50 shadow-xl">
                                {tooltip}
                            </div>
                        </div>
                    )}
                </div>
                <h4 className="text-3xl font-black text-white tracking-tight">{value}</h4>
                <p className="text-white/40 text-[10px] mt-2 font-medium bg-white/5 w-fit px-2 py-1 rounded-lg border border-white/5">{sub}</p>
            </div>
        </div>
    )
}
</file>

<file path="app/(dashboard)/settings/page.tsx">
'use client'
import { useState, useEffect, useRef } from 'react'
import { 
  Camera, Building2, Globe, Instagram, CreditCard, Save, History, 
  CheckCircle2, Clock, FileText, Loader2, AlertCircle, ChevronDown, Trash2, AlertTriangle, Image as ImageIcon,
  Facebook, Palette, LayoutTemplate, Check, Sparkles, Settings
} from 'lucide-react'
import { supabase } from '@/lib/supabase'
import { useOrg } from '@/components/providers/org-provider'

const BANKS_CHILE = ["Banco de Chile", "Banco Santander", "Banco Estado", "Scotiabank", "Bci", "Itaú", "Banco Bice", "Banco Security", "Banco Consorcio", "Banco Falabella", "Banco Ripley", "Tenpo", "Mach", "Coopeuch", "Mercado Pago"]
const ACCOUNT_TYPES = ["Cuenta Corriente", "Cuenta Vista / RUT", "Cuenta de Ahorro", "Chequera Electrónica"]
const REGIONES_CHILE: Record<string, string[]> = {
  "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"],
  "Tarapacá": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Camiña", "Colchane", "Huara", "Pica"],
  "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollagüe", "San Pedro de Atacama", "Tocopilla", "María Elena"],
  "Atacama": ["Copiapó", "Caldera", "Tierra Amarilla", "Chañaral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"],
  "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicuña", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbalá", "Monte Patria", "Punitaqui", "Río Hurtado"],
  "Valparaíso": ["Valparaíso", "Casablanca", "Concón", "Juan Fernández", "Puchuncaví", "Quintero", "Viña del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa María", "Quilpué", "Limache", "Olmué", "Villa Alemana"],
  "Metropolitana de Santiago": ["Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaquín", "San Miguel", "San Ramón", "Santiago", "Vitacura", "Puente Alto", "Pirque", "San José de Maipo", "Colina", "Lampa", "Til Til", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhué", "Curacaví", "María Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Peñaflor"],
  "Libertador Gral. Bernardo O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Doñihue", "Graneros", "Las Cabras", "Machalí", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requínoa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Chépica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"],
  "Maule": ["Talca", "Constitución", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "Río Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curicó", "Hualañé", "Licantén", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuquén", "Linares", "Colbún", "Longaví", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"],
  "Ñuble": ["Chillán", "Bulnes", "Cobquecura", "Coelemu", "Coihueco", "Chillán Viejo", "El Carmen", "Ninhue", "Ñiquén", "Pemuco", "Pinto", "Portezuelo", "Quillón", "Quirihue", "Ránquil", "San Carlos", "San Fabián", "San Ignacio", "San Nicolás", "Treguaco", "Yungay"],
  "Biobío": ["Concepción", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tomé", "Hualpén", "Lebu", "Arauco", "Cañete", "Contulmo", "Curanilahue", "Los Álamos", "Tirúa", "Los Ángeles", "Antuco", "Cabrero", "Laja", "Mulchén", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa Bárbara", "Tucapel", "Yumbel", "Alto Biobío"],
  "La Araucanía": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufquén", "Pucón", "Saavedra", "Teodoro Schmidt", "Toltén", "Vilcún", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacautín", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Purén", "Renaico", "Traiguén", "Victoria"],
  "Los Ríos": ["Valdivia", "Corral", "Lanco", "Los Lagos", "Máfil", "Mariquina", "Paillaco", "Panguipulli", "La Unión", "Futrono", "Lago Ranco", "Río Bueno"],
  "Los Lagos": ["Puerto Montt", "Calbuco", "Cochamó", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maullín", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de Vélez", "Dalcahue", "Puqueldón", "Queilén", "Quellón", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "Río Negro", "San Juan de la Costa", "San Pablo", "Chaitén", "Futaleufú", "Hualaihué", "Palena"],
  "Aysén": ["Coyhaique", "Lago Verde", "Aysén", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "Río Ibáñez"],
  "Magallanes y Antártica Chilena": ["Punta Arenas", "Laguna Blanca", "Río Verde", "San Gregorio", "Cabo de Hornos", "Antártica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]
}

const formatRut = (rut: string) => {
  if (!rut) return ''
  let cleanRut = rut.replace(/[^0-9kK]/g, '').toUpperCase()
  if (cleanRut.length <= 1) return cleanRut
  const body = cleanRut.slice(0, -1)
  const dv = cleanRut.slice(-1)
  const formattedBody = body.replace(/\B(?=(\d{3})+(?!\d))/g, '.')
  return `${formattedBody}-${dv}`
}

export default function SettingsPage() {
  const { currentOrgId, currentRole, refreshOrgs, deleteOrg } = useOrg()
  const [loading, setLoading] = useState(true)
  const [uploading, setUploading] = useState(false)
  const [saving, setSaving] = useState(false)
  const [deleting, setDeleting] = useState(false)
  const [activeTab, setActiveTab] = useState<'profile' | 'data' | 'payments'>('profile')
  const [billingRegionFilter, setBillingRegionFilter] = useState<string>("")

  const isCreating = !currentOrgId
  const isEditable = isCreating || currentRole === 'owner' || currentRole === 'admin'
  const isOwner = currentRole === 'owner'

  const [profile, setProfile] = useState({
    name: '', website_url: '', instagram_handle: '', description: '', primary_color: '#8B5CF6', 
    logo_url: '', banner_url: '' 
  })

  const [financialData, setFinancialData] = useState({
    bank_name: '', account_type: '', account_number: '', bank_rut: '', bank_holder_name: '', bank_email: '',
    billing_name: '', billing_rut: '', billing_address: '', billing_city: '', billing_email: ''
  })

  const [payouts, setPayouts] = useState<any[]>([])

  useEffect(() => {
      if (isCreating) {
          setProfile({ name: '', website_url: '', instagram_handle: '', description: '', primary_color: '#8B5CF6', logo_url: '', banner_url: '' })
          setFinancialData({ bank_name: '', account_type: '', account_number: '', bank_rut: '', bank_holder_name: '', bank_email: '', billing_name: '', billing_rut: '', billing_address: '', billing_city: '', billing_email: '' })
          setPayouts([])
          setLoading(false)
      }
  }, [isCreating])

  useEffect(() => {
    async function fetchData() {
      if (!currentOrgId) return

      try {
        setLoading(true)
        const { data: expData, error } = await supabase
          .from('experiences')
          .select('*')
          .eq('id', currentOrgId)
          .single()

        if (error) throw error

        if (expData) {
          setProfile({
            name: expData.name || '',
            website_url: expData.website_url || '',
            instagram_handle: expData.instagram_handle || '',
            description: expData.description || '',
            primary_color: expData.primary_color || '#8B5CF6',
            logo_url: expData.logo_url || '',
            banner_url: expData.banner_url || ''
          })

          let detectedRegion = ""
          if (expData.billing_city) {
             for (const [region, communes] of Object.entries(REGIONES_CHILE)) {
                if (communes.includes(expData.billing_city)) {
                    detectedRegion = region
                    break
                }
             }
          }
          setBillingRegionFilter(detectedRegion)

          setFinancialData({
            bank_name: expData.bank_name || '',
            account_type: expData.account_type || '',
            account_number: expData.account_number || '',
            bank_rut: formatRut(expData.bank_rut || ''),
            bank_holder_name: expData.bank_holder_name || '',
            bank_email: expData.bank_email || '',
            billing_name: expData.billing_name || '',
            billing_rut: formatRut(expData.billing_rut || ''),
            billing_address: expData.billing_address || '',
            billing_city: expData.billing_city || '',
            billing_email: expData.billing_email || ''
          })

          const { data: paymentsData } = await supabase
            .from('payouts')
            .select('*')
            .eq('experience_id', currentOrgId)
            .order('created_at', { ascending: false })
          
          if (paymentsData) setPayouts(paymentsData)
        }

      } catch (error) {
        console.error(error)
      } finally {
        setLoading(false)
      }
    }
    fetchData()
  }, [currentOrgId])

  const handleImageUpload = (field: 'logo_url' | 'banner_url') => async (event: any) => {
    try {
      setUploading(true)
      if (!event.target.files || event.target.files.length === 0) return
      const file = event.target.files[0]
      const fileExt = file.name.split('.').pop()
      const fileName = `${currentOrgId || 'new'}-${field}-${Date.now()}.${fileExt}`
      const filePath = `${fileName}`

      const { error: uploadError } = await supabase.storage.from('logos').upload(filePath, file)
      if (uploadError) throw uploadError

      const { data: { publicUrl } } = supabase.storage.from('logos').getPublicUrl(filePath)
      
      setProfile(prev => ({ ...prev, [field]: publicUrl }))
      alert('Imagen subida correctamente. No olvides "Guardar Cambios".')
    } catch (error: any) {
      alert('Error: ' + error.message)
    } finally {
      setUploading(false)
    }
  }

  const handleSave = async () => {
    try {
        setSaving(true)
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) return

        const updatePayload = {
            name: profile.name,
            website_url: profile.website_url,
            instagram_handle: profile.instagram_handle,
            description: profile.description,
            primary_color: profile.primary_color,
            logo_url: profile.logo_url,
            banner_url: profile.banner_url,
            bank_name: financialData.bank_name,
            account_type: financialData.account_type,
            account_number: financialData.account_number,
            bank_rut: financialData.bank_rut,
            bank_holder_name: financialData.bank_holder_name,
            bank_email: financialData.bank_email,
            billing_name: financialData.billing_name,
            billing_rut: financialData.billing_rut,
            billing_address: financialData.billing_address,
            billing_city: financialData.billing_city,
            billing_email: financialData.billing_email
        }

        if (currentOrgId) {
            const { error } = await supabase
                .from('experiences')
                .update(updatePayload)
                .eq('id', currentOrgId)
            if (error) throw error
        } else {
            const { error } = await supabase
                .from('experiences')
                .insert({ ...updatePayload, producer_id: user.id })
            
            if (error) throw error
            await refreshOrgs()
        }

        alert(isCreating ? 'Productora creada correctamente ✅' : 'Configuración guardada correctamente ✅')
    } catch (error: any) {
        alert('Error al guardar: ' + error.message)
    } finally {
        setSaving(false)
    }
  }

  const handleDelete = async () => {
      if (!currentOrgId) return
      
      const confirmText = prompt(`Para eliminar, escribe el nombre de la productora: "${profile.name}"`)
      if (confirmText !== profile.name) {
          return alert("El nombre no coincide. Operación cancelada.")
      }

      try {
          setDeleting(true)
          await deleteOrg(currentOrgId)
          alert("Productora eliminada correctamente.")
      } catch (error: any) {
          alert("Error al eliminar: " + error.message)
          setDeleting(false)
      }
  }

  const handleRutChange = (key: 'bank_rut' | 'billing_rut', value: string) => {
    const rawValue = value.replace(/[^0-9kK]/g, '')
    if (rawValue.length > 9) return 
    const formatted = formatRut(value)
    setFinancialData(prev => ({ ...prev, [key]: formatted }))
  }

  if (loading) return (
    <div className="flex items-center justify-center h-full pt-40">
        <Loader2 className="animate-spin text-[#8A2BE2]" size={40} />
    </div>
  )

  return (
    // CONTENEDOR LIMPIO (Sin fondo, ya está en el Layout)
    <div className="relative z-10 max-w-5xl mx-auto space-y-8 animate-in fade-in pt-0">
        
        {/* --- HEADER MODIFICADO (Sin "Configuration" y menos padding) --- */}
        <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-white/5 pb-6">
            <div>
                <h1 className="text-4xl md:text-5xl font-black text-white tracking-tighter mb-1">
                    Configuración <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#8A2BE2] to-[#FF007F]">Global</span>
                </h1>
                <p className="text-white/40 text-sm font-medium mt-2 max-w-lg">
                    {isCreating ? 'Configura tu nueva productora para comenzar.' : `Administra el perfil, datos y facturación de ${profile.name || 'la productora'}.`}
                </p>
            </div>
            
            {(isEditable || isCreating) && (
                <button 
                    onClick={handleSave}
                    disabled={loading || saving}
                    className="h-12 px-8 bg-white text-black font-bold rounded-2xl hover:scale-105 active:scale-95 transition-all flex items-center gap-3 shadow-[0_0_20px_rgba(255,255,255,0.15)] uppercase text-xs tracking-wider disabled:opacity-50"
                >
                    {saving ? <Loader2 size={16} className="animate-spin"/> : <Save size={16} />} 
                    {isCreating ? 'Crear' : 'Guardar Cambios'}
                </button>
            )}
        </div>

        {/* --- CONTENIDO PRINCIPAL (GRID) --- */}
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            {/* SIDEBAR DE NAVEGACIÓN */}
            <div className="lg:col-span-3 space-y-2">
                <h3 className="text-[10px] font-bold text-white/40 uppercase tracking-[0.2em] mb-4 px-2">Secciones</h3>
                <NavButton active={activeTab === 'profile'} onClick={() => setActiveTab('profile')} icon={<Building2 size={16} />} label="Perfil Productora" />
                <NavButton active={activeTab === 'data'} onClick={() => setActiveTab('data')} icon={<CreditCard size={16} />} label="Datos & Facturación" />
                <NavButton active={activeTab === 'payments'} onClick={() => setActiveTab('payments')} icon={<History size={16} />} label="Historial de Pagos" />
            </div>

            {/* ÁREA DE FORMULARIOS */}
            <div className="lg:col-span-9 space-y-8">
                
                {/* SECCIÓN PERFIL */}
                {activeTab === 'profile' && (
                    <section className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-500">
                        {/* Preview Card ACHICADA (h-40 banner, h-24 logo, pb-6 padding, rounded-2rem) */}
                        <div className="relative bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] shadow-2xl shadow-purple-900/10 overflow-hidden pb-6"> 
                            
                            {/* Banner MÁS CHICO (h-40) */}
                            <div className="h-40 w-full bg-black/40 border-b border-white/5 relative overflow-hidden group">
                                {profile.banner_url ? (
                                    <img src={profile.banner_url} alt="Banner" className="h-full w-full object-cover opacity-80 transition-transform duration-700 group-hover:scale-105" />
                                ) : (
                                    <div className="absolute inset-0 flex items-center justify-center opacity-10 bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
                                        <ImageIcon size={48} className="text-white/20" />
                                    </div>
                                )}
                                
                                <div className="absolute inset-0 bg-gradient-to-t from-[#030005] via-transparent to-transparent pointer-events-none" />

                                {(isEditable || isCreating) && (
                                    <>
                                        <label 
                                            htmlFor="banner-upload" 
                                            className="absolute top-4 right-4 px-3 py-1.5 bg-black/50 hover:bg-black/80 backdrop-blur-md rounded-lg cursor-pointer flex items-center gap-2 text-[9px] font-bold uppercase tracking-wider text-white border border-white/10 transition-all opacity-0 group-hover:opacity-100 hover:border-white/30"
                                        >
                                            <Camera size={12} /> Cambiar
                                        </label>
                                        <input type="file" accept="image/*" id="banner-upload" className="hidden" onChange={handleImageUpload('banner_url')} disabled={uploading} />
                                    </>
                                )}
                            </div>

                            {/* Logo & Info MÁS CHICOS (h-24 w-24, -mt-12) */}
                            <div className="px-8 relative -mt-12 flex flex-col items-center text-center">
                                <div className="relative group">
                                    <div className="h-24 w-24 rounded-2xl bg-[#030005] border-[3px] border-[#030005] flex items-center justify-center overflow-hidden shadow-2xl relative">
                                        {profile.logo_url ? (
                                            <img src={profile.logo_url} alt="Logo" className="h-full w-full object-cover" />
                                        ) : (
                                            <Building2 size={24} className="text-white/20" />
                                        )}
                                        {uploading && (
                                            <div className="absolute inset-0 bg-black/80 flex items-center justify-center z-10 backdrop-blur-sm">
                                                <Loader2 size={20} className="text-[#8A2BE2] animate-spin" />
                                            </div>
                                        )}
                                    </div>
                                    {(isEditable || isCreating) && (
                                        <>
                                            <label htmlFor="logo-upload" 
                                                className="absolute -bottom-1.5 -right-1.5 p-2 rounded-xl cursor-pointer shadow-lg transition-all active:scale-90 border-2 border-[#030005] z-20 hover:scale-110"
                                                style={{ backgroundColor: profile.primary_color || '#8B5CF6' }}
                                            >
                                                <Camera size={12} className="text-white" />
                                            </label>
                                            <input type="file" accept="image/*" id="logo-upload" className="hidden" onChange={handleImageUpload('logo_url')} disabled={uploading} />
                                        </>
                                    )}
                                </div>

                                <div className="mt-4 space-y-1 max-w-lg">
                                    <h2 className="text-2xl font-black text-white tracking-tighter uppercase">
                                        {profile.name || "Tu Productora"}
                                    </h2>
                                    {profile.description && (
                                        <p className="text-xs font-medium text-white/40 leading-relaxed line-clamp-2">
                                            {profile.description}
                                        </p>
                                    )}
                                </div>

                                <div className="flex gap-2 mt-4">
                                    {profile.instagram_handle && (
                                        <a href={`https://instagram.com/${profile.instagram_handle.replace('@', '')}`} target="_blank" rel="noopener noreferrer" className="h-8 px-3 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 flex items-center gap-1.5 text-[10px] font-bold text-white transition-all">
                                            <Instagram size={12} className="text-[#E1306C]" /> Instagram
                                        </a>
                                    )}
                                    {profile.website_url && (
                                        <a href={profile.website_url} target="_blank" rel="noopener noreferrer" className="h-8 px-3 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 flex items-center gap-1.5 text-[10px] font-bold text-white transition-all">
                                            <Globe size={12} className="text-[#3b82f6]" /> Web
                                        </a>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Formularios */}
                        <div className="grid grid-cols-1 gap-6">
                            
                            <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 space-y-6 shadow-xl">
                                <h3 className="text-xs font-bold text-white/60 flex items-center gap-2 uppercase tracking-widest mb-4">
                                    <LayoutTemplate size={14} className="text-[#8A2BE2]"/> Identidad de Marca
                                </h3>
                                <InputGroup 
                                    label="Nombre Fantasía" 
                                    icon={<Building2 size={14} />} 
                                    placeholder="Ej: DyzGO Producciones" 
                                    value={profile.name} 
                                    onChange={(e: any) => setProfile({...profile, name: e.target.value})} 
                                    disabled={!isEditable && !isCreating} 
                                />
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-white/40 uppercase tracking-wider ml-1">Descripción Pública</label>
                                    <textarea 
                                        value={profile.description} 
                                        onChange={(e) => setProfile({...profile, description: e.target.value})} 
                                        disabled={!isEditable && !isCreating} 
                                        placeholder="Breve reseña sobre la productora..." 
                                        className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white focus:outline-none focus:border-[#8A2BE2]/50 focus:bg-black/60 h-28 resize-none disabled:opacity-50 transition-all placeholder:text-white/20" 
                                    />
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 space-y-6 shadow-xl">
                                    <h3 className="text-xs font-bold text-white/60 flex items-center gap-2 uppercase tracking-widest mb-4">
                                        <Globe size={14} className="text-[#06b6d4]"/> Digital
                                    </h3>
                                    <InputGroup 
                                        label="Sitio Web" 
                                        icon={<Globe size={14} />} 
                                        placeholder="https://tuweb.cl" 
                                        value={profile.website_url} 
                                        onChange={(e: any) => setProfile({...profile, website_url: e.target.value})} 
                                        disabled={!isEditable && !isCreating} 
                                    />
                                    <InputGroup 
                                        label="Instagram" 
                                        icon={<Instagram size={14} />} 
                                        placeholder="@tu_productora" 
                                        value={profile.instagram_handle} 
                                        onChange={(e: any) => setProfile({...profile, instagram_handle: e.target.value})} 
                                        disabled={!isEditable && !isCreating} 
                                    />
                                </div>

                                <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 space-y-6 shadow-xl">
                                    <h3 className="text-xs font-bold text-white/60 flex items-center gap-2 uppercase tracking-widest mb-4">
                                        <Palette size={14} className="text-[#FF007F]"/> Estilo
                                    </h3>
                                    <div className="space-y-3">
                                        <label className="text-[10px] font-bold text-white/40 uppercase tracking-wider ml-1">Color Principal</label>
                                        <div className="flex gap-3 items-center bg-black/40 border border-white/10 p-2 rounded-2xl">
                                            <div className="h-10 w-10 rounded-xl shadow-[0_0_15px_rgba(0,0,0,0.5)] border border-white/10" style={{ backgroundColor: profile.primary_color }} />
                                            <div className="flex-1 relative">
                                                <input 
                                                    type="color" 
                                                    value={profile.primary_color} 
                                                    onChange={(e) => setProfile({...profile, primary_color: e.target.value})} 
                                                    disabled={!isEditable && !isCreating} 
                                                    className="absolute inset-0 opacity-0 w-full h-full cursor-pointer" 
                                                />
                                                <input 
                                                    type="text" 
                                                    value={profile.primary_color} 
                                                    onChange={(e) => setProfile({...profile, primary_color: e.target.value})} 
                                                    disabled={!isEditable && !isCreating} 
                                                    className="w-full bg-transparent text-sm font-mono text-white focus:outline-none uppercase" 
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                )}

                {/* SECCIÓN DATOS */}
                {activeTab === 'data' && (
                    <section className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-500">
                        <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 space-y-6 shadow-xl">
                            <h3 className="text-xs font-bold text-white/60 flex items-center gap-2 uppercase tracking-widest mb-2">
                                <CreditCard size={14} className="text-[#00D15B]" /> Datos Bancarios
                            </h3>
                            <div className="grid grid-cols-2 gap-6">
                                <CustomSelect label="Banco" options={BANKS_CHILE} placeholder="Seleccionar Banco" value={financialData.bank_name} onChange={(val: string) => setFinancialData({...financialData, bank_name: val})} disabled={!isEditable && !isCreating} />
                                <CustomSelect label="Tipo de Cuenta" options={ACCOUNT_TYPES} placeholder="Seleccionar Tipo" value={financialData.account_type} onChange={(val: string) => setFinancialData({...financialData, account_type: val})} disabled={!isEditable && !isCreating} />
                            </div>
                            <InputGroup label="Número de Cuenta" placeholder="Ej: 12345678" value={financialData.account_number} onChange={(e: any) => setFinancialData({...financialData, account_number: e.target.value.replace(/\D/g, '').slice(0, 20)})} disabled={!isEditable && !isCreating} />
                            <div className="grid grid-cols-2 gap-6">
                                <InputGroup label="RUT Titular" placeholder="12.345.678-9" value={financialData.bank_rut} onChange={(e: any) => handleRutChange('bank_rut', e.target.value)} disabled={!isEditable && !isCreating} />
                                <InputGroup label="Nombre Titular" placeholder="Razón Social o Nombre" value={financialData.bank_holder_name} onChange={(e: any) => setFinancialData({...financialData, bank_holder_name: e.target.value})} disabled={!isEditable && !isCreating} />
                            </div>
                            <InputGroup label="Email Comprobantes" placeholder="finanzas@productora.cl" value={financialData.bank_email} onChange={(e: any) => setFinancialData({...financialData, bank_email: e.target.value})} disabled={!isEditable && !isCreating} />
                        </div>

                        <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 space-y-6 shadow-xl">
                            <h3 className="text-xs font-bold text-white/60 flex items-center gap-2 uppercase tracking-widest mb-2">
                                <FileText size={14} className="text-[#3b82f6]" /> Datos de Facturación
                            </h3>
                            <InputGroup label="Razón Social" placeholder="Nombre de la empresa" value={financialData.billing_name} onChange={(e: any) => setFinancialData({...financialData, billing_name: e.target.value})} disabled={!isEditable && !isCreating} />
                            <div className="grid grid-cols-2 gap-6">
                                <CustomSelect label="Región" options={Object.keys(REGIONES_CHILE)} placeholder="Seleccionar Región" value={billingRegionFilter} onChange={(val: string) => { setBillingRegionFilter(val); setFinancialData({...financialData, billing_city: ''}) }} disabled={!isEditable && !isCreating} />
                                <CustomSelect label="Comuna" options={billingRegionFilter ? REGIONES_CHILE[billingRegionFilter] : []} placeholder={billingRegionFilter ? "Seleccionar Comuna" : "Seleccione Región"} value={financialData.billing_city} disabled={(!billingRegionFilter || (!isEditable && !isCreating))} onChange={(val: string) => setFinancialData({...financialData, billing_city: val})} />
                            </div>
                            <div className="grid grid-cols-2 gap-6">
                                <InputGroup label="RUT Empresa" placeholder="76.xxx.xxx-x" value={financialData.billing_rut} onChange={(e: any) => handleRutChange('billing_rut', e.target.value)} disabled={!isEditable && !isCreating} />
                                <InputGroup label="Email Facturación" placeholder="dte@empresa.cl" value={financialData.billing_email} onChange={(e: any) => setFinancialData({...financialData, billing_email: e.target.value})} disabled={!isEditable && !isCreating} />
                            </div>
                            <InputGroup label="Dirección Tributaria" placeholder="Av. Providencia 1234" value={financialData.billing_address} onChange={(e: any) => setFinancialData({...financialData, billing_address: e.target.value})} disabled={!isEditable && !isCreating} />
                        </div>
                    </section>
                )}

                {/* SECCIÓN PAGOS */}
                {activeTab === 'payments' && (
                    <section className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                        <div className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 min-h-[400px]">
                            <h3 className="text-xs font-bold text-white/60 flex items-center gap-2 uppercase tracking-widest mb-6">
                                <History size={14} className="text-[#8A2BE2]" /> Historial de Pagos
                            </h3>
                            <div className="space-y-3">
                                {payouts.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-20 border border-dashed border-white/10 rounded-3xl bg-white/5 text-white/30">
                                        <AlertCircle size={40} className="mb-4 opacity-50 text-[#8A2BE2]" />
                                        <p className="text-sm font-medium">Aún no hay pagos registrados.</p>
                                    </div>
                                ) : (
                                    payouts.map((payment) => (
                                        <div key={payment.id} className="bg-black/40 border border-white/5 rounded-2xl p-5 flex items-center justify-between hover:bg-white/5 transition-colors group">
                                            <div className="flex items-center gap-5">
                                                <div className={`p-3 rounded-xl border border-white/5 ${payment.status === 'completed' ? 'bg-[#00D15B]/10 text-[#00D15B]' : 'bg-[#eab308]/10 text-[#eab308]'}`}>
                                                    {payment.status === 'completed' ? <CheckCircle2 size={20} /> : <Clock size={20} />}
                                                </div>
                                                <div>
                                                    <h4 className="text-white font-bold group-hover:text-[#FF007F] transition-colors">{payment.concept || `Pago #${payment.id.slice(0,6)}`}</h4>
                                                    <p className="text-xs text-white/40 font-medium">{new Date(payment.created_at).toLocaleDateString()}</p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-white font-bold font-mono text-lg">${Number(payment.amount).toLocaleString('es-CL')}</p>
                                                <span className={`text-[9px] font-black uppercase tracking-wider px-2 py-1 rounded-lg ${payment.status === 'completed' ? 'bg-[#00D15B]/10 text-[#00D15B]' : 'bg-[#eab308]/10 text-[#eab308]'}`}>
                                                    {payment.status === 'completed' ? 'Pagado' : 'Pendiente'}
                                                </span>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </section>
                )}
            </div>
        </div>

        {/* ZONA PELIGROSA */}
        {isOwner && !isCreating && (
            <div className="mt-16 pt-8 border-t border-white/5">
                <div className="bg-[#FF007F]/5 border border-[#FF007F]/20 rounded-[2rem] p-8 flex flex-col md:flex-row md:items-center justify-between gap-6 backdrop-blur-md">
                    <div>
                        <h4 className="text-[#FF007F] font-bold flex items-center gap-2 mb-2 text-sm uppercase tracking-widest">
                            <AlertTriangle size={16} /> Zona de Peligro
                        </h4>
                        <p className="text-xs text-[#FF007F]/60 max-w-md font-medium">
                            Esta acción es irreversible. Se eliminará permanentemente la productora y todos sus eventos asociados.
                        </p>
                    </div>
                    <button 
                        onClick={handleDelete}
                        disabled={deleting}
                        className="px-6 py-3 bg-[#FF007F]/10 hover:bg-[#FF007F]/20 text-[#FF007F] text-xs font-bold rounded-xl border border-[#FF007F]/30 transition-all flex items-center gap-2 whitespace-nowrap uppercase tracking-wider shadow-[0_0_15px_rgba(255,0,127,0.1)]"
                    >
                        {deleting ? <Loader2 size={14} className="animate-spin"/> : <Trash2 size={14} />}
                        Eliminar Productora
                    </button>
                </div>
            </div>
        )}

    </div>
  )
}

// --- SUB-COMPONENTES ESTILIZADOS ---

function NavButton({ active, onClick, icon, label }: any) {
    return (
        <button 
            onClick={onClick} 
            className={`w-full text-left px-5 py-3.5 rounded-2xl transition-all font-bold flex items-center gap-3 text-xs uppercase tracking-wider ${
                active 
                ? 'bg-white text-black shadow-[0_0_20px_rgba(255,255,255,0.1)]' 
                : 'text-white/40 hover:text-white hover:bg-white/5'
            }`}
        >
            {icon} {label}
        </button>
    )
}

function InputGroup({ label, icon, placeholder, value, onChange, disabled }: any) {
    return (
        <div className="space-y-2">
            <label className="text-[10px] font-bold text-white/40 uppercase tracking-wider flex items-center gap-2 ml-1">
                {icon} {label}
            </label>
            <input 
                type="text" 
                placeholder={placeholder} 
                value={value || ''} 
                onChange={onChange} 
                disabled={disabled} 
                className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3.5 text-sm text-white focus:outline-none focus:border-[#8A2BE2]/50 focus:bg-black/60 transition-all placeholder:text-white/20 disabled:opacity-50" 
            />
        </div>
    )
}

function CustomSelect({ label, options, placeholder, value, onChange, disabled }: any) {
    const [isOpen, setIsOpen] = useState(false);
    const containerRef = useRef<HTMLDivElement>(null);

    useEffect(() => {
        function handleClickOutside(event: MouseEvent) {
            if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
                setIsOpen(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleSelect = (option: string) => {
        if (!disabled) {
            onChange(option);
            setIsOpen(false);
        }
    };

    return (
        <div className="space-y-2 relative" ref={containerRef}>
            <label className="text-[10px] font-bold text-white/40 uppercase tracking-wider ml-1 flex items-center gap-2">{label}</label>
            <div 
                className={`w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3.5 text-sm text-white flex items-center justify-between cursor-pointer transition-all ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-black/60 hover:border-white/20'} ${isOpen ? 'border-[#8A2BE2]/50' : ''}`}
                onClick={() => !disabled && setIsOpen(!isOpen)}
            >
                <span className={!value ? 'text-white/20' : ''}>
                    {value || placeholder}
                </span>
                <ChevronDown size={16} className={`text-white/40 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
            </div>

            {isOpen && !disabled && (
                <div className="absolute z-50 w-full mt-2 bg-[#09090b]/95 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl max-h-60 overflow-y-auto animate-in fade-in zoom-in-95 duration-100 p-1 [&::-webkit-scrollbar]:w-1.5 [&::-webkit-scrollbar-track]:bg-transparent [&::-webkit-scrollbar-thumb]:bg-white/10 [&::-webkit-scrollbar-thumb]:rounded-full hover:[&::-webkit-scrollbar-thumb]:bg-white/20">
                    {options.length > 0 ? (
                        <ul className="py-1">
                            {options.map((opt: string) => (
                                <li 
                                    key={opt}
                                    className={`px-4 py-2.5 text-xs font-medium cursor-pointer transition-all rounded-xl flex items-center justify-between ${value === opt ? 'bg-[#8A2BE2]/10 text-[#8A2BE2]' : 'text-white/70 hover:bg-white/5 hover:text-white'}`}
                                    onClick={() => handleSelect(opt)}
                                >
                                    {opt}
                                    {value === opt && <Check size={14} />}
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <div className="px-4 py-3 text-xs text-white/40 text-center">No hay opciones disponibles</div>
                    )}
                </div>
            )}
        </div>
    );
}
</file>

<file path="app/(dashboard)/team/page.tsx">
'use client'
import { useEffect, useState, useCallback } from 'react'
import { ShieldAlert, Search, Plus, Filter, AlertTriangle, Ban, FileWarning, CheckCircle2, X, MoreVertical, UserX, Siren, Calendar, MapPin, Trash2, Eye, Mail, ChevronDown, Check, RotateCcw, AlertOctagon, Lock, Sparkles } from 'lucide-react'
import { supabase } from '@/lib/supabase'
import { useOrg } from '@/components/providers/org-provider'

const INCIDENT_TYPES = [{ id: 'violence', label: 'Violencia / Agresión', color: 'text-red-500', bg: 'bg-red-500/10', border: 'border-red-500/20', dot: 'bg-red-500' }, { id: 'fraud', label: 'Estafa / Ticket Falso', color: 'text-[#8A2BE2]', bg: 'bg-[#8A2BE2]/10', border: 'border-[#8A2BE2]/20', dot: 'bg-[#8A2BE2]' }, { id: 'theft', label: 'Robo / Hurto', color: 'text-[#FF007F]', bg: 'bg-[#FF007F]/10', border: 'border-[#FF007F]/20', dot: 'bg-[#FF007F]' }, { id: 'conduct', label: 'Mala Conducta', color: 'text-yellow-500', bg: 'bg-yellow-500/10', border: 'border-yellow-500/20', dot: 'bg-yellow-500' }, { id: 'other', label: 'Otro Motivo', color: 'text-zinc-400', bg: 'bg-white/5', border: 'border-white/10', dot: 'bg-zinc-400' }]
const formatRut = (value: string) => { let clean = value.replace(/[^0-9kK]/g, '').toUpperCase(); if (clean.length > 9) clean = clean.slice(0, 9); if (clean.length < 2) return clean; const body = clean.slice(0, -1); const dv = clean.slice(-1); return `${body}-${dv}` }

export default function BlacklistPage() {
  const { currentOrgId } = useOrg()
  const [loading, setLoading] = useState(true)
  const [cases, setCases] = useState<any[]>([])
  const [events, setEvents] = useState<any[]>([]) 
  const [filter, setFilter] = useState('')
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [submitting, setSubmitting] = useState(false)
  const [newCase, setNewCase] = useState({ name: '', rut: '', email: '', type: 'violence', notes: '', event: '' })

  const fetchBlacklist = useCallback(async () => {
    if (!currentOrgId) return
    setLoading(true)
    try { const { data, error } = await supabase.from('blacklist').select('*').eq('org_id', currentOrgId).order('created_at', { ascending: false }); if (error) throw error; if (data) setCases(data) } catch (err) { console.error("Error cargando blacklist:", err) } finally { setLoading(false) }
  }, [currentOrgId])

  useEffect(() => { if (currentOrgId) { const fetchEvents = async () => { const { data } = await supabase.from('events').select('title, location').eq('experience_id', currentOrgId).order('date', { ascending: false }); if (data) setEvents(data) }; fetchEvents() } }, [currentOrgId])
  useEffect(() => { fetchBlacklist() }, [fetchBlacklist])

  const filteredCases = cases.filter(c => (c.name && c.name.toLowerCase().includes(filter.toLowerCase())) || (c.rut && c.rut.includes(filter)) || (c.email && c.email.toLowerCase().includes(filter.toLowerCase())) || (c.reason && c.reason.toLowerCase().includes(filter.toLowerCase())))
  const handleAddCase = async () => { if (!newCase.name || (!newCase.rut && !newCase.email)) { return alert("Debes ingresar al menos el Nombre y un identificador (RUT o Email).") }; setSubmitting(true); try { const { error } = await supabase.from('blacklist').insert({ org_id: currentOrgId, name: newCase.name, rut: newCase.rut, email: newCase.email.toLowerCase().trim(), type: newCase.type, reason: newCase.notes, event_context: newCase.event, status: 'active' }); if (error) throw error; alert("Usuario agregado a la Blacklist. Se bloquearán sus intentos de compra."); setIsModalOpen(false); setNewCase({ name: '', rut: '', email: '', type: 'violence', notes: '', event: '' }); fetchBlacklist() } catch (error: any) { alert("Error al guardar: " + error.message) } finally { setSubmitting(false) } }
  const toggleStatus = async (id: string, currentStatus: string) => { const newStatus = currentStatus === 'active' ? 'resolved' : 'active'; try { setCases(cases.map(c => c.id === id ? { ...c, status: newStatus } : c)); const { error } = await supabase.from('blacklist').update({ status: newStatus }).eq('id', id); if (error) throw error } catch (error) { console.error("Error actualizando estado", error); fetchBlacklist() } }
  const handleDelete = async (id: string) => { if(!confirm("¿Eliminar este registro permanentemente?")) return; try { setCases(cases.filter(c => c.id !== id)); const { error } = await supabase.from('blacklist').delete().eq('id', id); if (error) throw error } catch (error) { alert("No se pudo eliminar"); fetchBlacklist() } }

  return (
    // CONTENEDOR LIMPIO (Sin fondo, ya está en el Layout)
    <div className="relative z-10 max-w-[1600px] mx-auto space-y-8 animate-in fade-in pt-0">
        
        {/* HEADER */}
        <div className="flex flex-col xl:flex-row justify-between items-end gap-6 border-b border-white/5 pb-6">
            <div><h1 className="text-4xl md:text-5xl font-black text-white tracking-tighter mb-2">Black<span className="text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-[#FF007F]">list</span></h1><p className="text-white/40 max-w-2xl text-sm leading-relaxed font-medium">Gestión centralizada de derecho de admisión. Los usuarios registrados aquí serán bloqueados automáticamente.</p></div>
            <div className="flex flex-wrap md:flex-nowrap gap-3 w-full xl:w-auto items-center">
                <div className="flex items-center gap-4 bg-white/5 backdrop-blur-md border border-white/10 px-6 h-14 rounded-2xl shadow-lg flex-1 md:flex-none justify-center md:justify-start"><StatBadge label="Activos" count={cases.filter(c => c.status === 'active').length} color="text-red-500" icon={<Ban size={14}/>} /><div className="w-px h-6 bg-white/10"></div><StatBadge label="Resueltos" count={cases.filter(c => c.status === 'resolved').length} color="text-[#00D15B]" icon={<CheckCircle2 size={14}/>} /></div>
                <button onClick={() => setIsModalOpen(true)} className="h-14 px-8 bg-white text-black font-bold rounded-2xl transition-all shadow-[0_0_20px_rgba(255,255,255,0.15)] flex items-center justify-center gap-3 text-xs uppercase tracking-wider hover:scale-105 active:scale-95 whitespace-nowrap flex-1 md:flex-none"><Plus size={18} strokeWidth={3} /> Nuevo Reporte</button>
            </div>
        </div>

        {/* BUSCADOR */}
        <div className="sticky top-4 z-30">
            <div className="relative group shadow-2xl shadow-purple-900/10">
                <div className="absolute inset-y-0 left-0 pl-6 flex items-center pointer-events-none text-white/40 group-focus-within:text-white transition-colors z-10"><Search size={20} /></div>
                <input type="text" value={filter} onChange={(e) => setFilter(e.target.value)} onKeyDown={(e) => { if (e.key === 'Escape') setFilter('') }} placeholder="Buscar por RUT, Nombre, Email, Contexto..." className="w-full bg-white/5 backdrop-blur-xl border border-white/10 focus:border-red-500/50 rounded-2xl pl-16 pr-4 h-14 text-white placeholder:text-white/20 outline-none transition-all text-sm font-medium focus:bg-black/60 shadow-lg" />
                <div className="absolute inset-y-0 right-6 flex items-center"><span className="text-[10px] text-white/30 font-mono bg-white/5 px-2 py-1 rounded border border-white/5">ESC to clear</span></div>
            </div>
        </div>

        {loading ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{[1,2,3].map(i => <div key={i} className="h-64 bg-white/5 rounded-[2rem] animate-pulse border border-white/5"/>)}</div>
        ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {filteredCases.map((incident) => {
                    const typeConfig = INCIDENT_TYPES.find(t => t.id === incident.type) || INCIDENT_TYPES[4]
                    const isActive = incident.status === 'active'
                    return (
                        <div key={incident.id} className={`relative bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-1 overflow-hidden transition-all duration-300 group hover:shadow-2xl hover:shadow-red-900/20 hover:border-white/20 hover:scale-[1.01] ${isActive ? 'opacity-100' : 'opacity-60 grayscale hover:grayscale-0'}`}>
                            {isActive && <div className="absolute top-0 right-0 w-32 h-32 bg-red-500/10 rounded-full blur-[50px] pointer-events-none" />}
                            {isActive && <div className="absolute inset-0 bg-gradient-to-br from-red-500/10 via-transparent to-transparent opacity-30 pointer-events-none" />}
                            <div className="h-full bg-black/40 rounded-[1.8rem] p-5 flex flex-col relative z-10">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex items-center gap-3 overflow-hidden">
                                        <div className="h-10 w-10 shrink-0 rounded-xl flex items-center justify-center text-sm font-black border bg-white/5 border-white/5 text-white/40 shadow-sm">{incident.name.charAt(0).toUpperCase()}</div>
                                        <div className="min-w-0">
                                            <h3 className="text-white font-bold text-base leading-none truncate group-hover:text-red-500 transition-colors mb-1">{incident.name}</h3>
                                            <div className="flex items-center gap-2"><span className={`text-[9px] font-black uppercase tracking-wider ${isActive ? 'text-red-500' : 'text-[#00D15B]'}`}>{isActive ? '● Vetado' : '● Resuelto'}</span></div>
                                        </div>
                                    </div>
                                    <div className={`px-2 py-1 rounded-lg border text-[8px] font-bold uppercase ${typeConfig.bg} ${typeConfig.color} ${typeConfig.border}`}>{typeConfig.label}</div>
                                </div>
                                <div className="bg-white/5 p-4 rounded-xl border border-white/5 mb-3 flex flex-col gap-2">
                                    <DataRow icon={<UserX size={12}/>} label="RUT" value={incident.rut || 'No registrado'} mono /><div className="h-px bg-white/5" /><DataRow icon={<Mail size={12}/>} label="Email" value={incident.email || 'No registrado'} /><div className="h-px bg-white/5" /><DataRow icon={<Calendar size={12}/>} label="Fecha" value={new Date(incident.created_at).toLocaleDateString()} />
                                </div>
                                <div className="flex-1 flex flex-col gap-2">
                                    {incident.event_context && (<div className="flex items-center gap-2 text-[9px] text-white/50 font-bold bg-white/5 p-2 rounded-lg border border-white/5"><MapPin size={10} className="text-[#8A2BE2] shrink-0"/><span className="truncate uppercase tracking-wide">{incident.event_context}</span></div>)}
                                    <div className="bg-white/5 rounded-xl p-3 border border-white/5 flex-1 min-h-[4rem]"><p className="text-white/70 text-xs italic leading-relaxed font-medium">"{incident.reason}"</p></div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 mt-4 pt-3 border-t border-white/5">
                                    <button onClick={() => toggleStatus(incident.id, incident.status)} className={`flex items-center justify-center gap-2 py-2.5 rounded-xl text-[10px] font-bold uppercase transition-all border shadow-sm ${isActive ? 'bg-[#00D15B]/10 text-[#00D15B] border-[#00D15B]/20 hover:bg-[#00D15B]/20' : 'bg-red-500/10 text-red-500 border-red-500/20 hover:bg-red-500/20'}`}>{isActive ? <Check size={14}/> : <RotateCcw size={14}/>}{isActive ? 'Perdonar' : 'Reactivar'}</button>
                                    <button onClick={() => handleDelete(incident.id)} className="flex items-center justify-center gap-2 py-2.5 rounded-xl border border-white/5 bg-white/5 hover:bg-red-500/10 hover:border-red-500/20 hover:text-red-500 text-white/40 transition-all text-[10px] font-bold uppercase shadow-sm"><Trash2 size={14}/> Eliminar</button>
                                </div>
                            </div>
                        </div>
                    )
                })}
            </div>
        )}

        {!loading && filteredCases.length === 0 && (<div className="flex flex-col items-center justify-center py-32 border border-dashed border-white/10 rounded-[3rem] bg-white/5 backdrop-blur-md"><div className="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mb-6 border border-white/5 shadow-xl"><ShieldAlert size={40} className="text-white/20" /></div><h3 className="text-white font-bold text-xl">Base de datos limpia</h3><p className="text-white/40 text-sm mt-2">No se encontraron registros activos con ese criterio.</p></div>)}

        {isModalOpen && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-xl animate-in fade-in duration-300">
              <div className="bg-[#050505]/90 backdrop-blur-2xl border border-white/10 w-full max-w-xl rounded-[2.5rem] shadow-2xl shadow-red-900/30 relative overflow-hidden flex flex-col max-h-[90vh] animate-in zoom-in-95">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent opacity-60" />
                  <div className="px-8 py-6 border-b border-white/5 bg-white/5 flex justify-between items-center sticky top-0 z-10 backdrop-blur-xl"><div><h2 className="text-xl font-black text-white flex items-center gap-3 uppercase tracking-tight"><span className="p-2.5 bg-red-500/10 rounded-xl border border-red-500/20 text-red-500 shadow-[0_0_15px_rgba(220,38,38,0.2)]"><FileWarning size={18}/></span> Nuevo Reporte</h2></div><button onClick={() => setIsModalOpen(false)} className="h-10 w-10 rounded-full bg-white/5 border border-white/5 flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 transition-all hover:scale-110"><X size={18}/></button></div>
                  <div className="p-8 overflow-y-auto custom-scrollbar space-y-6 bg-transparent relative z-10">
                      <div className="space-y-2"><Label>Sujeto del Reporte</Label><Input value={newCase.name} onChange={(e:any) => setNewCase({...newCase, name: e.target.value})} placeholder="Nombre Completo" icon={<UserX size={16}/>} /></div>
                      <div className="grid grid-cols-2 gap-4"><div className="space-y-2"><Label>RUT</Label><Input value={newCase.rut} onChange={(e:any) => setNewCase({...newCase, rut: formatRut(e.target.value)})} maxLength={12} placeholder="12.345.678-9" mono /></div><div className="space-y-2"><Label>Email</Label><Input type="email" value={newCase.email} onChange={(e:any) => setNewCase({...newCase, email: e.target.value})} placeholder="usuario@email.com" /></div></div>
                      <div className="space-y-3"><Label>Clasificación del Incidente</Label><div className="grid grid-cols-2 gap-3">{INCIDENT_TYPES.map(type => (<button key={type.id} onClick={() => setNewCase({...newCase, type: type.id})} className={`px-4 py-3.5 rounded-2xl border text-left text-[10px] font-bold uppercase tracking-wider transition-all flex items-center gap-3 ${newCase.type === type.id ? 'bg-red-500/10 border-red-500/50 text-red-500 shadow-[0_0_15px_rgba(220,38,38,0.15)] ring-1 ring-red-500/50' : 'bg-black/40 border-white/5 text-white/30 hover:bg-white/5 hover:text-white hover:border-white/10'}`}><div className={`w-2 h-2 shrink-0 rounded-full shadow-[0_0_5px_currentColor] ${type.dot}`} />{type.label}</button>))}</div></div>
                      <div className="space-y-2"><Label>Contexto</Label><div className="relative group"><select value={newCase.event} onChange={(e) => setNewCase({...newCase, event: e.target.value})} className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white focus:border-red-500 focus:bg-black/60 outline-none transition-all appearance-none cursor-pointer shadow-sm hover:border-white/20"><option value="" disabled>Seleccionar Evento...</option>{events.map((ev: any) => (<option key={ev.title} value={ev.title}>{ev.title}</option>))}<option value="Otro / Externo">Otro / Externo</option></select><ChevronDown size={16} className="absolute right-5 top-5 text-white/30 pointer-events-none group-hover:text-white transition-colors" /></div></div>
                      <div className="space-y-2"><Label>Evidencia / Notas</Label><textarea value={newCase.notes} onChange={(e) => setNewCase({...newCase, notes: e.target.value})} className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white focus:border-red-500 focus:bg-black/60 outline-none transition-all h-32 resize-none placeholder:text-white/20 shadow-sm hover:border-white/20" placeholder="Describa los hechos detalladamente..." /></div>
                  </div>
                  <div className="p-6 border-t border-white/5 bg-black/20 backdrop-blur-md"><button onClick={handleAddCase} disabled={submitting} className="w-full py-4 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-2xl transition-all shadow-[0_0_25px_rgba(220,38,38,0.4)] flex items-center justify-center gap-3 text-xs uppercase tracking-widest hover:scale-[1.02] active:scale-[0.98]">{submitting ? <span className="animate-pulse">Procesando...</span> : <><Lock size={16} /> Confirmar Bloqueo</>}</button></div>
              </div>
          </div>
        )}
    </div>
  )
}

function StatBadge({ label, count, color, icon }: any) { return <div className="flex items-center gap-3 px-2"><div className={`p-2 rounded-xl bg-white/5 ${color} shadow-sm border border-white/5`}>{icon}</div><div><p className="text-[9px] text-white/40 font-bold uppercase tracking-wider">{label}</p><p className={`text-lg font-black ${color} leading-none`}>{count}</p></div></div> }
function DataRow({ icon, label, value, mono }: any) { return <div className="flex justify-between items-center text-xs gap-3 w-full"><div className="flex items-center gap-1.5 text-white/40 shrink-0 font-bold uppercase tracking-wider text-[9px]">{icon} <span>{label}</span></div><span className={`text-white/80 font-medium text-right break-all flex-1 ${mono ? 'font-mono tracking-wider' : ''}`} title={value}>{value}</span></div> }
function Label({ children }: any) { return <label className="text-[10px] font-bold text-white/40 uppercase tracking-wider pl-1 flex items-center gap-1 ml-1">{children}</label> }
function Input({ icon, mono, ...props }: any) { return <div className="relative group">{icon && <div className="absolute left-5 top-4 text-white/30 pointer-events-none group-focus-within:text-white transition-colors">{icon}</div>}<input {...props} className={`w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3.5 text-sm text-white focus:border-red-500 focus:bg-black/60 outline-none transition-all placeholder:text-white/20 shadow-sm hover:border-white/20 ${icon ? 'pl-12' : ''} ${mono ? 'font-mono' : ''}`} /></div> }
</file>

<file path="app/(dashboard)/layout.tsx">
'use client'
import { LayoutDashboard, Ticket, BarChart3, Settings, User, LogOut, Plus, Bell, Check, ChevronDown, X, ShieldAlert } from 'lucide-react'
import Link from 'next/link'
import { usePathname, useRouter } from 'next/navigation'
import { supabase } from '@/lib/supabase'
import { useEffect, useState, useRef } from 'react'
import { OrgProvider, useOrg } from '@/components/providers/org-provider'

// ESTILOS GLOBALES DE SCROLLBAR
const customScrollbar = `
  .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); border-radius: 10px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
`

export default function DashboardLayout({ children }: { children: React.ReactNode }) {
  return (
    <OrgProvider>
      <DashboardContent>{children}</DashboardContent>
    </OrgProvider>
  )
}

function DashboardContent({ children }: { children: React.ReactNode }) {
  const pathname = usePathname()
  const router = useRouter()
  const [userData, setUserData] = useState<{ name: string; email: string } | null>(null)
  
  const { currentOrgId, availableOrgs, pendingInvites, switchOrg, createNewOrg, acceptInvite, rejectInvite, isLoading } = useOrg()
  const [isOrgDropdownOpen, setIsOrgDropdownOpen] = useState(false)
  const dropdownRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    async function getUser() {
      const { data: { user } } = await supabase.auth.getUser()
      if (user) {
        setUserData({
          name: user.user_metadata?.full_name || 'Productor DyzGO',
          email: user.email || ''
        })
      }
    }
    getUser()

    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOrgDropdownOpen(false)
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [])

  const handleLogout = async () => {
    await supabase.auth.signOut()
    router.push('/login')
    router.refresh()
  }

  const currentOrgName = availableOrgs.find((o: any) => o.id === currentOrgId)?.name || 'Sin Productora'
  const currentOrgRole = availableOrgs.find((o: any) => o.id === currentOrgId)?.is_owner ? '(Dueño)' : `(${availableOrgs.find((o: any) => o.id === currentOrgId)?.role})`

  if (pathname.includes('/events/create')) {
    return <>{children}</>
  }

  return (
    <div className="flex h-screen bg-[#030005] text-white font-sans selection:bg-purple-500/30 overflow-hidden">
      <style>{customScrollbar}</style>

      {/* --- FONDO GLOBAL (Cubre todo el layout, detrás del sidebar y contenido) --- */}
      <div className="absolute inset-0 z-0 pointer-events-none w-full h-full overflow-hidden">
          <div className="absolute inset-0 bg-[#030005]" />
          <div className="absolute top-[-20%] left-[-10%] w-[90vw] h-[90vw] bg-[radial-gradient(circle_at_center,rgba(88,28,135,0.4),transparent_70%)] blur-[100px] opacity-80 mix-blend-screen" />
          <div className="absolute top-[10%] right-[-10%] w-[70vw] h-[70vw] bg-[radial-gradient(circle_at_center,rgba(190,24,93,0.25),transparent_60%)] blur-[120px] opacity-80 mix-blend-screen" />
          <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-[0.04] mix-blend-overlay" />
      </div>
      
      {/* SIDEBAR (Con fondo semi-transparente para ver el fondo global) */}
      <aside className="w-64 border-r border-white/5 flex flex-col bg-[#09090b]/80 backdrop-blur-xl relative z-20">
        
        <div className="h-16 flex items-center px-6 border-b border-white/5 justify-between">
            <div>
                <span className="text-xl font-black tracking-tighter bg-gradient-to-r from-purple-400 to-blue-500 bg-clip-text text-transparent">
                    DYZGO+
                </span>
                <span className="text-[10px] ml-2 px-1.5 py-0.5 rounded bg-white/10 text-zinc-400 font-medium">
                    PRO
                </span>
            </div>
        </div>

        {pendingInvites?.length > 0 && (
            <div className="mx-4 mt-4 p-3 bg-purple-900/10 border border-purple-500/30 rounded-xl animate-in slide-in-from-left duration-300">
                <div className="flex items-center gap-2 mb-2 text-purple-400">
                    <Bell size={14} className="animate-bounce" />
                    <span className="text-[10px] font-bold uppercase tracking-wide">Invitación Pendiente</span>
                </div>
                {pendingInvites.map((inv) => (
                    <div key={inv.invite_id} className="flex justify-between items-center bg-black/40 p-2.5 rounded-lg mb-1 border border-white/5">
                        <div className="overflow-hidden">
                            <p className="text-xs font-bold text-white truncate max-w-[80px]">{inv.name}</p>
                            <p className="text-[10px] text-zinc-400 uppercase">{inv.role === 'finance' ? 'Finanzas' : inv.role}</p>
                        </div>
                        <div className="flex gap-1">
                            <button onClick={() => acceptInvite(inv.invite_id)} className="bg-green-600 hover:bg-green-500 text-white p-1.5 rounded-lg transition-colors shadow-lg shadow-green-900/20" title="Aceptar"><Check size={12} strokeWidth={3} /></button>
                            <button onClick={() => rejectInvite(inv.invite_id)} className="bg-red-600 hover:bg-red-500 text-white p-1.5 rounded-lg transition-colors shadow-lg shadow-red-900/20" title="Rechazar"><X size={12} strokeWidth={3} /></button>
                        </div>
                    </div>
                ))}
            </div>
        )}

        <div className="px-4 mt-6">
            <p className="px-2 text-[10px] font-bold text-zinc-500 uppercase tracking-wider mb-2">Viendo Datos De:</p>
            <div className="relative" ref={dropdownRef}>
                <button onClick={() => !isLoading && availableOrgs.length > 0 && setIsOrgDropdownOpen(!isOrgDropdownOpen)} disabled={isLoading || availableOrgs.length === 0} className={`w-full bg-zinc-900 border ${isOrgDropdownOpen ? 'border-purple-500' : 'border-white/10'} text-white text-xs font-bold rounded-lg p-3 outline-none flex justify-between items-center hover:bg-zinc-800 transition-all disabled:opacity-50 text-left`}>
                    <span className="truncate pr-2">{isLoading ? 'Cargando...' : (availableOrgs.length === 0 ? 'Sin Productora' : `${currentOrgName} ${currentOrgRole}`)}</span>
                    <ChevronDown size={14} className={`text-zinc-500 transition-transform duration-200 ${isOrgDropdownOpen ? 'rotate-180' : ''}`} />
                </button>

                {isOrgDropdownOpen && (
                    <div className="absolute top-full left-0 mt-2 w-full bg-[#09090b] border border-zinc-800 rounded-xl shadow-2xl z-50 overflow-hidden animate-in fade-in zoom-in-95 duration-200 max-h-64 overflow-y-auto custom-scrollbar">
                        <div className="p-1">
                            {availableOrgs.map((org: any) => (
                                <button key={org.id} onClick={() => { switchOrg(org.id); setIsOrgDropdownOpen(false); }} className={`w-full text-left px-3 py-2.5 rounded-lg text-xs font-medium transition-colors flex items-center justify-between mb-0.5 ${currentOrgId === org.id ? 'bg-purple-500/10 text-purple-400' : 'text-zinc-400 hover:bg-zinc-800 hover:text-white'}`}>
                                    <span className="truncate">{org.name || 'Sin Nombre'}</span>
                                    <span className="text-[9px] opacity-70 ml-2 whitespace-nowrap">{org.is_owner ? 'Dueño' : org.role}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                )}
            </div>
            
            {!isLoading && (
               <button onClick={createNewOrg} className="mt-3 text-[10px] text-purple-400 flex items-center gap-1 hover:underline px-2 w-full text-left font-bold"><Plus size={10} /> Crear Nueva Productora</button>
            )}
        </div>

        <nav className="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
            <p className="px-2 text-[10px] font-bold text-zinc-500 uppercase tracking-wider mb-2 mt-4">Principal</p>
            <SidebarLink href="/" icon={<LayoutDashboard size={18} />} label="Resumen" active={pathname === '/'} />
            <SidebarLink href="/events" icon={<Ticket size={18} />} label="Mis Eventos" active={pathname.includes('/events')} />
            <SidebarLink href="/finance" icon={<BarChart3 size={18} />} label="Analiticas" active={pathname.includes('/finance')} />
            
            <p className="px-2 text-[10px] font-bold text-zinc-500 uppercase tracking-wider mb-2 mt-8">Configuración</p>
            <SidebarLink href="/settings" icon={<Settings size={18} />} label="Cuenta" active={pathname.startsWith('/settings')} />
            <SidebarLink href="/team" icon={<ShieldAlert size={18} />} label="Blacklist" active={pathname.includes('/team')} />
        </nav>

        <div className="p-4 border-t border-white/5">
            <div onClick={handleLogout} className="flex items-center gap-3 p-2 rounded-xl hover:bg-red-500/10 transition-colors cursor-pointer group">
                <div className="h-9 w-9 rounded-full bg-gradient-to-tr from-purple-500 to-blue-500 flex-shrink-0" />
                <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-white truncate">{userData?.name || 'Cargando...'}</p>
                    <p className="text-xs text-zinc-500 truncate">{userData?.email || '...'}</p>
                </div>
                <LogOut size={16} className="text-zinc-500 group-hover:text-red-400 transition-colors" />
            </div>
        </div>
      </aside>

      {/* MAIN (Transparente para que se vea el fondo global) */}
      <main className="flex-1 relative z-10 overflow-y-auto custom-scrollbar">
        <div className="p-8">
            {children}
        </div>
      </main>

    </div>
  )
}

function SidebarLink({ href, icon, label, active }: any) {
    return (
        <Link href={href} className={`flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group ${active ? 'bg-white text-black font-medium shadow-[0_0_15px_rgba(255,255,255,0.1)]' : 'text-zinc-400 hover:text-white hover:bg-white/5'}`}>
            {icon}
            <span className="text-sm">{label}</span>
        </Link>
    )
}
</file>

<file path="app/(dashboard)/page.tsx">
'use client'
import { useEffect, useState, useCallback } from 'react'
import Link from 'next/link'
import { 
  TrendingUp, Wallet, Plus, Users, 
  ShoppingCart, ChevronRight, Bell, TicketPercent,
  AlertCircle, FileText, RefreshCcw, CheckCircle2,
  Megaphone, Clock, Sparkles, ArrowUpRight
} from 'lucide-react'
import { supabase } from '@/lib/supabase'
import { useOrg } from '@/components/providers/org-provider'
import { differenceInDays, formatDistanceToNow, subHours } from 'date-fns'
import { es } from 'date-fns/locale'

// ESTILOS PARA SCROLLBAR PERSONALIZADO
const customScrollbar = `
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
  }
`

export default function GeneralDashboard() {
  const { currentOrgId } = useOrg()
  const [loading, setLoading] = useState(true)
  const [userName, setUserName] = useState('Productor') 
  
  const [globalStats, setGlobalStats] = useState({
    balanceAvailable: 0,
    balancePending: 0,
    totalSalesMonth: 0,
    salesTrend: 0, 
    activeEventsCount: 0
  })

  const [nextEvent, setNextEvent] = useState<any>(null)
  const [recentSales, setRecentSales] = useState<any[]>([])
  const [activeEventsMatrix, setActiveEventsMatrix] = useState<any[]>([])
  const [realAlerts, setRealAlerts] = useState<any[]>([])

  const fetchData = useCallback(async () => {
    if (!currentOrgId) return
    setLoading(true)

    try {
        const { data: { user } } = await supabase.auth.getUser()
        if (user) {
            const { data: profile } = await supabase
                .from('profiles')
                .select('full_name')
                .eq('id', user.id)
                .single()
            
            if (profile?.full_name) {
                setUserName(profile.full_name.split(' ')[0])
            }
        }

        const { data: eventsData } = await supabase
            .from('events')
            .select('*, ticket_tiers(total_stock)')
            .eq('experience_id', currentOrgId)
            .neq('status', 'draft') 
            .order('date', { ascending: true })

        if (!eventsData) return

        const eventIds = eventsData.map(e => e.id)
        const { data: ticketsData } = await supabase
            .from('tickets')
            .select(`
                id, paid_price, status, created_at, event_id, guest_name,
                profiles:user_id ( full_name, email ),
                ticket_tiers ( name, price, total_stock ) 
            `)
            .in('event_id', eventIds)
            .neq('status', 'refunded')
            .order('created_at', { ascending: false }) 

        if (ticketsData) {
            const totalRevenue = ticketsData.reduce((sum, t) => {
                let price = Number(t.paid_price)
                if (!price || price === 0) price = Number(t.ticket_tiers?.price) || 0
                return sum + price
            }, 0)
            
            setGlobalStats(prev => ({
                ...prev,
                balanceAvailable: totalRevenue,
                activeEventsCount: eventsData.length,
                salesTrend: 12 
            }))

            const upcoming = eventsData.filter(e => new Date(e.date) >= new Date(new Date().setHours(0,0,0,0)))
            const next = upcoming.length > 0 ? upcoming[0] : null

            if (next) {
                const nextEvtTickets = ticketsData.filter(t => t.event_id === next.id)
                const sold = nextEvtTickets.length
                const totalStock = next.ticket_tiers?.reduce((acc: number, tier: any) => acc + (tier.total_stock || 0), 0) || 0
                
                setNextEvent({
                    ...next,
                    sold,
                    stock: totalStock,
                    percentage: totalStock > 0 ? Math.min(100, (sold / totalStock) * 100) : 0
                })
            } else {
                setNextEvent(null)
            }

            setRecentSales(ticketsData.slice(0, 5).map(t => {
                const eventName = eventsData.find(e => e.id === t.event_id)?.title || 'Evento'
                let displayPrice = Number(t.paid_price)
                if (!displayPrice || displayPrice === 0) displayPrice = Number(t.ticket_tiers?.price) || 0

                return {
                    id: t.id,
                    name: t.profiles?.full_name || t.guest_name || 'Anónimo',
                    tier: t.ticket_tiers?.name || 'General',
                    eventTitle: eventName, 
                    price: displayPrice,
                    timeAgo: formatDistanceToNow(new Date(t.created_at), { addSuffix: true, locale: es })
                }
            }))

            const matrix = eventsData.slice(0, 5).map(evt => {
                const evtTickets = ticketsData.filter(t => t.event_id === evt.id)
                const revenue = evtTickets.reduce((sum, t) => {
                    let price = Number(t.paid_price)
                    if (!price || price === 0) price = Number(t.ticket_tiers?.price) || 0
                    return sum + price
                }, 0)

                return {
                    id: evt.id,
                    title: evt.title,
                    image_url: evt.image_url,
                    status: new Date(evt.date) < new Date() ? 'Finalizado' : 'Activo',
                    sold: evtTickets.length,
                    revenue
                }
            })
            setActiveEventsMatrix(matrix)

            const alerts = []
            const now = new Date()

            const salesLast24h = ticketsData.filter(t => new Date(t.created_at) > subHours(now, 24)).length
            if (salesLast24h === 0 && eventsData.length > 0) {
                alerts.push({
                    type: 'stalled',
                    label: 'Ventas detenidas',
                    sub: '0 ventas en las últimas 24h.',
                    urgent: true,
                    icon: Megaphone,
                    color: 'text-orange-400'
                })
            }

            eventsData.forEach(evt => {
                const evtTickets = ticketsData.filter(t => t.event_id === evt.id)
                const sold = evtTickets.length
                const stock = evt.ticket_tiers?.reduce((acc: number, tier: any) => acc + (tier.total_stock || 0), 0) || 100
                const daysLeft = differenceInDays(new Date(evt.date), now)
                const occupancy = (sold / stock) * 100

                if (daysLeft >= 0 && daysLeft < 7 && occupancy < 20) {
                    alerts.push({
                        type: 'low_sales',
                        label: `Baja venta: ${evt.title}`,
                        sub: `Solo ${occupancy.toFixed(0)}% vendido.`,
                        urgent: true,
                        icon: AlertCircle,
                        color: 'text-[#FF007F]'
                    })
                }

                if (daysLeft >= 0 && occupancy > 90 && occupancy < 100) {
                    alerts.push({
                        type: 'sold_out_soon',
                        label: `Sold Out cerca: ${evt.title}`,
                        sub: `Quedan ${stock - sold} tickets.`,
                        urgent: false,
                        icon: TicketPercent,
                        color: 'text-[#8A2BE2]'
                    })
                }
            })

            setRealAlerts(alerts)
        }

    } catch (error) {
        console.error("Error cargando dashboard:", error)
    } finally {
        setLoading(false)
    }
  }, [currentOrgId])

  useEffect(() => {
    fetchData()
  }, [fetchData])

  return (
    // CONTENEDOR LIMPIO (Sin fondo, ya está en el Layout)
    <div className="relative z-10 max-w-[1600px] mx-auto space-y-6 pt-2">
      <style>{customScrollbar}</style>
      
      {/* 1. HEADER */}
      <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 pt-2">
          <div>
              <h1 className="text-4xl md:text-5xl font-black tracking-tighter text-white">
                  Hola, <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#8A2BE2] to-[#FF007F]">{userName}.</span>
              </h1>
              <p className="text-white/40 text-sm font-medium mt-2 max-w-lg">
                  Acá podrás ver el resumen de tus eventos. Para ver información más detallada, anda a la sección de analíticas.
              </p>
          </div>
          
          <div className="flex gap-3">
              <button className="h-12 w-12 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 transition-colors flex items-center justify-center relative group backdrop-blur-md">
                  <Bell size={20} className="text-white/60 group-hover:text-white transition-colors" />
                  {realAlerts.filter(t => t.urgent).length > 0 && (
                      <span className="absolute top-3 right-3 w-2 h-2 bg-[#FF007F] rounded-full shadow-[0_0_10px_#FF007F]"></span>
                  )}
              </button>
              <Link 
                  href="/events/create" 
                  className="h-12 px-6 rounded-2xl bg-white text-black font-bold text-sm uppercase tracking-wider hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center gap-2 shadow-[0_0_20px_rgba(255,255,255,0.1)]"
              >
                  <Plus size={18} /> Nuevo Evento
              </Link>
          </div>
      </div>

      {/* 2. BENTO GRID */}
      <div className="grid grid-cols-1 md:grid-cols-12 gap-6">

          {/* A. BILLETERA */}
          <div className="md:col-span-4 bg-white/5 backdrop-blur-2xl border border-white/10 rounded-[2rem] p-8 flex flex-col justify-between relative overflow-hidden group min-h-[240px] shadow-2xl shadow-purple-900/10">
              <div className="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-[#00D15B]/30 to-transparent rounded-full blur-[60px] opacity-50 group-hover:opacity-100 transition-opacity" />
              
              <div className="relative z-10">
                  <div className="flex justify-between items-start mb-6">
                      <div className="h-12 w-12 rounded-2xl bg-gradient-to-br from-[#00D15B]/20 to-transparent border border-white/10 flex items-center justify-center">
                          <Wallet className="text-[#00D15B]" size={24} />
                      </div>
                      <span className="text-[10px] font-bold uppercase tracking-widest bg-[#00D15B]/10 text-[#00D15B] px-3 py-1.5 rounded-full border border-[#00D15B]/20 backdrop-blur-md">
                          Disponible
                      </span>
                  </div>
                  
                  <div>
                      <p className="text-white/40 text-xs font-bold uppercase tracking-widest mb-2">Ingresos Totales</p>
                      <h2 className="text-5xl font-black text-white tracking-tighter">
                          {loading ? '...' : `$${globalStats.balanceAvailable.toLocaleString('es-CL')}`}
                      </h2>
                  </div>
              </div>

              <div className="relative z-10 mt-6 pt-6 border-t border-white/5 flex justify-between items-center">
                  <div>
                      <p className="text-white/30 text-[10px] uppercase font-bold tracking-widest">Eventos Activos</p>
                      <p className="text-white font-mono text-lg">{globalStats.activeEventsCount}</p>
                  </div>
                  <button className="text-xs font-bold text-white/60 hover:text-white bg-white/5 hover:bg-white/10 px-4 py-2 rounded-xl transition-all border border-white/5 uppercase tracking-wide backdrop-blur-md">
                      Retirar
                  </button>
              </div>
          </div>

          {/* B. NEXT EVENT */}
          <div className="md:col-span-5 bg-black/40 border border-white/10 rounded-[2rem] relative overflow-hidden flex flex-col justify-between min-h-[240px] group shadow-2xl shadow-purple-900/10">
              {nextEvent?.image_url ? (
                  <>
                      <div className="absolute inset-0 bg-cover bg-center transition-transform duration-[2s] group-hover:scale-105 opacity-60" style={{ backgroundImage: `url(${nextEvent.image_url})` }} />
                      <div className="absolute inset-0 bg-gradient-to-t from-[#030005] via-[#030005]/80 to-transparent" />
                  </>
              ) : (
                  <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-5" />
              )}

              <div className="relative z-20 p-8 flex flex-col h-full justify-between">
                  <div className="flex justify-between items-start">
                      <div>
                          <div className="flex items-center gap-2 mb-3">
                              <span className="relative flex h-2 w-2">
                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#FF007F] opacity-75"></span>
                                <span className="relative inline-flex rounded-full h-2 w-2 bg-[#FF007F]"></span>
                              </span>
                              <span className="text-[#FF007F] text-[10px] font-bold uppercase tracking-[0.2em]">Próximo</span>
                          </div>
                          <h3 className="text-3xl font-black text-white leading-none max-w-sm line-clamp-2">
                              {loading ? 'Cargando...' : (nextEvent?.title || 'Sin eventos')}
                          </h3>
                      </div>
                      {nextEvent && (
                          <div className="text-right bg-white/5 backdrop-blur-md px-4 py-2 rounded-2xl border border-white/10">
                              <span className="block text-2xl font-black text-white">{differenceInDays(new Date(nextEvent.date), new Date())}</span>
                              <span className="text-[9px] text-white/50 uppercase font-bold tracking-wider">Días</span>
                          </div>
                      )}
                  </div>

                  {nextEvent ? (
                      <div className="space-y-4">
                          <div>
                              <div className="flex justify-between text-xs font-bold text-white/50 mb-2 uppercase tracking-wide">
                                  <span>Ventas: {nextEvent.sold}</span>
                                  <span className="text-white">{nextEvent.percentage?.toFixed(0)}% Sold</span>
                              </div>
                              <div className="h-2 w-full bg-white/10 rounded-full overflow-hidden backdrop-blur-md">
                                  <div className="h-full bg-gradient-to-r from-[#FF007F] to-[#8A2BE2]" style={{ width: `${nextEvent.percentage}%` }} />
                              </div>
                          </div>
                          <div className="grid grid-cols-2 gap-3">
                              <Link href={`/events/create?id=${nextEvent.id}&tab=tickets`} className="bg-white text-black text-center py-3 rounded-xl text-xs font-bold hover:scale-[1.02] transition-transform uppercase tracking-wider shadow-lg">
                                  Tickets
                              </Link>
                              <Link href={`/events/${nextEvent.id}`} className="bg-white/10 text-white backdrop-blur-md text-center py-3 rounded-xl text-xs font-bold hover:bg-white/20 transition-colors border border-white/10 uppercase tracking-wider">
                                  Dashboard
                              </Link>
                          </div>
                      </div>
                  ) : (
                      <div className="mt-auto text-white/40 text-sm font-medium">
                          No tienes eventos activos próximos.
                      </div>
                  )}
              </div>
          </div>

          {/* C. ALERTAS */}
          <div className="md:col-span-3 flex flex-col h-[240px]">
              <div className="flex-1 bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-6 flex flex-col relative overflow-hidden shadow-2xl shadow-purple-900/10">
                  <div className="flex justify-between items-center mb-6">
                      <h3 className="text-xs font-bold text-white/60 uppercase tracking-widest flex items-center gap-2">
                          <AlertCircle size={14} className="text-[#FF007F]"/> Alertas
                      </h3>
                  </div>
                  
                  <div className="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1">
                      {realAlerts.length > 0 ? realAlerts.map((task, i) => (
                          <div key={i} className="flex items-start gap-3 p-3 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 transition-colors cursor-pointer group backdrop-blur-sm">
                              <div className={`p-2 rounded-xl bg-white/5 border border-white/5 ${task.color} shrink-0`}>
                                  <task.icon size={14} />
                              </div>
                              <div>
                                  <p className="text-xs font-bold text-white group-hover:text-[#FF007F] transition-colors leading-tight mb-1">{task.label}</p>
                                  <p className="text-[10px] text-white/40 leading-tight">{task.sub}</p>
                              </div>
                          </div>
                      )) : (
                          <div className="h-full flex flex-col items-center justify-center text-center text-white/20 gap-3">
                              <CheckCircle2 size={32} />
                              <p className="text-xs font-medium">Todo limpio.</p>
                          </div>
                      )}
                  </div>
              </div>
          </div>

          {/* D. LIVE SALES FEED */}
          <div className="md:col-span-4 bg-white/5 backdrop-blur-2xl border border-white/10 rounded-[2rem] p-8 flex flex-col h-[280px] shadow-2xl shadow-purple-900/10">
              <div className="flex justify-between items-center mb-6">
                  <h3 className="text-xs font-bold text-white/60 uppercase tracking-widest flex items-center gap-2">
                      <ShoppingCart size={14} className="text-[#8A2BE2]"/> Live Feed
                  </h3>
                  <div className="flex items-center gap-1.5 px-2 py-1 rounded-full bg-[#00D15B]/10 border border-[#00D15B]/20 backdrop-blur-md">
                      <span className="w-1.5 h-1.5 bg-[#00D15B] rounded-full animate-pulse"/>
                      <span className="text-[9px] font-bold text-[#00D15B] uppercase tracking-wider">En Vivo</span>
                  </div>
              </div>

              <div className="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                  {recentSales.length > 0 ? recentSales.map((sale, i) => (
                      <div key={i} className="flex items-center gap-4 p-3 rounded-2xl bg-white/[0.02] border border-white/5 hover:bg-white/[0.05] transition-colors group backdrop-blur-sm">
                          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-white/10 to-transparent border border-white/10 flex items-center justify-center text-xs font-bold text-white/50 group-hover:text-white transition-colors shrink-0">
                              {sale.name.substring(0,2).toUpperCase()}
                          </div>
                          <div className="flex-1 min-w-0">
                              <p className="text-xs font-bold text-white truncate">{sale.name}</p>
                              <p className="text-[10px] text-white/40 font-medium truncate">{sale.eventTitle}</p>
                          </div>
                          <div className="text-right">
                              <span className="block text-xs font-mono text-[#00D15B] font-bold">+${sale.price.toLocaleString()}</span>
                              <p className="text-[9px] text-white/20">{sale.timeAgo}</p>
                          </div>
                      </div>
                  )) : (
                      <div className="h-full flex items-center justify-center text-white/20 text-xs font-medium">
                          Esperando ventas...
                      </div>
                  )}
              </div>
          </div>

          {/* E. PERFORMANCE MATRIX */}
          <div className="md:col-span-8 bg-white/5 backdrop-blur-2xl border border-white/10 rounded-[2rem] p-8 h-[280px] flex flex-col shadow-2xl shadow-purple-900/10">
              <div className="flex justify-between items-center mb-6">
                  <h3 className="text-xs font-bold text-white/60 uppercase tracking-widest flex items-center gap-2">
                      <TrendingUp size={14} className="text-blue-400"/> Rendimiento
                  </h3>
                  <Link href="/events" className="text-[10px] font-bold text-white/40 hover:text-white flex items-center gap-1 uppercase tracking-wider transition-colors">
                      Ver todo <ArrowUpRight size={12}/>
                  </Link>
              </div>
              
              <div className="overflow-x-auto flex-1 custom-scrollbar">
                  <table className="w-full text-left">
                      <thead className="text-[10px] uppercase font-bold text-white/30 border-b border-white/5 tracking-wider">
                          <tr>
                              <th className="pb-4 pl-2 font-medium">Evento</th>
                              <th className="pb-4 text-center font-medium">Estado</th>
                              <th className="pb-4 text-right font-medium">Ventas</th>
                              <th className="pb-4 text-right font-medium">Ingresos</th>
                              <th className="pb-4 text-right font-medium"></th>
                          </tr>
                      </thead>
                      <tbody className="divide-y divide-white/5">
                          {activeEventsMatrix.map((evt, i) => (
                              <tr key={i} className="group hover:bg-white/[0.02] transition-colors">
                                  <td className="py-4 pl-2 font-bold text-sm text-white flex items-center gap-4">
                                      <div className="h-8 w-8 rounded-lg bg-zinc-800 overflow-hidden border border-white/10">
                                          {evt.image_url && <img src={evt.image_url} alt="" className="h-full w-full object-cover" />}
                                      </div>
                                      {evt.title}
                                  </td>
                                  <td className="py-4 text-center">
                                      <span className={`px-2 py-1 rounded-lg text-[9px] font-bold uppercase tracking-wider border backdrop-blur-md ${
                                          evt.status === 'Activo' 
                                          ? 'bg-[#00D15B]/10 text-[#00D15B] border-[#00D15B]/20' 
                                          : 'bg-white/5 text-white/40 border-white/10'
                                      }`}>
                                          {evt.status}
                                      </span>
                                  </td>
                                  <td className="py-4 text-right text-xs font-bold text-white/60">{evt.sold}</td>
                                  <td className="py-4 text-right font-mono text-white text-xs font-bold tracking-tight">${evt.revenue.toLocaleString()}</td>
                                  <td className="py-4 text-right">
                                      <Link href={`/events/${evt.id}`} className="h-8 w-8 rounded-lg bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/40 hover:text-white transition-all ml-auto border border-white/5 backdrop-blur-md">
                                          <ChevronRight size={14} />
                                      </Link>
                                  </td>
                              </tr>
                          ))}
                      </tbody>
                  </table>
              </div>
          </div>

      </div>
    </div>
  )
}
</file>

<file path="app/onboarding/page.tsx">
'use client'

import { useState, useRef } from 'react'
import { useRouter } from 'next/navigation'
// Importamos el cliente ya inicializado desde tu librería
import { supabase } from '@/lib/supabase'
import { Sparkles, ArrowRight, Loader2, Building2, Globe, Instagram, Palette, Upload, Image as ImageIcon, Camera } from 'lucide-react'

export default function OnboardingPage() {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  
  // --- CORRECCIÓN: Eliminamos "const supabase = createClient()" ---
  // Ahora usamos directamente la variable 'supabase' importada arriba.
  
  // Referencias para los inputs
  const logoInputRef = useRef<HTMLInputElement>(null)
  const bannerInputRef = useRef<HTMLInputElement>(null)
  const colorInputRef = useRef<HTMLInputElement>(null)

  // Estados de Texto
  const [name, setName] = useState('')
  const [description, setDescription] = useState('')
  const [website, setWebsite] = useState('')
  const [instagram, setInstagram] = useState('')
  const [color, setColor] = useState('#8B5CF6')

  // Estados de Imágenes
  const [logoFile, setLogoFile] = useState<File | null>(null)
  const [logoPreview, setLogoPreview] = useState<string | null>(null)
  
  const [bannerFile, setBannerFile] = useState<File | null>(null)
  const [bannerPreview, setBannerPreview] = useState<string | null>(null)

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, type: 'logo' | 'banner') => {
    const file = e.target.files?.[0]
    if (!file) return

    const previewUrl = URL.createObjectURL(file)

    if (type === 'logo') {
        setLogoFile(file)
        setLogoPreview(previewUrl)
    } else {
        setBannerFile(file)
        setBannerPreview(previewUrl)
    }
  }

  // --- FUNCIÓN DE CREACIÓN ---
  const handleCreateExperience = async (e: React.FormEvent) => {
    e.preventDefault()
    
    if (!name.trim()) return alert("El nombre de la productora es obligatorio.")
    if (!description.trim()) return alert("La descripción es obligatoria.")
    if (!logoFile) return alert("Debes subir un Logo para tu productora.")

    setLoading(true)
    try {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) throw new Error("No hay usuario autenticado")

      let finalLogoUrl = null
      let finalBannerUrl = null

      // 1. Subir Logo
      const logoExt = logoFile.name.split('.').pop()
      const logoPath = `${user.id}/${Date.now()}_logo.${logoExt}`
      
      // Asegúrate de que el bucket 'logos' exista en Supabase Storage y sea público
      const { error: logoError } = await supabase.storage.from('logos').upload(logoPath, logoFile)
      if (logoError) throw logoError
      
      const { data: logoUrlData } = supabase.storage.from('logos').getPublicUrl(logoPath)
      finalLogoUrl = logoUrlData.publicUrl

      // 2. Subir Banner (Opcional)
      if (bannerFile) {
          const bannerExt = bannerFile.name.split('.').pop()
          const bannerPath = `${user.id}/${Date.now()}_banner.${bannerExt}`
          
          // Asegúrate de que el bucket 'flyers' (o 'banners') exista
          const { error: bannerError } = await supabase.storage.from('flyers').upload(bannerPath, bannerFile)
          if (!bannerError) {
              const { data: bannerUrlData } = supabase.storage.from('flyers').getPublicUrl(bannerPath)
              finalBannerUrl = bannerUrlData.publicUrl
          }
      }

      // 3. Insertar Experience
      const { error: expError } = await supabase
        .from('experiences')
        .insert([{
          name: name,
          description: description,
          website_url: website || null,
          instagram_handle: instagram || null,
          primary_color: color,
          producer_id: user.id,
          logo_url: finalLogoUrl,
          banner_url: finalBannerUrl
        }])

      if (expError) throw expError

      // 4. Redirección y Refresco
      router.refresh()
      // Forzamos recarga completa para que el OrgProvider detecte la nueva productora
      window.location.href = '/'

    } catch (error: any) {
      console.error(error)
      alert("Error: " + error.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-[#030005] font-sans text-white relative overflow-hidden selection:bg-[#FF007F]/30 p-6">
      
      {/* FONDO */}
      <div className="fixed inset-0 z-0 pointer-events-none">
          <div className="absolute inset-0 bg-[#030005]" />
          <div className="absolute top-[-10%] left-[-10%] w-[60vw] h-[60vw] bg-[#8A2BE2]/20 rounded-full blur-[120px] animate-pulse" />
          <div className="absolute bottom-[-10%] right-[-10%] w-[60vw] h-[60vw] bg-[#FF007F]/10 rounded-full blur-[120px]" />
      </div>

      <div className="relative z-10 w-full max-w-2xl animate-in fade-in zoom-in-95 duration-500">
        
        <div className="text-center mb-8">
            <div className="inline-flex h-12 w-12 bg-white/10 rounded-2xl items-center justify-center mb-4 border border-white/10 shadow-lg shadow-purple-500/20">
                <Sparkles size={24} className="text-[#FF007F]" />
            </div>
            <h1 className="text-4xl font-black text-white mb-2 tracking-tight">Tu Productora</h1>
            <p className="text-white/40 text-sm font-medium">Configura la identidad pública de tu organización.</p>
        </div>

        <form onSubmit={handleCreateExperience} className="space-y-6">
            
            {/* SECCIÓN VISUAL HEADER */}
            <div className="bg-white/5 backdrop-blur-3xl border border-white/10 rounded-[2rem] overflow-visible relative group shadow-2xl mb-8 flex flex-col items-center">
                
                {/* BANNER */}
                <div 
                    className="h-32 w-full bg-black/40 relative cursor-pointer hover:bg-white/5 transition-all group/banner rounded-t-[2rem] overflow-hidden"
                    onClick={() => bannerInputRef.current?.click()}
                >
                    {bannerPreview ? (
                        <img src={bannerPreview} className="w-full h-full object-cover opacity-80" alt="Banner Preview" />
                    ) : (
                        <div className="absolute inset-0 flex items-center justify-center text-white/30 gap-2 group-hover/banner:text-white transition-colors">
                            <ImageIcon size={24} /> 
                            <span className="text-xs font-bold uppercase tracking-widest">Subir Banner (Opcional)</span>
                        </div>
                    )}
                    <input type="file" ref={bannerInputRef} onChange={(e) => handleFileChange(e, 'banner')} className="hidden" accept="image/*" />
                </div>

                {/* LOGO */}
                <div className="absolute top-20 left-1/2 -translate-x-1/2 z-20">
                    <div 
                        className={`h-24 w-24 rounded-3xl bg-[#1a1a1a] border-4 border-[#030005] shadow-2xl flex items-center justify-center cursor-pointer hover:border-[#8A2BE2] transition-all relative group/logo ${!logoPreview ? 'animate-pulse' : ''}`}
                        onClick={() => logoInputRef.current?.click()}
                    >
                        {logoPreview ? (
                            <img src={logoPreview} className="w-full h-full object-cover rounded-[1.3rem]" alt="Logo Preview" />
                        ) : (
                            <div className="text-white/40 flex flex-col items-center gap-1 group-hover/logo:text-white transition-colors">
                                <Upload size={20} />
                                <span className="text-[8px] font-black uppercase text-[#8A2BE2]">Logo</span>
                            </div>
                        )}
                        <div className="absolute -bottom-2 -right-2 bg-[#8A2BE2] p-1.5 rounded-full border-4 border-[#030005] shadow-sm">
                           <Camera size={14} className="text-white" />
                        </div>
                        <input type="file" ref={logoInputRef} onChange={(e) => handleFileChange(e, 'logo')} className="hidden" accept="image/*" />
                    </div>
                </div>

                {/* NOMBRE */}
                <div className="mt-14 mb-6 text-center px-6">
                    <h3 className="text-2xl font-black text-white uppercase tracking-tight line-clamp-1">
                        {name || 'TU PRODUCTORA'}
                    </h3>
                </div>
            </div>

            {/* SECCIÓN DATOS */}
            <div className="bg-white/5 backdrop-blur-3xl border border-white/10 rounded-[2rem] p-8">
                <h3 className="text-xs font-black text-[#8A2BE2] uppercase tracking-widest mb-6 flex items-center gap-2">
                    <Building2 size={14}/> Identidad (Obligatorio)
                </h3>
                <div className="space-y-5">
                    <div className="space-y-2">
                        <label className="text-[10px] font-bold text-white/30 uppercase tracking-widest ml-1">Nombre Fantasía <span className="text-[#FF007F]">*</span></label>
                        <input 
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="Ej: DyzGO Producciones"
                            className="w-full bg-black/40 border border-white/10 rounded-xl py-4 px-5 text-white placeholder:text-white/10 focus:outline-none focus:border-[#FF007F]/50 transition-all font-bold"
                            required
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-[10px] font-bold text-white/30 uppercase tracking-widest ml-1">Descripción <span className="text-[#FF007F]">*</span></label>
                        <textarea 
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            placeholder="Breve reseña sobre la productora..."
                            rows={3}
                            className="w-full bg-black/40 border border-white/10 rounded-xl p-5 text-white placeholder:text-white/10 focus:outline-none focus:border-[#FF007F]/50 transition-all font-medium resize-none"
                            required
                        />
                    </div>
                </div>
            </div>

            {/* SECCIONES DIGITAL Y ESTILO */}
            <div className="grid md:grid-cols-2 gap-6">
                <div className="bg-white/5 backdrop-blur-3xl border border-white/10 rounded-[2rem] p-8">
                    <h3 className="text-xs font-black text-[#3b82f6] uppercase tracking-widest mb-6 flex items-center gap-2">
                        <Globe size={14}/> Digital (Opcional)
                    </h3>
                    <div className="space-y-5">
                        <div className="space-y-2">
                            <label className="text-[10px] font-bold text-white/30 uppercase tracking-widest ml-1">Sitio Web</label>
                            <input value={website} onChange={(e) => setWebsite(e.target.value)} placeholder="https://tuweb.cl" className="w-full bg-black/40 border border-white/10 rounded-xl py-3 px-4 text-sm text-white placeholder:text-white/10 focus:outline-none focus:border-[#3b82f6]/50 transition-all"/>
                        </div>
                        <div className="space-y-2">
                            <label className="text-[10px] font-bold text-white/30 uppercase tracking-widest ml-1">Instagram (@)</label>
                            <div className="relative">
                                <Instagram size={16} className="absolute left-4 top-3.5 text-white/20" />
                                <input value={instagram} onChange={(e) => setInstagram(e.target.value)} placeholder="tu_productora" className="w-full bg-black/40 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-sm text-white placeholder:text-white/10 focus:outline-none focus:border-[#3b82f6]/50 transition-all"/>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="bg-white/5 backdrop-blur-3xl border border-white/10 rounded-[2rem] p-8">
                    <h3 className="text-xs font-black text-[#FF007F] uppercase tracking-widest mb-6 flex items-center gap-2">
                        <Palette size={14}/> Estilo (Opcional)
                    </h3>
                    <div className="space-y-2">
                        <label className="text-[10px] font-bold text-white/30 uppercase tracking-widest ml-1">Color Principal</label>
                        <div className="flex items-center gap-3 bg-black/40 border border-white/10 rounded-xl p-2 pr-4">
                            <div className="h-10 w-10 rounded-lg shadow-inner transition-colors duration-300 cursor-pointer border border-white/10 hover:scale-105 relative overflow-hidden" style={{ backgroundColor: color }} onClick={() => colorInputRef.current?.click()}>
                                <input type="color" ref={colorInputRef} value={color} onChange={(e) => setColor(e.target.value)} className="opacity-0 absolute inset-0 w-full h-full cursor-pointer"/>
                            </div>
                            <input value={color} onChange={(e) => setColor(e.target.value)} placeholder="#8B5CF6" className="flex-1 bg-transparent border-none text-white font-mono font-bold focus:outline-none uppercase" maxLength={7}/>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" disabled={loading} className="w-full py-5 rounded-2xl font-black text-sm uppercase tracking-[0.2em] text-white relative group overflow-hidden transition-all hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50 shadow-2xl shadow-purple-900/40">
                <div className="absolute inset-0 bg-gradient-to-r from-[#8A2BE2] to-[#FF007F]" />
                <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 mix-blend-overlay" />
                <div className="relative flex items-center justify-center gap-3">
                    {loading ? <Loader2 className="animate-spin" size={20} /> : <>Crear y Comenzar <ArrowRight size={20} /></>}
                </div>
            </button>

        </form>
      </div>
    </div>
  )
}
</file>

<file path="app/not-found.tsx">
import Link from 'next/link'
import { ArrowLeft, Ghost } from 'lucide-react'

export default function NotFound() {
  return (
    <div className="h-screen w-full flex flex-col items-center justify-center bg-black text-white relative overflow-hidden">
      
      {/* Fondo Ambientación */}
      <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-purple-900/40 via-black to-black"></div>
      
      <div className="relative z-10 text-center px-4">
        <div className="inline-flex p-4 bg-zinc-900 rounded-full mb-6 border border-zinc-800 shadow-xl shadow-purple-900/20">
            <Ghost size={40} className="text-purple-500 animate-bounce" />
        </div>
        
        <h1 className="text-9xl font-black text-white tracking-tighter opacity-50 select-none">404</h1>
        <h2 className="text-2xl font-bold text-white -mt-4 mb-2">Aquí no está la fiesta</h2>
        <p className="text-zinc-400 max-w-md mx-auto mb-8">
            Parece que te perdiste en el backstage. Esta página no existe o fue eliminada.
        </p>

        <Link href="/">
            <button className="px-8 py-3 bg-white text-black font-bold rounded-xl hover:scale-105 transition-transform flex items-center gap-2 mx-auto">
                <ArrowLeft size={18} />
                Volver al Dashboard
            </button>
        </Link>
      </div>

    </div>
  )
}
</file>

<file path="components/hud/DescriptionPanel.tsx">
export default function ExperiencePanel() {
  return (
    <div className="space-y-6 animate-in fade-in">
       <div className="grid grid-cols-2 gap-4">
          <div className="space-y-2">
            <label className="text-xs font-bold text-zinc-500 uppercase">Edad Mín. Hombres</label>
            <input type="number" className="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3" placeholder="21" />
          </div>
          <div className="space-y-2">
            <label className="text-xs font-bold text-zinc-500 uppercase">Edad Mín. Mujeres</label>
            <input type="number" className="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3" placeholder="18" />
          </div>
       </div>
       {/* Tags de Música y Prohibidos aquí */}
    </div>
  )
}
</file>

<file path="components/hud/DesignPanel.tsx">
'use client'
import { useEventStore } from '@/store/useEventStore'
import { ImageIcon, Palette, UploadCloud, MousePointerClick, Layers } from 'lucide-react'
import { useRef, useState, useEffect } from 'react'
import { HexColorPicker } from 'react-colorful'

export default function DesignPanel() {
  // @ts-ignore
  const { eventData, setThemeColor, setThemeColorEnd, setCardBackgroundColor, setBorderColor, setAccentColor, setCoverImage } = useEventStore()
  const fileInputRef = useRef<HTMLInputElement>(null)
  
  // Estados para los pickers
  const [showStartPicker, setShowStartPicker] = useState(false)
  const [showEndPicker, setShowEndPicker] = useState(false)
  const [showCardBgPicker, setShowCardBgPicker] = useState(false)
  const [showBorderPicker, setShowBorderPicker] = useState(false)
  const [showAccentPicker, setShowAccentPicker] = useState(false)

  // Valores
  const themeColorEnd = (eventData as any).themeColorEnd || '#090014';
  const cardBgColor = (eventData as any).cardBackgroundColor || '#1a0b2e';
  const borderColor = (eventData as any).borderColor || '#8A2BE2';
  const currentAccent = (eventData as any).accentColor || '#FF00FF'

  useEffect(() => {
    if ((eventData as any).accentColor === '#ffffff') {
        setAccentColor('#FF00FF')
    }
  }, [])

  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (file) {
      const localUrl = URL.createObjectURL(file)
      setCoverImage(localUrl) 
      // @ts-ignore
      useEventStore.setState((state) => ({ ...state, tempFile: file }))
    }
  }

  const closeAllPickers = () => {
      setShowStartPicker(false);
      setShowEndPicker(false);
      setShowCardBgPicker(false);
      setShowBorderPicker(false);
      setShowAccentPicker(false);
  }

  return (
    <div className="space-y-8 animate-in slide-in-from-left duration-300 relative">
       
       {/* BACKDROP */}
       {(showStartPicker || showEndPicker || showCardBgPicker || showBorderPicker || showAccentPicker) && (
          <div className="fixed inset-0 z-40" onClick={closeAllPickers} />
       )}

       <div>
        <h2 className="text-xl font-bold text-white mb-1">Diseño y Marca</h2>
        <p className="text-zinc-500 text-xs">Personaliza la gradiente, tarjetas y bordes.</p>
      </div>

      <div className="grid grid-cols-1 gap-6">
          
          {/* 1. GRADIENTE DEL EVENTO (2 COLORES) */}
          <div className="space-y-3 relative z-50">
            <label className="text-xs font-medium text-zinc-400 flex items-center gap-2">
                <Palette size={14} /> Gradiente de Fondo
            </label>
            <div className="grid grid-cols-2 gap-3">
                {/* Inicio */}
                <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-3 flex items-center justify-between relative">
                    <div className="flex flex-col">
                        <span className="text-[9px] text-zinc-500 uppercase font-bold tracking-wider mb-1">Inicio</span>
                        <div className="flex items-center">
                            <span className="text-xs font-bold text-zinc-500 font-mono mr-1">#</span>
                            <input type="text" value={eventData.themeColor.replace('#', '')} onChange={(e) => setThemeColor(`#${e.target.value.replace(/[^0-9A-Fa-f]/g, '').slice(0, 6)}`)} className="bg-transparent text-xs font-bold text-white font-mono outline-none w-16" />
                        </div>
                    </div>
                    <div onClick={() => { closeAllPickers(); setShowStartPicker(true); }} className="w-8 h-8 rounded-full border border-zinc-700 cursor-pointer shadow-sm" style={{ backgroundColor: eventData.themeColor }} />
                    {showStartPicker && (<div className="absolute left-0 top-14 bg-zinc-950 border border-zinc-800 p-3 rounded-xl shadow-2xl z-50"><HexColorPicker color={eventData.themeColor} onChange={setThemeColor} /></div>)}
                </div>
                {/* Fin */}
                <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-3 flex items-center justify-between relative">
                    <div className="flex flex-col">
                        <span className="text-[9px] text-zinc-500 uppercase font-bold tracking-wider mb-1">Fin</span>
                        <div className="flex items-center">
                            <span className="text-xs font-bold text-zinc-500 font-mono mr-1">#</span>
                            <input type="text" value={themeColorEnd.replace('#', '')} onChange={(e) => setThemeColorEnd(`#${e.target.value.replace(/[^0-9A-Fa-f]/g, '').slice(0, 6)}`)} className="bg-transparent text-xs font-bold text-white font-mono outline-none w-16" />
                        </div>
                    </div>
                    <div onClick={() => { closeAllPickers(); setShowEndPicker(true); }} className="w-8 h-8 rounded-full border border-zinc-700 cursor-pointer shadow-sm" style={{ backgroundColor: themeColorEnd }} />
                    {showEndPicker && (<div className="absolute right-0 top-14 bg-zinc-950 border border-zinc-800 p-3 rounded-xl shadow-2xl z-50"><HexColorPicker color={themeColorEnd} onChange={setThemeColorEnd} /></div>)}
                </div>
            </div>
          </div>

          {/* 2. TARJETAS Y BORDES (NUEVOS SELECTORES) */}
          <div className="space-y-3 relative z-40">
            <label className="text-xs font-medium text-zinc-400 flex items-center gap-2">
                <Layers size={14} /> Estilo de Tarjetas
            </label>
            <div className="grid grid-cols-2 gap-3">
                {/* Fondo Tarjetas */}
                <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-3 flex items-center justify-between relative">
                    <div className="flex flex-col">
                        <span className="text-[9px] text-zinc-500 uppercase font-bold tracking-wider mb-1">Fondo</span>
                        <div className="flex items-center">
                            <span className="text-xs font-bold text-zinc-500 font-mono mr-1">#</span>
                            <input type="text" value={cardBgColor.replace('#', '')} onChange={(e) => setCardBackgroundColor(`#${e.target.value.replace(/[^0-9A-Fa-f]/g, '').slice(0, 6)}`)} className="bg-transparent text-xs font-bold text-white font-mono outline-none w-16" />
                        </div>
                    </div>
                    <div onClick={() => { closeAllPickers(); setShowCardBgPicker(true); }} className="w-8 h-8 rounded-full border border-zinc-700 cursor-pointer shadow-sm" style={{ backgroundColor: cardBgColor }} />
                    {showCardBgPicker && (<div className="absolute left-0 top-14 bg-zinc-950 border border-zinc-800 p-3 rounded-xl shadow-2xl z-50"><HexColorPicker color={cardBgColor} onChange={setCardBackgroundColor} /></div>)}
                </div>
                {/* Bordes */}
                <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-3 flex items-center justify-between relative">
                    <div className="flex flex-col">
                        <span className="text-[9px] text-zinc-500 uppercase font-bold tracking-wider mb-1">Borde</span>
                        <div className="flex items-center">
                            <span className="text-xs font-bold text-zinc-500 font-mono mr-1">#</span>
                            <input type="text" value={borderColor.replace('#', '')} onChange={(e) => setBorderColor(`#${e.target.value.replace(/[^0-9A-Fa-f]/g, '').slice(0, 6)}`)} className="bg-transparent text-xs font-bold text-white font-mono outline-none w-16" />
                        </div>
                    </div>
                    <div onClick={() => { closeAllPickers(); setShowBorderPicker(true); }} className="w-8 h-8 rounded-full border border-zinc-700 cursor-pointer shadow-sm" style={{ backgroundColor: borderColor }} />
                    {showBorderPicker && (<div className="absolute right-0 top-14 bg-zinc-950 border border-zinc-800 p-3 rounded-xl shadow-2xl z-50"><HexColorPicker color={borderColor} onChange={setBorderColor} /></div>)}
                </div>
            </div>
          </div>

          {/* 3. COLOR DE ACENTO */}
          <div className="space-y-3 relative z-30">
            <label className="text-xs font-medium text-zinc-400 flex items-center gap-2">
                <MousePointerClick size={14} /> Color de Acento (Botones)
            </label>
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 flex items-center justify-between">
                <div className="flex flex-col">
                    <span className="text-[10px] text-zinc-500 uppercase font-bold tracking-wider mb-1">Código Hex</span>
                    <div className="flex items-center border-b border-transparent focus-within:border-purple-500 transition-colors">
                        <span className="text-sm font-bold text-zinc-500 font-mono select-none">#</span>
                        <input type="text" value={currentAccent.replace('#', '')} onChange={(e) => setAccentColor(`#${e.target.value.replace(/[^0-9A-Fa-f]/g, '').slice(0, 6)}`)} className="bg-transparent text-sm font-bold text-white uppercase tracking-widest font-mono outline-none w-20 placeholder-zinc-700" />
                    </div>
                </div>
                <div className="relative">
                    <div onClick={() => { closeAllPickers(); setShowAccentPicker(true); }} className="w-12 h-12 rounded-full border-2 border-zinc-700 shadow-lg cursor-pointer hover:scale-105 transition-transform" style={{ backgroundColor: currentAccent }} />
                    {showAccentPicker && (<div className="absolute right-0 top-14 bg-zinc-950 border border-zinc-800 p-3 rounded-xl shadow-2xl animate-in zoom-in-95 z-50"><HexColorPicker color={currentAccent} onChange={setAccentColor} /></div>)}
                </div>
            </div>
          </div>

      </div>

      {/* FLYER */}
      <div className="space-y-3 relative z-0">
         <label className="text-xs font-medium text-zinc-400 flex items-center gap-2">
            <ImageIcon size={14} /> Flyer / Portada
        </label>
        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageSelect} />
        <div onClick={() => fileInputRef.current?.click()} className="border-2 border-dashed border-zinc-800 rounded-xl p-8 flex flex-col items-center justify-center gap-3 hover:bg-zinc-900/50 hover:border-zinc-700 transition-all cursor-pointer relative overflow-hidden group">
            {eventData.coverImage ? (
                <>
                    <img src={eventData.coverImage} className="absolute inset-0 w-full h-full object-cover opacity-40" alt="Preview" />
                    <UploadCloud size={24} className="text-white z-10" />
                    <p className="z-10 text-xs text-white font-bold">Cambiar Flyer</p>
                </>
            ) : (
                <>
                    <div className="h-12 w-12 rounded-full bg-zinc-900 flex items-center justify-center group-hover:bg-purple-500/20 transition-colors"><ImageIcon size={20} className="text-zinc-500 group-hover:text-purple-400" /></div>
                    <div className="text-center"><p className="text-sm font-medium text-white">Subir imagen</p><p className="text-xs text-zinc-500">Recomendado: 1080x1350px</p></div>
                </>
            )}
        </div>
      </div>
    </div>
  )
}
</file>

<file path="components/hud/ExperiencePanel.tsx">
'use client'
import { useState, useRef, useEffect } from 'react'
import { useEventStore } from '@/store/useEventStore'
import { AlignLeft, Users2, Ban, Plus, X, Bold, Italic, Underline, Shirt, Smartphone } from 'lucide-react'

export default function ExperiencePanel() {
  // Quitamos updateSettings si da problemas y usamos setExperience para todo
  const { eventData, setExperience } = useEventStore()
  const [itemInput, setItemInput] = useState('')
  const editorRef = useRef<HTMLDivElement>(null)

  // 1. ESTADO SEGURO: Si settings no existe, asumimos false
  const isInstagramActive = eventData.settings?.showInstagram ?? false

  useEffect(() => {
    if (editorRef.current && editorRef.current.innerHTML !== eventData.description) {
      if (!eventData.description) {
        editorRef.current.innerHTML = ''
      } else if (editorRef.current.innerText.trim() === '') { 
        editorRef.current.innerHTML = eventData.description
      }
    }
  }, [])

  const applyFormat = (command: string) => {
    document.execCommand(command, false)
    if (editorRef.current) {
        editorRef.current.focus()
        setExperience({ description: editorRef.current.innerHTML })
    }
  }

  const handleInput = (e: React.FormEvent<HTMLDivElement>) => {
    setExperience({ description: e.currentTarget.innerHTML })
  }

  const handleAddItem = () => {
    if (!itemInput.trim()) return
    setExperience({ prohibitedItems: [...(eventData.prohibitedItems || []), itemInput.trim()] })
    setItemInput('')
  }
  const handleRemoveItem = (itemToRemove: string) => {
    setExperience({ prohibitedItems: eventData.prohibitedItems.filter(i => i !== itemToRemove) })
  }
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') handleAddItem()
  }
  
  const updateSocial = (key: string, value: string) => {
    // Aseguramos que socialLinks exista
    const currentSocial = eventData.socialLinks || {}
    setExperience({ socialLinks: { ...currentSocial, [key]: value } })
  }

  // 2. FUNCIÓN DE TOGGLE ROBUSTA
  const toggleInstagram = () => {
      // Creamos o actualizamos el objeto settings usando setExperience
      const currentSettings = eventData.settings || {}
      setExperience({
          settings: {
              ...currentSettings,
              showInstagram: !isInstagramActive
          }
      })
  }

  return (
    <div className="space-y-8 animate-in slide-in-from-left duration-300 pb-10">
      
      {/* 1. ELEMENTOS PROHIBIDOS */}
      <div className="space-y-3">
        <label className="text-xs font-bold text-red-400 uppercase flex items-center gap-2">
            <Ban size={14} /> Elementos Prohibidos
        </label>
        <div className="flex gap-2">
            <input 
                type="text" 
                value={itemInput}
                onChange={(e) => setItemInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Escribe y presiona Enter (Ej: Gorras)"
                className="flex-1 bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-sm text-white focus:ring-2 focus:ring-red-500/50 outline-none transition-all"
            />
            <button onClick={handleAddItem} className="bg-zinc-800 hover:bg-zinc-700 text-white p-3 rounded-xl transition-colors">
                <Plus size={20} />
            </button>
        </div>
        <div className="flex flex-wrap gap-2 min-h-[40px]">
            {(eventData.prohibitedItems || []).map((item, idx) => (
                <div key={idx} className="flex items-center gap-2 pl-3 pr-2 py-1.5 bg-red-950/30 border border-red-500/30 rounded-full text-red-400 text-xs font-bold animate-in zoom-in-95">
                    <span>{item}</span>
                    <button onClick={() => handleRemoveItem(item)} className="hover:text-white"><X size={12}/></button>
                </div>
            ))}
        </div>
      </div>

      {/* 2. DESCRIPCIÓN */}
      <div className="space-y-2">
        <div className="flex justify-between items-end">
             <label className="text-xs font-bold text-zinc-500 uppercase flex items-center gap-2">
                <AlignLeft size={14} /> Descripción
             </label>
             <div className="flex gap-1 bg-zinc-900 rounded-lg p-1 border border-zinc-800 select-none">
                <button onMouseDown={(e) => { e.preventDefault(); applyFormat('bold'); }} className="p-1.5 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded transition-colors" title="Negrita"><Bold size={14}/></button>
                <button onMouseDown={(e) => { e.preventDefault(); applyFormat('italic'); }} className="p-1.5 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded transition-colors" title="Cursiva"><Italic size={14}/></button>
                <button onMouseDown={(e) => { e.preventDefault(); applyFormat('underline'); }} className="p-1.5 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded transition-colors" title="Subrayado"><Underline size={14}/></button>
             </div>
        </div>
        <div
            ref={editorRef}
            contentEditable
            onInput={handleInput}
            className="w-full h-40 bg-zinc-900 border border-zinc-800 rounded-xl p-4 text-sm text-zinc-300 focus:ring-2 focus:ring-purple-600 outline-none overflow-y-auto leading-relaxed cursor-text transition-all empty:before:content-[attr(placeholder)] empty:before:text-zinc-600 [&>b]:text-white [&>b]:font-bold [&>i]:text-purple-300 [&>i]:italic [&>u]:text-white [&>u]:underline [&>u]:decoration-purple-500"
            role="textbox"
            aria-placeholder="Cuenta de qué trata la fiesta..."
        />
      </div>

      {/* 3. EDADES Y DRESS CODE */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="space-y-3">
            <label className="text-xs font-bold text-zinc-500 uppercase flex items-center gap-2"><Users2 size={14} /> Edad Mínima</label>
            <div className="grid grid-cols-2 gap-2">
                <div className="bg-zinc-950 p-4 rounded-xl border border-zinc-800 flex flex-col items-center justify-center hover:border-zinc-700 transition-colors">
                    <span className="text-[10px] text-zinc-500 uppercase font-bold mb-1 tracking-wider">Hombres</span>
                    <div className="flex items-center justify-center">
                        <span className="text-2xl font-black text-zinc-600 mr-0.5 select-none">+</span>
                        <input 
                            type="text" 
                            inputMode="numeric"
                            maxLength={2}
                            value={eventData.minAgeMen || ''} 
                            onChange={(e) => {
                                const val = e.target.value.replace(/\D/g, '').slice(0, 2)
                                setExperience({ minAgeMen: Number(val) })
                            }} 
                            className="w-10 bg-transparent text-2xl font-black text-white text-center outline-none placeholder-zinc-700"
                            placeholder="21"
                        />
                    </div>
                </div>
                <div className="bg-zinc-950 p-4 rounded-xl border border-zinc-800 flex flex-col items-center justify-center hover:border-zinc-700 transition-colors">
                    <span className="text-[10px] text-zinc-500 uppercase font-bold mb-1 tracking-wider">Mujeres</span>
                    <div className="flex items-center justify-center">
                        <span className="text-2xl font-black text-zinc-600 mr-0.5 select-none">+</span>
                        <input 
                            type="text" 
                            inputMode="numeric"
                            maxLength={2}
                            value={eventData.minAgeWomen || ''} 
                            onChange={(e) => {
                                const val = e.target.value.replace(/\D/g, '').slice(0, 2)
                                setExperience({ minAgeWomen: Number(val) })
                            }} 
                            className="w-10 bg-transparent text-2xl font-black text-white text-center outline-none placeholder-zinc-700"
                            placeholder="18"
                        />
                    </div>
                </div>
            </div>
          </div>

          <div className="space-y-3">
             <label className="text-xs font-bold text-zinc-500 uppercase flex items-center gap-2"><Shirt size={14} /> Dress Code</label>
             <input type="text" value={eventData.dressCode || ''} onChange={(e) => setExperience({ dressCode: e.target.value })} className="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3.5 text-center font-bold text-white focus:ring-2 focus:ring-purple-600 outline-none transition-all placeholder:text-zinc-700" placeholder="Ej: Casual" />
          </div>
      </div>

      {/* 4. REDES SOCIALES (SWITCH FUNCIONAL) */}
      <div className="space-y-4 pt-6 border-t border-zinc-800">
        <div className="flex items-center justify-between">
            <label className="text-xs font-bold text-zinc-500 uppercase flex items-center gap-2">
                <Smartphone size={14} /> Social
            </label>
            
            {/* SWITCH INSTAGRAM */}
            <div 
                className="flex items-center gap-2 cursor-pointer select-none group" 
                onClick={toggleInstagram}
            >
                <span className={`text-[10px] font-bold transition-colors ${isInstagramActive ? 'text-white' : 'text-zinc-600 group-hover:text-zinc-500'}`}>
                    {isInstagramActive ? 'INSTAGRAM ACTIVO' : 'INSTAGRAM OCULTO'}
                </span>
                <div className={`w-9 h-5 rounded-full transition-all relative ${isInstagramActive ? 'bg-pink-600' : 'bg-zinc-800 group-hover:bg-zinc-700'}`}>
                    <div className={`absolute top-1 w-3 h-3 rounded-full bg-white transition-all shadow-sm ${isInstagramActive ? 'left-5' : 'left-1'}`} />
                </div>
            </div>
        </div>

        <div className="space-y-3">
            {/* INPUT DESHABILITADO SI EL SWITCH ESTÁ APAGADO */}
            <div className={`transition-all duration-300 ${isInstagramActive ? 'opacity-100' : 'opacity-40 grayscale'}`}>
                 <input 
                    type="text" 
                    placeholder="Usuario de instagram (ej. dyzgoapp)" 
                    value={eventData.socialLinks?.instagram || ''} 
                    onChange={(e) => updateSocial('instagram', e.target.value)} 
                    disabled={!isInstagramActive} 
                    className="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-pink-500 transition-colors placeholder:text-zinc-600 disabled:cursor-not-allowed disabled:border-zinc-900" 
                />
            </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="components/hud/GeneralPanel.tsx">
'use client'
import { useEventStore } from '@/store/useEventStore'
import { Calendar, MapPin, Type, Clock, Tags, Navigation, Building2, Map, Hash, Loader2, Music } from 'lucide-react'
import { useState, forwardRef, useMemo, useEffect } from 'react'
import DatePicker, { registerLocale } from 'react-datepicker'
import "react-datepicker/dist/react-datepicker.css"
import { es } from 'date-fns/locale/es'
import { supabase } from '@/lib/supabase'

registerLocale('es', es)

const CATEGORIES = ['Sunset', 'Rooftop', 'Afteroffice', 'Afterparty', 'Universitario', 'Nocturno']
const MUSIC_STYLES = ['Reggaetón', 'Techno', 'House', 'EDM', 'Trap']

// --- DATA CHILE COMPLETA ---
const CHILE_DATA = [
    {
        region: "Arica y Parinacota",
        comunas: ["Arica", "Camarones", "Putre", "General Lagos"]
    },
    {
        region: "Tarapacá",
        comunas: ["Iquique", "Alto Hospicio", "Pozo Almonte", "Camiña", "Colchane", "Huara", "Pica"]
    },
    {
        region: "Antofagasta",
        comunas: ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollagüe", "San Pedro de Atacama", "Tocopilla", "María Elena"]
    },
    {
        region: "Atacama",
        comunas: ["Copiapó", "Caldera", "Tierra Amarilla", "Chañaral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"]
    },
    {
        region: "Coquimbo",
        comunas: ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicuña", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbalá", "Monte Patria", "Punitaqui", "Río Hurtado"]
    },
    {
        region: "Valparaíso",
        comunas: ["Valparaíso", "Casablanca", "Concón", "Juan Fernández", "Puchuncaví", "Quintero", "Viña del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa María", "Quilpué", "Limache", "Olmué", "Villa Alemana"]
    },
    {
        region: "Metropolitana de Santiago",
        comunas: ["Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "Santiago", "San Joaquín", "San Miguel", "San Ramón", "Vitacura", "Puente Alto", "Pirque", "San José de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhué", "Curacaví", "María Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Peñaflor"]
    },
    {
        region: "Libertador General Bernardo O'Higgins",
        comunas: ["Rancagua", "Codegua", "Coinco", "Coltauco", "Doñihue", "Graneros", "Las Cabras", "Machalí", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requínoa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Chépica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"]
    },
    {
        region: "Maule",
        comunas: ["Talca", "Constitución", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "Río Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curicó", "Hualañé", "Licantén", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuquén", "Linares", "Colbún", "Longaví", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"]
    },
    {
        region: "Ñuble",
        comunas: ["Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "Quirihue", "Ránquil", "Trehuaco", "Bulnes", "Chillán Viejo", "Chillán", "El Carmen", "Pemuco", "Pinto", "Quillón", "San Ignacio", "Yungay", "Coihueco", "Ñiquén", "San Carlos", "San Fabián", "San Nicolás"]
    },
    {
        region: "Biobío",
        comunas: ["Concepción", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tomé", "Hualpén", "Lebu", "Arauco", "Cañete", "Contulmo", "Curanilahue", "Los Álamos", "Tirúa", "Los Ángeles", "Antuco", "Cabrero", "Laja", "Mulchén", "Nacimiento", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa Bárbara", "Tucapel", "Yumbel", "Alto Biobío"]
    },
    {
        region: "La Araucanía",
        comunas: ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufquén", "Pucón", "Saavedra", "Teodoro Schmidt", "Toltén", "Vilcún", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacautín", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Purén", "Renaico", "Traiguén", "Victoria"]
    },
    {
        region: "Los Ríos",
        comunas: ["Valdivia", "Corral", "Lanco", "Los Lagos", "Máfil", "Mariquina", "Paillaco", "Panguipulli", "La Unión", "Futrono", "Lago Ranco", "Río Bueno"]
    },
    {
        region: "Los Lagos",
        comunas: ["Puerto Montt", "Calbuco", "Cochamó", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maullín", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de Vélez", "Dalcahue", "Puqueldón", "Queilén", "Quellón", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "Río Negro", "San Juan de la Costa", "San Pablo", "Chaitén", "Futaleufú", "Hualaihué", "Palena"]
    },
    {
        region: "Aysén del General Carlos Ibáñez del Campo",
        comunas: ["Coyhaique", "Lago Verde", "Aysén", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "Río Ibáñez"]
    },
    {
        region: "Magallanes y de la Antártica Chilena",
        comunas: ["Punta Arenas", "Laguna Blanca", "Río Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Antártica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]
    }
]

const datePickerStyles = `
  .react-datepicker-wrapper { width: 100%; }
  .react-datepicker-popper { z-index: 9999 !important; }
  .react-datepicker {
    font-family: inherit; background-color: #18181b; border: 1px solid #27272a; color: white; border-radius: 0.75rem;
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  }
  .react-datepicker__header { background-color: #18181b; border-bottom: 1px solid #27272a; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
  .react-datepicker__current-month, .react-datepicker-time__header, .react-datepicker__day-name { color: white !important; font-weight: 700; }
  .react-datepicker__day { color: #a1a1aa; }
  .react-datepicker__day:hover { background-color: #27272a; color: white; border-radius: 0.375rem; }
  .react-datepicker__day--selected, .react-datepicker__day--keyboard-selected { background-color: #9333ea !important; color: white !important; font-weight: bold; }
  .react-datepicker__time-container { border-left: 1px solid #27272a; width: 100px !important; }
  .react-datepicker__time-container .react-datepicker__time { background-color: #18181b; border-radius: 0.75rem; }
  .react-datepicker__time-container .react-datepicker__time .react-datepicker__time-box ul.react-datepicker__time-list li.react-datepicker__time-list-item { color: #a1a1aa; height: auto; padding: 8px; }
  .react-datepicker__time-container .react-datepicker__time .react-datepicker__time-box ul.react-datepicker__time-list li.react-datepicker__time-list-item:hover { background-color: #27272a; color: white; }
  .react-datepicker__time-container .react-datepicker__time .react-datepicker__time-box ul.react-datepicker__time-list li.react-datepicker__time-list-item--selected { background-color: #9333ea !important; color: white !important; }
  .react-datepicker__time-container .react-datepicker__time .react-datepicker__time-box ul.react-datepicker__time-list::-webkit-scrollbar { display: none; }
  .react-datepicker__time-container .react-datepicker__time .react-datepicker__time-box ul.react-datepicker__time-list { -ms-overflow-style: none; scrollbar-width: none; }
`

export default function GeneralPanel() {
  const { 
    eventData, 
    setEventName, 
    setEventVenue, 
    setEventDate, 
    setEventEndDate, 
    setEventTime, 
    setCategory,
    setEventAddress, 
    setEventRegion,
    setEventCommune,
    setEventStreet,
    setEventNumber,
    setClubId,      // Ya debe estar en el store sin error
    setMusicGenre   // Ya debe estar en el store sin error
  } = useEventStore()

  const [clubs, setClubs] = useState<any[]>([])
  const [loadingClubs, setLoadingClubs] = useState(true)

  useEffect(() => {
    const fetchClubs = async () => {
      try {
        setLoadingClubs(true)
        const { data, error } = await supabase
          .from('clubs')
          .select('id, name') 
          .order('name', { ascending: true })
        
        if (data) setClubs(data)
        if (error) console.error("Error cargando clubes:", error)
      } catch (e) {
        console.error("Error fetch:", e)
      } finally {
        setLoadingClubs(false)
      }
    }
    fetchClubs()
  }, [])

  const handleClubSelect = (e: React.ChangeEvent<HTMLSelectElement>) => {
    setEventVenue(e.target.value)
    // Opcional: si tienes el ID, búscalo y setéalo también
    const selected = clubs.find(c => c.name === e.target.value)
    if (selected && setClubId) setClubId(selected.id) 
  }

  // --- LÓGICA DE GÉNEROS MUSICALES ---
  const handleMusicToggle = (style: string) => {
    // Si la función no existe, salimos
    if (!setMusicGenre) return

    // Convertir string "Techno,House" a array ["Techno", "House"]
    const currentStr = eventData.musicGenre || ''
    const currentGenres = currentStr ? currentStr.split(',').map(s => s.trim()) : []
    
    let newGenres: string[]
    
    if (currentGenres.includes(style)) {
        // Si ya está, lo quitamos
        newGenres = currentGenres.filter(g => g !== style)
    } else {
        // Si no está, lo agregamos
        newGenres = [...currentGenres, style]
    }
    
    // Convertir de vuelta a string y actualizar el Store (y DB si existe ID)
    const finalString = newGenres.join(',')
    console.log("Actualizando Music Genre a:", finalString)
    setMusicGenre(finalString)
  }

  const isMusicSelected = (style: string) => {
      const currentStr = eventData.musicGenre || ''
      // Aseguramos coincidencia exacta limpiando espacios
      return currentStr.split(',').map(s => s.trim()).includes(style)
  }

  const availableCommunes = useMemo(() => {
    if (!eventData.region) return []
    const regionData = CHILE_DATA.find(r => r.region === eventData.region)
    return regionData ? regionData.comunas : []
  }, [eventData.region])

  useEffect(() => {
    const parts = [
        `${eventData.street || ''} ${eventData.number || ''}`.trim(),
        eventData.commune,
        eventData.region
    ].filter(Boolean)

    const fullAddress = parts.join(', ')
    
    if (fullAddress !== eventData.address) {
        setEventAddress(fullAddress)
    }
  }, [eventData.street, eventData.number, eventData.commune, eventData.region, setEventAddress, eventData.address])


  const parseDate = (dateStr?: string) => {
      if (!dateStr) return null
      const [year, month, day] = dateStr.split('-').map(Number)
      return new Date(year, month - 1, day)
  }

  const parseTime = (timeStr?: string) => {
      if (!timeStr) return null
      const [hours, minutes] = timeStr.split(':').map(Number)
      const date = new Date()
      date.setHours(hours)
      date.setMinutes(minutes)
      return date
  }

  const handleDateChange = (date: Date | null, type: 'start' | 'end') => {
      if (!date) return
      const year = date.getFullYear()
      const month = String(date.getMonth() + 1).padStart(2, '0')
      const day = String(date.getDate()).padStart(2, '0')
      const dateString = `${year}-${month}-${day}`
      
      if (type === 'start') setEventDate(dateString)
      else setEventEndDate(dateString)
  }

  const handleTimeChange = (date: Date | null, type: 'start' | 'end') => {
      if (!date) return
      const hours = String(date.getHours()).padStart(2, '0')
      const minutes = String(date.getMinutes()).padStart(2, '0')
      const timeString = `${hours}:${minutes}`

      if (type === 'start') setEventTime(timeString, eventData.endTime)
      else setEventTime(eventData.startTime, timeString)
  }

  // eslint-disable-next-line react/display-name
  const CustomInput = forwardRef(({ value, onClick, placeholder, icon }: any, ref: any) => (
    <div 
        onClick={onClick}
        ref={ref}
        className="relative w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 cursor-pointer hover:border-zinc-700 transition-colors group flex items-center justify-between gap-3"
    >
        <span className={`text-sm font-bold ${value ? 'text-white' : 'text-zinc-500'}`}>
            {value || placeholder}
        </span>
        <div className="text-white opacity-70 group-hover:opacity-100 transition-opacity">
            {icon}
        </div>
    </div>
  ))

  return (
    <div className="space-y-6 animate-in slide-in-from-left duration-300">
      <style>{datePickerStyles}</style>
      
      <div>
        <h2 className="text-xl font-bold text-white mb-1">Información Básica</h2>
        <p className="text-zinc-500 text-xs">Define la identidad y coordenadas de tu evento.</p>
      </div>

      <div className="space-y-5">
        
        <div className="space-y-2">
            <label className="text-xs font-bold text-zinc-400 flex items-center gap-2 uppercase">
                <Type size={14} /> Nombre del Evento
            </label>
            <input 
                type="text" 
                value={eventData.name || ''} 
                onChange={(e) => setEventName(e.target.value)}
                placeholder="Ej: Salvaje It's Miller Time"
                className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 transition-all text-white font-bold placeholder:text-zinc-600"
            />
        </div>

        <div className="space-y-2">
            <label className="text-xs font-bold text-zinc-400 flex items-center gap-2 uppercase">
                <Tags size={14} /> Categoría Principal
            </label>
            <div className="grid grid-cols-3 gap-2">
                {CATEGORIES.map(cat => (
                    <button
                        key={cat}
                        type="button"
                        onClick={() => setCategory(cat)}
                        className={`py-2 px-1 text-[10px] font-bold rounded-lg border transition-all uppercase ${
                            eventData.category === cat 
                            ? 'bg-purple-600 border-purple-400 text-white' 
                            : 'bg-zinc-900 border border-zinc-800 text-zinc-500 hover:border-zinc-700'
                        }`}
                    >
                        {cat}
                    </button>
                ))}
            </div>
        </div>

        {/* SECCIÓN DE GÉNERO MUSICAL CORREGIDA */}
        <div className="space-y-2">
            <label className="text-xs font-bold text-zinc-400 flex items-center gap-2 uppercase">
                <Music size={14} /> Estilos Musicales (Selección Múltiple)
            </label>
            <div className="flex flex-wrap gap-2">
                {MUSIC_STYLES.map(style => {
                    const isSelected = isMusicSelected(style)
                    return (
                        <button
                            key={style}
                            type="button"
                            onClick={() => handleMusicToggle(style)}
                            className={`py-2 px-3 text-[10px] font-bold rounded-lg border transition-all uppercase ${
                                isSelected
                                ? 'bg-purple-600 border-purple-400 text-white' 
                                : 'bg-zinc-900 border border-zinc-800 text-zinc-500 hover:border-zinc-700'
                            }`}
                        >
                            {style}
                        </button>
                    )
                })}
            </div>
            {/* Texto de debug invisible para asegurar reactividad */}
            <p className="hidden">{eventData.musicGenre}</p>
        </div>

        <div className="grid grid-cols-2 gap-3">
            <div className="space-y-2">
                <label className="text-xs font-bold text-zinc-400 flex items-center gap-2 uppercase">
                    <Calendar size={14} className="text-white"/> Fecha Inicio
                </label>
                <DatePicker 
                    selected={parseDate(eventData.date)}
                    onChange={(date) => handleDateChange(date, 'start')}
                    dateFormat="dd/MM/yyyy"
                    locale="es"
                    placeholderText="Seleccionar" 
                    wrapperClassName="w-full"
                    customInput={<CustomInput placeholder="Seleccionar" icon={<Calendar size={16}/>} />}
                />
            </div>
            
            <div className="space-y-2">
                <label className="text-xs font-bold text-zinc-400 flex items-center gap-2 uppercase">
                    <Clock size={14} className="text-white"/> Hora Inicio
                </label>
                <DatePicker 
                    selected={parseTime(eventData.startTime)}
                    onChange={(date) => handleTimeChange(date, 'start')}
                    showTimeSelect
                    showTimeSelectOnly
                    timeIntervals={15}
                    timeCaption="Hora"
                    dateFormat="HH:mm"
                    locale="es"
                    placeholderText="Seleccionar" 
                    wrapperClassName="w-full"
                    customInput={<CustomInput placeholder="Seleccionar" icon={<Clock size={16}/>} />}
                />
            </div>

            <div className="space-y-2">
                <label className="text-xs font-bold text-zinc-400 flex items-center gap-2 uppercase">
                    <Calendar size={14} className="text-white"/> Fecha Fin
                </label>
                <DatePicker 
                    selected={parseDate(eventData.endDate)}
                    onChange={(date) => handleDateChange(date, 'end')}
                    dateFormat="dd/MM/yyyy"
                    locale="es"
                    minDate={parseDate(eventData.date) || new Date()}
                    placeholderText="Seleccionar" 
                    wrapperClassName="w-full"
                    customInput={<CustomInput placeholder="Seleccionar" icon={<Calendar size={16}/>} />}
                />
            </div>

            <div className="space-y-2">
                <label className="text-xs font-bold text-zinc-400 flex items-center gap-2 uppercase">
                    <Clock size={14} className="text-white"/> Hora Fin
                </label>
                <DatePicker 
                    selected={parseTime(eventData.endTime)}
                    onChange={(date) => handleTimeChange(date, 'end')}
                    showTimeSelect
                    showTimeSelectOnly
                    timeIntervals={15}
                    timeCaption="Hora"
                    dateFormat="HH:mm"
                    locale="es"
                    placeholderText="Seleccionar" 
                    wrapperClassName="w-full"
                    customInput={<CustomInput placeholder="Seleccionar" icon={<Clock size={16}/>} />}
                />
            </div>
        </div>

        <div className="space-y-2">
            <label className="text-xs font-bold text-zinc-400 flex items-center gap-2 uppercase">
                <Building2 size={14} /> Lugar / Club
            </label>
            <div className="relative">
                <select
                    value={eventData.venue || ''} 
                    onChange={handleClubSelect}
                    disabled={loadingClubs}
                    className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 text-white font-bold appearance-none cursor-pointer disabled:opacity-50"
                >
                    <option value="" disabled>
                        {loadingClubs ? 'Cargando clubes...' : 'Seleccionar Club de la lista'}
                    </option>
                    {clubs.map((club) => (
                        <option key={club.id} value={club.name}>
                            {club.name}
                        </option>
                    ))}
                </select>
                <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-zinc-500">
                    {loadingClubs ? <Loader2 size={16} className="animate-spin" /> : <Building2 size={16} />}
                </div>
            </div>
        </div>

        <div className="space-y-3 pt-2">
            <div className="flex items-center gap-2">
                <MapPin size={16} className="text-purple-500" />
                <h3 className="text-sm font-bold text-white uppercase">Dirección Exacta</h3>
            </div>
            
            <div className="grid grid-cols-2 gap-3">
                <div className="space-y-2">
                    <label className="text-[10px] font-bold text-zinc-500 uppercase flex items-center gap-1">
                        <Map size={10} /> Región
                    </label>
                    <select
                        value={eventData.region || ''}
                        onChange={(e) => {
                            if (setEventRegion) {
                                setEventRegion(e.target.value)
                                if (setEventCommune) setEventCommune('') 
                            }
                        }}
                        className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 text-white font-medium appearance-none cursor-pointer"
                    >
                        <option value="" disabled>Seleccionar Región</option>
                        {CHILE_DATA.map((item) => (
                            <option key={item.region} value={item.region}>{item.region}</option>
                        ))}
                    </select>
                </div>

                <div className="space-y-2">
                    <label className="text-[10px] font-bold text-zinc-500 uppercase flex items-center gap-1">
                        <MapPin size={10} /> Comuna
                    </label>
                    <select
                        value={eventData.commune || ''}
                        onChange={(e) => setEventCommune && setEventCommune(e.target.value)}
                        disabled={!eventData.region}
                        className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 text-white font-medium appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <option value="" disabled>Seleccionar Comuna</option>
                        {availableCommunes.map((comuna) => (
                            <option key={comuna} value={comuna}>{comuna}</option>
                        ))}
                    </select>
                </div>
            </div>

            <div className="grid grid-cols-[70%_30%] gap-3">
                <div className="space-y-2">
                    <label className="text-[10px] font-bold text-zinc-500 uppercase flex items-center gap-1">
                        <Navigation size={10} /> Calle / Avenida
                    </label>
                    <input 
                        type="text" 
                        value={eventData.street || ''} 
                        onChange={(e) => setEventStreet && setEventStreet(e.target.value)}
                        placeholder="Ej: Avenida Apoquindo"
                        className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 text-white font-bold placeholder:text-zinc-600"
                    />
                </div>

                <div className="space-y-2">
                    <label className="text-[10px] font-bold text-zinc-500 uppercase flex items-center gap-1">
                        <Hash size={10} /> Número
                    </label>
                    <input 
                        type="text" 
                        value={eventData.number || ''} 
                        onChange={(e) => setEventNumber && setEventNumber(e.target.value)}
                        placeholder="4990"
                        className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 text-white font-bold placeholder:text-zinc-600 text-center"
                    />
                </div>
            </div>
        </div>

      </div>
    </div>
  )
}
</file>

<file path="components/hud/LivePreview.tsx">
'use client'
import React from 'react'
import { 
  MapPin, 
  Calendar, 
  Clock, 
  Instagram, 
  Shirt, 
  Ban, 
  User, 
  Ticket, 
  ArrowLeft, 
  Info, 
  Minus, 
  Plus, 
  Bookmark, 
  Signal, 
  Wifi, 
  Battery, 
  Music, 
  ArrowRight, 
  Layers, 
  ChevronRight,
  ExternalLink,
  CheckCircle2
} from 'lucide-react'
import { useEventStore } from '@/store/useEventStore'

const COLORS = {
  neonPink: '#FF00FF',
  neonPurple: '#8A2BE2',
  glassBg: 'rgba(255, 255, 255, 0.05)',
  textZinc: '#a1a1aa'
}

export default function LivePreview() {
  // @ts-ignore
  const { eventData, activeSection } = useEventStore()

  // @ts-ignore
  const accent = eventData.accentColor || '#d946ef' 
  // @ts-ignore
  const radius = eventData.borderRadius || 'rounded-[2rem]' 
  // @ts-ignore
  const font = eventData.fontStyle || 'font-sans'
  
  // COLORES DINÁMICOS
  const cardBg = (eventData as any).cardBackgroundColor || '#1a0b2e'
  const borderCol = (eventData as any).borderColor || '#8A2BE2'

  if (activeSection === 'tickets') {
    return <TicketSelectionPreview eventData={eventData} accent={accent} radius={radius} font={font} cardBg={cardBg} borderCol={borderCol} />
  }

  const getDay = (dateStr: string) => {
    if (!dateStr) return '31'
    const date = new Date(dateStr)
    const day = date.getUTCDate()
    return day
  }

  const getMonth = (dateStr: string) => {
    if (!dateStr) return 'ENE'
    const months = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC']
    return months[new Date(dateStr).getUTCMonth()]
  }

  const minPrice = eventData.tickets.length > 0 
    ? Math.min(...eventData.tickets.map(t => t.price)) 
    : 5000 

  const GOOGLE_API_KEY = "AIzaSyDOZ9gVgcmAr19Ol35AzFGiuYR_8v8Mx-4"
  const mapQuery = encodeURIComponent(eventData.address || 'Santiago, Chile')
  const mapUrl = `https://www.google.com/maps/embed/v1/place?key=${GOOGLE_API_KEY}&q=${mapQuery}&maptype=satellite&zoom=15&language=es`

  return (
    <div className={`w-[390px] h-[820px] bg-black rounded-[55px] border-[6px] border-black shadow-[0_0_0_4px_#27272a,0_20px_50px_-10px_rgba(0,0,0,0.5)] overflow-hidden relative flex flex-col select-none ring-1 ring-white/10 ${font}`}>
      
      {/* FONDO GRADIENTE LINEAL */}
      <div 
        className="absolute inset-0 pointer-events-none transition-all duration-700 ease-in-out z-0"
        style={{
            // @ts-ignore
            background: `linear-gradient(180deg, ${eventData.themeColor} 0%, ${eventData.themeColorEnd || '#090014'} 100%)`,
        }}
      />

      {/* BARRA ESTADO */}
      <div className="h-14 w-full flex justify-between items-start px-7 pt-4 absolute top-0 z-50 pointer-events-none">
          <span className="text-white text-[15px] font-semibold tracking-wide w-12 text-center">01:49</span>
          <div className="absolute left-1/2 -translate-x-1/2 top-2.5 w-[120px] h-[35px] bg-black rounded-full flex items-center justify-center z-50">
                <div className="w-20 h-full flex items-center justify-end pr-2">
                    <div className="w-2 h-2 rounded-full bg-[#1a1a1a] shadow-inner" />
                </div>
          </div>
          <div className="flex items-center gap-1.5 w-12 justify-end text-white">
             <Signal size={16} strokeWidth={2.5} />
             <Wifi size={16} strokeWidth={2.5} />
             <div className="flex items-center justify-center bg-white/20 px-1 rounded-sm">
                <span className="text-[10px] font-bold mr-0.5">38</span>
             </div>
          </div>
      </div>

      {/* HEADER FLOTANTE (Usando cardBg y borderCol para el botón, pero Icono BLANCO) */}
      <div className="absolute top-14 left-0 w-full px-5 flex justify-between items-center z-50 pointer-events-none">
          <div 
            className="w-10 h-10 rounded-full backdrop-blur-md flex items-center justify-center border"
            style={{ backgroundColor: `${cardBg}CC`, borderColor: `${borderCol}80` }}
          >
             <ArrowLeft size={20} color="white" />
          </div>
          <div 
            className="w-10 h-10 rounded-full backdrop-blur-md flex items-center justify-center border"
            style={{ backgroundColor: `${cardBg}CC`, borderColor: `${borderCol}80` }}
          >
             <Bookmark size={20} color="white" />
          </div>
      </div>

      {/* SCROLLABLE CONTENT */}
      <div className="flex-1 overflow-y-auto [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none] pt-28 pb-32 relative z-10">
          
          <div className="px-5 mb-6">
              <div className="aspect-square w-full rounded-[2.5rem] overflow-hidden relative bg-zinc-900 border border-white/10 shadow-2xl">
                 {eventData.coverImage ? (
                    <img src={eventData.coverImage} className="w-full h-full object-cover" alt="Cover" />
                 ) : (
                    <div className="w-full h-full flex items-center justify-center bg-zinc-800 text-zinc-500 font-medium">Sin Imagen</div>
                 )}
              </div>
          </div>

          <div className="px-6 mb-8">
              <div className="flex justify-between items-start">
                  <div className="flex-1 pr-4">
                      <h1 className="text-[28px] leading-8 font-black text-white italic uppercase tracking-tight mb-2">
                          {eventData.name || 'NOMBRE DEL EVENTO'}
                      </h1>
                      <div className="flex items-center gap-1.5 text-zinc-400">
                          <MapPin size={14} color={borderCol} />
                          <span className="text-xs font-medium truncate">{eventData.venue || 'Ubicación'}</span>
                      </div>
                  </div>
                  
                  {/* FECHA BADGE - TEXTO BLANCO */}
                  <div 
                    className="rounded-2xl w-[70px] h-[70px] flex flex-col items-center justify-center backdrop-blur-sm border"
                    style={{ backgroundColor: `${cardBg}90`, borderColor: `${borderCol}60` }}
                  >
                      <span className="text-[10px] font-bold text-white uppercase tracking-wider">{getMonth(eventData.date)}</span>
                      <span className="text-2xl font-black text-white">{getDay(eventData.date)}</span>
                  </div>
              </div>

              {/* TAGS PILLS - TEXTO BLANCO */}
              <div className="flex flex-nowrap gap-2 mt-5 overflow-x-auto [&::-webkit-scrollbar]:hidden">
                  <div 
                    className="shrink-0 px-2.5 py-1 rounded-full border flex items-center gap-1.5"
                    style={{ backgroundColor: `${cardBg}90`, borderColor: `${borderCol}60` }}
                  >
                      <Clock size={10} color="white" />
                      <span className="text-[9px] font-bold text-white">
                          {eventData.startTime || '22:30'} - {eventData.endTime || '04:00'}
                      </span>
                  </div>
                  <div 
                    className="shrink-0 px-2.5 py-1 rounded-full border flex items-center gap-1.5"
                    style={{ borderColor: 'rgba(255,255,255,0.2)', backgroundColor: 'rgba(255,255,255,0.05)' }}
                  >
                      <Music size={10} color="white" />
                      <span className="text-[9px] font-bold text-white uppercase">{eventData.category || 'GENERAL'}</span>
                  </div>
              </div>
          </div>

          <div className="w-full h-px bg-white/5 my-6" />

          {/* ESTADO & BRAND */}
          <div className="px-6 space-y-4 mb-8">
              <div 
                className="w-full border rounded-[1.5rem] p-5 relative overflow-hidden"
                style={{ backgroundColor: `${cardBg}90`, borderColor: `${borderCol}60` }}
              >
                  <div className="flex justify-between items-start mb-1">
                      <div className="flex items-center gap-2">
                          <Clock size={14} className="text-zinc-400" />
                          <span className="text-xs font-bold text-zinc-400 uppercase tracking-wide">SIN DATOS</span>
                      </div>
                      <div className="px-2 py-0.5 bg-white/10 rounded text-[9px] font-bold text-zinc-500">OFF</div>
                  </div>
                  <p className="text-zinc-300 text-sm font-medium mt-1">Acceso tranquilo por ahora.</p>
                  
                  <div 
                    className="mt-4 border rounded-xl p-3 flex items-center gap-2"
                    style={{ backgroundColor: `${cardBg}`, borderColor: `${borderCol}40` }}
                  >
                      <Info size={14} className="text-zinc-400" />
                      <span className="text-xs text-zinc-300 font-medium">Llega cuando quieras, está despejado.</span>
                  </div>

                  <div className="mt-4 flex justify-center items-center gap-1">
                      <span className="text-[10px] font-bold text-white">Toca para ver opciones de viaje</span>
                      <ChevronRight size={12} color="white" />
                  </div>
              </div>

              <div 
                className="w-full border rounded-[1.5rem] p-4 flex items-center justify-between"
                style={{ backgroundColor: `${cardBg}60`, borderColor: `${borderCol}60` }}
              >
                  <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: `${borderCol}20` }}>
                          <Layers size={16} color={borderCol} />
                      </div>
                      <div className="flex flex-col">
                          <span className="text-[9px] font-bold text-zinc-500 uppercase tracking-wider">EXPERIENCIA</span>
                          <span className="text-sm font-bold text-white">Más de {eventData.name?.split(' ')[0] || 'Evento'}</span>
                      </div>
                  </div>
                  <ChevronRight size={16} color={borderCol} />
              </div>
          </div>

          <div className="px-6 mb-8">
              <h3 className="text-lg font-bold text-white mb-2">Descripción</h3>
              <div 
                className="text-zinc-300/80 text-sm leading-relaxed whitespace-pre-wrap [&_b]:text-white [&_b]:font-bold [&_strong]:text-white [&_strong]:font-bold [&_i]:italic [&_u]:underline"
                dangerouslySetInnerHTML={{ 
                    __html: eventData.description || 'Aquí aparecerá la descripción detallada de tu evento...' 
                }}
              />
          </div>

          {/* ADMISIÓN - TEXTOS BLANCOS */}
          <div className="px-6 mb-8">
              <h3 className="text-lg font-bold text-white mb-4">Admisión & Reglas</h3>
              <div className="grid grid-cols-2 gap-4">
                  <div 
                    className="border rounded-[1.5rem] p-5 flex flex-col items-center justify-center"
                    style={{ backgroundColor: `${cardBg}90`, borderColor: `${borderCol}60` }}
                  >
                      <span className="text-[9px] font-bold text-white uppercase mb-2 tracking-widest">EDAD MÍNIMA</span>
                      <div className="flex items-center gap-4">
                          <div className="text-center">
                              <span className="text-xl font-black text-white">+{eventData.minAgeWomen}</span>
                              <span className="text-[9px] text-zinc-500 block font-bold">Mujeres</span>
                          </div>
                          <div className="w-px h-6 bg-white/10" />
                          <div className="text-center">
                              <span className="text-xl font-black text-white">+{eventData.minAgeMen}</span>
                              <span className="text-[9px] text-zinc-500 block font-bold">Hombres</span>
                          </div>
                      </div>
                  </div>

                  <div 
                    className="border rounded-[1.5rem] p-5 flex flex-col items-center justify-center"
                    style={{ backgroundColor: `${cardBg}90`, borderColor: `${borderCol}60` }}
                  >
                      <span className="text-[9px] font-bold text-white uppercase mb-2 tracking-widest">DRESS CODE</span>
                      <Shirt size={24} className="text-[#FFD700] mb-1" />
                      <span className="text-sm font-bold text-white">{eventData.dressCode || 'Casual'}</span>
                  </div>
              </div>
          </div>

          {/* UBICACIÓN - LINK BLANCO */}
          <div className="px-6 mb-8">
               <div className="flex justify-between items-end mb-4">
                   <h3 className="text-lg font-bold text-white">Ubicación</h3>
                   <div className="flex items-center gap-1 text-white">
                        <span className="text-[10px] font-bold">Google Maps</span>
                        <ExternalLink size={10} />
                   </div>
               </div>
               
               <div className={`w-full h-48 bg-zinc-900 ${radius} overflow-hidden relative border border-white/10 shadow-2xl`}>
                    <iframe
                        width="100%"
                        height="100%"
                        style={{ border: 0, filter: 'brightness(0.8) contrast(1.1)' }} 
                        loading="lazy"
                        allowFullScreen
                        src={mapUrl}
                        className="w-full h-full opacity-90"
                    />
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 -mt-4 flex flex-col items-center justify-center z-10 pointer-events-none">
                        <div className="relative">
                            <MapPin size={40} color="white" fill={COLORS.neonPink} className="drop-shadow-xl" />
                            <div className="absolute top-[11px] left-[13px] w-3.5 h-3.5 bg-white rounded-full shadow-sm" />
                        </div>
                    </div>
                    <div className="absolute bottom-3 left-3 right-3 bg-black/90 backdrop-blur-md rounded-2xl py-3 px-4 border border-zinc-800 shadow-xl z-20 pointer-events-none">
                        <p className="text-[13px] text-white font-bold truncate leading-tight mb-0.5">
                            {eventData.address || 'Av. Apoquindo 4900, Las Condes'}
                        </p>
                        <p className="text-[10px] font-bold text-white">Toca para abrir en Google Maps</p>
                    </div>
               </div>
          </div>
      </div>

      {/* FOOTER */}
      <div className="absolute bottom-0 w-full z-50">
           <div className="w-full bg-black/60 backdrop-blur-xl border-t border-white/10 p-5 pb-8 flex items-center justify-between gap-4">
                <div className="flex flex-col">
                    <span className="text-[10px] text-zinc-400 font-bold uppercase tracking-wider mb-0.5">Desde</span>
                    <div className="text-3xl font-black text-white tracking-tighter">
                        ${minPrice.toLocaleString('es-CL')}
                    </div>
                </div>
                <button 
                    style={{ backgroundColor: accent }}
                    className={`h-12 px-6 text-white ${radius} font-bold text-sm hover:brightness-110 active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-lg shadow-black/20 min-w-[160px]`}
                >
                    Obtener Tickets <ArrowRight size={18} />
                </button>
           </div>
           
           <div className="absolute bottom-2 left-1/2 -translate-x-1/2 w-32 h-1.5 bg-white/20 rounded-full pointer-events-none" />
      </div>

    </div>
  )
}

function TicketSelectionPreview({ eventData, accent, radius, font, cardBg, borderCol }: { eventData: any, accent: string, radius: string, font: string, cardBg: string, borderCol: string }) {
    const visibleTickets = eventData.tickets.filter((t: any) => t.isActive !== false);

    return (
        <div className={`w-[390px] h-[820px] bg-black rounded-[55px] border-[6px] border-black shadow-[0_0_0_4px_#27272a,0_20px_50px_-10px_rgba(0,0,0,0.5)] overflow-hidden relative flex flex-col select-none ring-1 ring-white/10 ${font}`}>
            <div 
                className="absolute inset-0 pointer-events-none transition-all duration-700 ease-in-out z-0"
                style={{
                    background: `linear-gradient(180deg, ${eventData.themeColor} 0%, ${eventData.themeColorEnd || '#090014'} 100%)`,
                }}
            />
            <div className="h-14 w-full flex justify-between items-start px-7 pt-4 absolute top-0 z-50">
                <span className="text-white text-[15px] font-semibold tracking-wide w-12 text-center">9:41</span>
                <div className="absolute left-1/2 -translate-x-1/2 top-2.5 w-[120px] h-[35px] bg-black rounded-full flex items-center justify-center z-50">
                        <div className="w-20 h-full flex items-center justify-end pr-2">
                            <div className="w-2 h-2 rounded-full bg-[#1a1a1a] shadow-inner" />
                        </div>
                </div>
                <div className="flex items-center gap-1.5 w-12 justify-end text-white">
                    <Signal size={16} strokeWidth={2.5} />
                    <Wifi size={16} strokeWidth={2.5} />
                    <Battery size={20} strokeWidth={2.5} />
                </div>
            </div>
            
            {/* Header Flotante Tickets (Botón Blanco) */}
            <div className="relative z-10 px-6 pt-16 pb-4 flex justify-between items-center">
                <div className="w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-md border" style={{ backgroundColor: `${cardBg}CC`, borderColor: `${borderCol}80` }}>
                    <ArrowLeft className="text-white" size={20} color="white" />
                </div>
                <h2 className="text-white font-black text-sm tracking-widest">SELECCIONAR</h2>
                <div className="w-10"></div>
            </div>

            <div className="flex-1 overflow-y-auto [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none] px-6 relative z-10 pb-32 bg-black/60 backdrop-blur-2xl">
                <div className="mb-8 mt-2">
                    <h1 className="text-3xl font-black text-white leading-tight mb-3 uppercase">
                        {eventData.name || 'NOMBRE DEL EVENTO'}
                    </h1>
                    <div className="flex items-center gap-2 mb-2 text-zinc-400">
                        <Calendar style={{ color: accent }} size={16} />
                        <span className="text-sm font-medium">
                            {eventData.date ? new Date(eventData.date).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }) : 'Fecha del evento'}
                        </span>
                    </div>
                    <div className="flex items-center gap-2 text-zinc-400">
                        <MapPin style={{ color: accent }} size={16} />
                        <span className="text-sm font-medium">{eventData.venue || 'Ubicación'}</span>
                    </div>
                </div>
                 <div className="space-y-3">
                    {visibleTickets.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-10 opacity-50">
                            <Info className="text-zinc-500 mb-2" size={32} />
                            <p className="text-zinc-500 text-sm">No hay entradas visibles configuradas.</p>
                        </div>
                    ) : (
                        visibleTickets.map((tier: any) => {
                            const remaining = Math.max(0, tier.quantity - (tier.sold || 0));
                            const isSoldOut = remaining <= 0 || tier.isGhostSoldOut;
                            return (
                                <div key={tier.id} className={`flex items-center justify-between bg-white/5 border border-white/10 ${radius} p-4 ${isSoldOut ? 'opacity-50' : ''}`}>
                                    <div className="flex-1 pr-4">
                                        <h4 className="text-white font-bold text-lg mb-1">{tier.name}</h4>
                                        <p className="text-zinc-300 font-medium">${tier.price?.toLocaleString('es-CL')}</p>
                                    </div>
                                    {!isSoldOut && (
                                        <div className={`flex items-center gap-3 bg-black/30 p-1.5 border border-white/5 ${radius}`}>
                                            <div className={`w-8 h-8 ${radius} flex items-center justify-center shadow-lg`} style={{ backgroundColor: accent }}><Plus className="text-white" size={14} /></div>
                                        </div>
                                    )}
                                </div>
                            )
                        })
                    )}
                </div>
            </div>
            
            <div className="absolute bottom-0 w-full z-50">
                <div className="w-full bg-black/60 backdrop-blur-xl border-t border-white/10 p-5 pb-8 flex items-center justify-between gap-4">
                    <div className={`w-full h-14 ${radius} overflow-hidden opacity-50 grayscale`}>
                        <div className="w-full h-full flex items-center justify-center gap-2" style={{ backgroundColor: accent }}>
                            <span className="text-white font-black text-lg tracking-widest">SELECCIONA ENTRADAS</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="components/hud/SettingsPanel.tsx">
'use client'
import { useEventStore } from '@/store/useEventStore'
import { supabase } from '@/lib/supabase' 
import { Settings, Lock, Unlock, DollarSign, Eye, ShieldCheck, TrendingUp, FileText } from 'lucide-react'
import { useState, useEffect } from 'react'

export default function SettingsPanel() {
  const { eventData, updateSettings } = useEventStore()
  const [updating, setUpdating] = useState(false)
  
  // ESTADO LOCAL: Inicializamos en null para no asumir nada hasta confirmar con la DB
  const [currentStatus, setCurrentStatus] = useState<string | null>(null)

  // 1. EFECTO DE VERDAD ABSOLUTA
  // Al montar el componente, preguntamos directamente a la base de datos cómo está el evento.
  // Esto corrige el error de que el store pueda tener datos viejos o incompletos.
  useEffect(() => {
    const fetchRealStatus = async () => {
        if (!eventData?.id) return

        const { data, error } = await supabase
            .from('events')
            .select('status')
            .eq('id', eventData.id)
            .single()

        if (data && !error) {
            setCurrentStatus(data.status)
        } else {
            // Fallback: si falla la carga, usamos lo que diga el store o 'draft' por seguridad
            setCurrentStatus(eventData.status || 'draft')
        }
    }

    fetchRealStatus()
  }, [eventData?.id]) // Se ejecuta cuando tenemos el ID del evento

  const totalRevenue = eventData.tickets?.reduce((acc: number, ticket: any) => acc + (ticket.price * ticket.quantity), 0) || 0

  const handleStatusChange = async (targetStatus: 'active' | 'draft') => {
    if (updating || !eventData.id) return
    setUpdating(true)
    
    // UI Optimista: Actualizamos visualmente de inmediato
    setCurrentStatus(targetStatus)

    const isPrivate = targetStatus === 'draft'

    try {
        // 1. Actualizamos Store (para mantener consistencia si navegas)
        updateSettings({ isPrivate })

        // 2. Actualizamos Base de Datos
        const { error } = await supabase
            .from('events')
            .update({ status: targetStatus })
            .eq('id', eventData.id)

        if (error) {
            console.error('Error actualizando:', error)
            // Revertimos si hubo error
            setCurrentStatus(targetStatus === 'active' ? 'draft' : 'active')
        }
    } catch (err) {
        console.error("Error:", err)
    } finally {
        setUpdating(false)
    }
  }

  // Lógica de visualización:
  // Es "Público" si el status es 'active' o 'published'
  // Es "Borrador" si es cualquier otra cosa o null (por seguridad)
  const isPublic = currentStatus === 'active' || currentStatus === 'published'

  return (
    <div className="space-y-8 animate-in slide-in-from-left duration-300 pb-10">
      <div>
        <h2 className="text-xl font-bold text-white mb-1">Configuración Final</h2>
        <p className="text-zinc-500 text-xs">Reglas de negocio y economía del evento.</p>
      </div>

      <div className="bg-gradient-to-br from-zinc-900 to-black border border-white/5 rounded-2xl p-6 relative overflow-hidden group">
         <div className="absolute -right-4 -top-4 opacity-5 group-hover:opacity-10 transition-opacity">
            <DollarSign size={120} className="text-green-500" />
         </div>
         <h3 className="text-zinc-500 text-[10px] uppercase font-black mb-1 tracking-widest">Capacidad de Recaudación</h3>
         <div className="text-3xl font-black text-white">${totalRevenue.toLocaleString('es-CL')}</div>
         <div className="mt-4 flex gap-4">
            <div className="text-[10px] text-zinc-400 font-bold">FEES: <span className="text-white">DyzGO 7%</span></div>
            <div className="text-[10px] text-zinc-400 font-bold">NETO EST: <span className="text-green-400">${(totalRevenue * 0.93).toLocaleString('es-CL')}</span></div>
         </div>
      </div>

      {/* REVENTA Y MARKETPLACE */}
      <div className="space-y-4 p-5 bg-purple-600/5 border border-purple-500/20 rounded-2xl">
          <div className="flex items-center gap-2 mb-2">
            <ShieldCheck size={18} className="text-purple-400" />
            <h3 className="text-sm font-bold text-white">DyzGO Marketplace</h3>
          </div>

          <div className="flex items-center justify-between">
            <span className="text-xs text-zinc-300">Permitir Reventa (Safe-Swap)</span>
            <ToggleButton active={eventData.settings.allowMarketplace} onClick={() => updateSettings({ allowMarketplace: !eventData.settings.allowMarketplace })} />
          </div>

          <div className="flex items-center justify-between">
            <span className="text-xs text-zinc-300">Permitir Reventa con Sobreprecio</span>
            <ToggleButton active={eventData.settings.allowOverprice} onClick={() => updateSettings({ allowOverprice: !eventData.settings.allowOverprice })} />
          </div>
      </div>

      {/* ESTADO DEL EVENTO */}
      <div className="space-y-3">
        <label className="text-xs font-bold text-zinc-500 uppercase tracking-widest">Estado del Evento</label>
        <div className="grid grid-cols-2 gap-3">
            <VisibilityBtn 
                active={isPublic} 
                onClick={() => handleStatusChange('active')} 
                icon={<Eye size={18}/>} 
                label="Público" 
                desc="Visible en App y SEO" 
                disabled={updating}
            />
            <VisibilityBtn 
                active={!isPublic} 
                onClick={() => handleStatusChange('draft')} 
                icon={<FileText size={18}/>} 
                label="Borrador" 
                desc="Solo visible por ti" 
                disabled={updating}
            />
        </div>
      </div>
    </div>
  )
}

function ToggleButton({ active, onClick }: any) {
    return (
        <button onClick={onClick} className={`w-10 h-5 rounded-full transition-all relative ${active ? 'bg-purple-600' : 'bg-zinc-800'}`}>
            <div className={`absolute top-1 w-3 h-3 rounded-full bg-white transition-all ${active ? 'left-6' : 'left-1'}`} />
        </button>
    )
}

function VisibilityBtn({ active, onClick, icon, label, desc, disabled }: any) {
    return (
        <button 
            onClick={onClick} 
            disabled={disabled}
            className={`p-4 rounded-xl border text-left flex flex-col gap-2 transition-all ${
                active 
                ? 'bg-purple-900/20 border-purple-500 text-white' 
                : 'bg-zinc-900 border-zinc-800 text-zinc-500 hover:bg-zinc-800'
            } ${disabled ? 'opacity-50 cursor-wait' : ''}`}
        >
            {icon}
            <div>
                <div className="font-bold text-xs">{label}</div>
                <div className="text-[9px] opacity-70">{desc}</div>
            </div>
        </button>
    )
}
</file>

<file path="components/hud/TicketPanel.tsx">
'use client'
import { useState, forwardRef } from 'react' 
import { 
  Plus, Trash2, UserCheck, 
  Calendar, Clock, Ghost, Eye, EyeOff, ChevronDown, ChevronUp, Save, X, AlertTriangle, Slash,
  Ticket as TicketIcon, Gift, Settings, Tag, Layers
} from 'lucide-react'
import { useEventStore, Ticket } from '@/store/useEventStore'
import DatePicker, { registerLocale } from 'react-datepicker' 
import "react-datepicker/dist/react-datepicker.css"
import { es } from 'date-fns/locale/es'

registerLocale('es', es)

const datePickerStyles = `
  .react-datepicker-wrapper { width: 100%; }
  .react-datepicker-popper { z-index: 9999 !important; }
  .react-datepicker { 
    font-family: inherit; 
    background-color: #09090b; 
    border: 1px solid #27272a; 
    color: white; 
    border-radius: 0.75rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
  }
  .react-datepicker__header { 
    background-color: #09090b; 
    border-bottom: 1px solid #27272a; 
    border-top-left-radius: 0.75rem;
    border-top-right-radius: 0.75rem;
  }
  .react-datepicker__current-month, .react-datepicker__day-name, .react-datepicker-time__header { 
    color: #a1a1aa !important; 
  }
  .react-datepicker__day { 
    color: #e4e4e7; 
  }
  .react-datepicker__day:hover { 
    background-color: #27272a !important; 
  }
  .react-datepicker__day--selected { 
    background-color: #9333ea !important; 
    color: white !important;
  }
  .react-datepicker__day--disabled {
    color: #3f3f46 !important;
  }
  
  /* Selector de Hora y Scrollbar Estética */
  .react-datepicker__time-container { 
    border-left: 1px solid #27272a !important;
    background-color: #09090b !important;
    width: 85px !important;
  }
  .react-datepicker__time {
    background-color: #09090b !important;
    border-bottom-right-radius: 0.75rem;
  }
  .react-datepicker__time-box {
    width: 100% !important;
    background-color: #09090b !important;
  }
  .react-datepicker__time-list {
    scrollbar-width: thin;
    scrollbar-color: #3f3f46 #09090b;
  }
  .react-datepicker__time-list::-webkit-scrollbar {
    width: 5px;
  }
  .react-datepicker__time-list::-webkit-scrollbar-track {
    background: #09090b;
  }
  .react-datepicker__time-list::-webkit-scrollbar-thumb {
    background: #3f3f46;
    border-radius: 10px;
  }
  .react-datepicker__time-list-item {
    background-color: #09090b !important;
    color: #e4e4e7 !important;
  }
  .react-datepicker__time-list-item:hover { 
    background-color: #27272a !important; 
  }
  .react-datepicker__time-list-item--selected { 
    background-color: #9333ea !important; 
    color: white !important;
  }

  /* Eliminar flechas de inputs numéricos */
  input[type=number]::-webkit-inner-spin-button, 
  input[type=number]::-webkit-outer-spin-button { 
    -webkit-appearance: none; 
    margin: 0; 
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
`

const INITIAL_TICKET_STATE: Omit<Ticket, 'id'> = {
  name: '', price: 0, quantity: 0, description: '', startDate: '', endDate: '', 
  isGhostSoldOut: false, isActive: true, isNominative: false, type: 'paid', color: 'purple',
  ticketsIncluded: 1
}

export default function TicketPanel() {
  const { eventData, addTicket, removeTicket, updateTicket } = useEventStore()
  const [isCreating, setIsCreating] = useState(false)
  const [showAdvanced, setShowAdvanced] = useState(false) 
  const [showAdvancedEdit, setShowAdvancedEdit] = useState(false) 
  const [expandedTicketId, setExpandedTicketId] = useState<string | null>(null)
  const [ticketToDelete, setTicketToDelete] = useState<string | null>(null) 
  
  const [newTicketForm, setNewTicketForm] = useState({ ...INITIAL_TICKET_STATE, price: '', quantity: '' })

  const parseDate = (dateStr?: string) => {
      if (!dateStr) return null
      const datePart = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;
      const [year, month, day] = datePart.split('-').map(Number)
      return new Date(year, month - 1, day)
  }

  const parseTime = (dateStr?: string) => {
      if (!dateStr) return null
      const timePart = dateStr.includes('T') ? dateStr.split('T')[1]?.slice(0, 5) : '';
      if (!timePart) return null
      const [hours, minutes] = timePart.split(':').map(Number)
      const date = new Date(); date.setHours(hours); date.setMinutes(minutes)
      return date
  }

  const handleNewTicketDate = (type: 'start' | 'end', value: Date | null, mode: 'date' | 'time') => {
      if (!value) return
      const currentIso = type === 'start' ? newTicketForm.startDate : newTicketForm.endDate
      const baseDate = currentIso ? new Date(currentIso) : new Date()
      
      if (mode === 'date') baseDate.setFullYear(value.getFullYear(), value.getMonth(), value.getDate())
      else baseDate.setHours(value.getHours(), value.getMinutes())
      
      setNewTicketForm({
          ...newTicketForm,
          [type === 'start' ? 'startDate' : 'endDate']: baseDate.toISOString()
      })
  }

  const handleUpdateDateTime = (ticketId: string, type: 'start' | 'end', value: Date | null, mode: 'date' | 'time') => {
      if (!value) return
      const currentIso = type === 'start' ? eventData.tickets.find(t => t.id === ticketId)?.startDate : eventData.tickets.find(t => t.id === ticketId)?.endDate
      const baseDate = currentIso ? new Date(currentIso) : new Date()
      if (mode === 'date') baseDate.setFullYear(value.getFullYear(), value.getMonth(), value.getDate())
      else baseDate.setHours(value.getHours(), value.getMinutes())
      const newIso = baseDate.toISOString()
      updateTicket(ticketId, { [type === 'start' ? 'startDate' : 'endDate']: newIso })
  }

  const CustomInput = forwardRef(({ value, onClick, placeholder, icon }: any, ref: any) => (
    <div onClick={onClick} ref={ref} className="relative w-full bg-black border border-zinc-800 rounded-lg px-3 py-2 cursor-pointer hover:border-zinc-600 transition-colors flex items-center justify-between gap-3 h-[38px]">
        <span className={`text-xs ${value ? 'text-zinc-300' : 'text-zinc-600'}`}>{value || placeholder}</span>
        <div className="text-zinc-500">{icon}</div>
    </div>
  ))
  CustomInput.displayName = 'CustomInput'

  const handleAdd = () => {
    if (!newTicketForm.name || (newTicketForm.type === 'paid' && !newTicketForm.price)) return
    
    // Validamos que sea al menos 1
    const finalTicketsIncluded = Math.max(1, Number(newTicketForm.ticketsIncluded) || 1);

    addTicket({
        ...newTicketForm,
        price: newTicketForm.type === 'courtesy' ? 0 : Number(newTicketForm.price),
        isActive: newTicketForm.type === 'paid' ? newTicketForm.isActive : false, 
        quantity: Number(newTicketForm.quantity) || 100,
        color: newTicketForm.type === 'courtesy' ? 'pink' : 'purple',
        startDate: newTicketForm.startDate || undefined,
        endDate: newTicketForm.endDate || undefined,
        type: newTicketForm.type,
        isGhostSoldOut: newTicketForm.type === 'courtesy' ? false : newTicketForm.isGhostSoldOut,
        ticketsIncluded: finalTicketsIncluded
    })
    setNewTicketForm({ ...INITIAL_TICKET_STATE, price: '', quantity: '' })
    setIsCreating(false)
    setShowAdvanced(false)
  }

  const confirmDelete = () => {
    if (ticketToDelete) {
        removeTicket(ticketToDelete)
        setTicketToDelete(null)
    }
  }

  return (
    <div className="space-y-6 pb-20 relative">
      <style>{datePickerStyles}</style>
      <div className="flex justify-between items-center">
        <div><h2 className="text-xl font-bold text-white">Motor de Tickets</h2><p className="text-xs text-zinc-500">Gestiona precios, stock y reglas.</p></div>
      </div>

      {!isCreating ? (
          <button onClick={() => setIsCreating(true)} className="w-full py-3 bg-zinc-900 border border-zinc-800 border-dashed text-zinc-400 font-bold rounded-xl text-sm hover:bg-zinc-800 transition-all flex items-center justify-center gap-2"><Plus size={16} /> Agregar Nuevo Ticket</button>
      ) : (
          <div className="bg-zinc-900/80 border border-zinc-700 p-4 rounded-xl space-y-4 animate-in zoom-in-95">
            <div className="flex justify-between items-center"><h3 className="text-sm font-bold text-white">Nuevo Ticket</h3><button onClick={() => setIsCreating(false)}><X size={16} className="text-zinc-500 hover:text-white"/></button></div>
            <div className="grid grid-cols-2 gap-2 p-1 bg-black/40 rounded-xl border border-zinc-800/50">
                <button onClick={() => setNewTicketForm({...newTicketForm, type: 'paid', isActive: true})} className={`flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all ${newTicketForm.type === 'paid' ? 'bg-zinc-800 text-white shadow-sm' : 'text-zinc-500'}`}><TicketIcon size={14} /> Pagado</button>
                <button onClick={() => setNewTicketForm({...newTicketForm, type: 'courtesy', price: '0', isActive: false, isGhostSoldOut: false, ticketsIncluded: 1})} className={`flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all ${newTicketForm.type === 'courtesy' ? 'bg-pink-900/30 text-pink-400 border border-pink-500/20' : 'text-zinc-500'}`}><Gift size={14} /> Cortesía</button>
            </div>
            <div className="space-y-3">
                <input value={newTicketForm.name} onChange={(e) => setNewTicketForm({...newTicketForm, name: e.target.value})} placeholder="Nombre (ej: Promo 2x1)" className="w-full bg-black border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-purple-500" />
                
                <div className="grid grid-cols-2 gap-3">
                    <div><label className="text-[10px] text-zinc-500 font-bold uppercase mb-1 block">Precio Total</label>{newTicketForm.type === 'paid' ? <input value={newTicketForm.price} onChange={(e) => setNewTicketForm({...newTicketForm, price: e.target.value})} type="number" placeholder="$ 0" className="w-full bg-black border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white outline-none" /> : <div className="w-full bg-zinc-800/50 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-500 italic">Gratis (Cortesía)</div>}</div>
                    <div><label className="text-[10px] text-zinc-500 font-bold uppercase mb-1 block">Stock (Packs)</label><input value={newTicketForm.quantity} onChange={(e) => setNewTicketForm({...newTicketForm, quantity: e.target.value})} type="number" placeholder="100" className="w-full bg-black border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white outline-none" /></div>
                </div>

                {/* CASILLA UNICA PARA CANTIDAD DE TICKETS */}
                {newTicketForm.type === 'paid' && (
                    <div className="bg-black/20 border border-zinc-800 rounded-lg p-3 flex items-center justify-between">
                        <div>
                            <label className="text-[10px] text-zinc-500 font-bold uppercase flex items-center gap-1">
                                <Layers size={12} /> Tickets por compra
                            </label>
                            <p className="text-[9px] text-zinc-600 mt-0.5 max-w-[180px]">
                                Cantidad de QRs que se generarán al comprar 1 unidad de este ticket.
                            </p>
                        </div>
                        <div className="w-20">
                            <input 
                                type="number" 
                                min="1"
                                value={newTicketForm.ticketsIncluded} 
                                onChange={(e) => setNewTicketForm({...newTicketForm, ticketsIncluded: Math.max(1, Number(e.target.value))})} 
                                className="w-full bg-black border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-blue-500 text-center font-bold" 
                            />
                        </div>
                    </div>
                )}

                <div className="pt-2">
                    <button onClick={() => setShowAdvanced(!showAdvanced)} className="flex items-center gap-2 text-xs font-bold text-zinc-400 hover:text-white transition-colors">
                        {showAdvanced ? <ChevronUp size={14}/> : <Settings size={14} />} Configuración Avanzada
                    </button>

                    {showAdvanced && (
                        <div className="mt-3 space-y-4 animate-in slide-in-from-top-2">
                            <div>
                                <label className="text-[10px] text-zinc-500 font-bold uppercase mb-1 block">Descripción</label>
                                <textarea 
                                    value={newTicketForm.description} 
                                    onChange={(e) => setNewTicketForm({...newTicketForm, description: e.target.value})}
                                    placeholder="Detalles adicionales para este ticket..." 
                                    className="w-full bg-black border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-purple-500 min-h-[80px] resize-none placeholder:text-zinc-600"
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div className="space-y-2">
                                    <label className="text-[10px] text-zinc-500 font-bold uppercase flex items-center gap-1"><Calendar size={10}/> Fecha Inicio</label>
                                    <DatePicker selected={parseDate(newTicketForm.startDate)} onChange={(d) => handleNewTicketDate('start', d, 'date')} dateFormat="dd/MM/yyyy" customInput={<CustomInput placeholder="Seleccionar Fecha" icon={<Calendar size={14}/>} />} locale="es" />
                                    <DatePicker selected={parseTime(newTicketForm.startDate)} onChange={(d) => handleNewTicketDate('start', d, 'time')} showTimeSelect showTimeSelectOnly timeIntervals={30} timeCaption="Hora" dateFormat="HH:mm" customInput={<CustomInput placeholder="Seleccionar Hora" icon={<Clock size={14}/>} />} locale="es" />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] text-zinc-500 font-bold uppercase flex items-center gap-1"><Calendar size={10}/> Fecha Fin</label>
                                    <DatePicker selected={parseDate(newTicketForm.endDate)} onChange={(d) => handleNewTicketDate('end', d, 'date')} dateFormat="dd/MM/yyyy" customInput={<CustomInput placeholder="Seleccionar Fecha" icon={<Calendar size={14}/>} />} locale="es" />
                                    <DatePicker selected={parseTime(newTicketForm.endDate)} onChange={(d) => handleNewTicketDate('end', d, 'time')} showTimeSelect showTimeSelectOnly timeIntervals={30} timeCaption="Hora" dateFormat="HH:mm" customInput={<CustomInput placeholder="Seleccionar Hora" icon={<Clock size={14}/>} />} locale="es" />
                                </div>
                            </div>

                            <div className="grid grid-cols-3 gap-2 pt-2">
                                {newTicketForm.type === 'courtesy' ? (
                                    <div className="flex flex-col items-center justify-center gap-1 p-3 rounded-xl border border-zinc-800 bg-black/50 text-zinc-600 opacity-50 cursor-not-allowed"><EyeOff size={18} /><span className="text-[9px] font-bold">SIEMPRE OCULTO</span></div>
                                ) : (
                                    <button onClick={() => setNewTicketForm({...newTicketForm, isActive: !newTicketForm.isActive})} className={`flex flex-col items-center justify-center gap-1 p-3 rounded-xl border text-[10px] font-bold transition-all ${newTicketForm.isActive ? 'bg-green-900/20 border-green-500/50 text-green-400' : 'bg-black border-zinc-800 text-zinc-600 hover:border-zinc-700'}`}>{newTicketForm.isActive ? <Eye size={18} /> : <EyeOff size={18} />} VISIBLE</button>
                                )}
                                
                                <button onClick={() => setNewTicketForm({...newTicketForm, isNominative: !newTicketForm.isNominative})} className={`flex flex-col items-center justify-center gap-1 p-3 rounded-xl border text-[10px] font-bold transition-all ${newTicketForm.isNominative ? 'bg-blue-900/20 border-blue-500/50 text-blue-400' : 'bg-black border-zinc-800 text-zinc-600 hover:border-zinc-700'}`}><UserCheck size={18} /> NOMINATIVO</button>
                                
                                <button 
                                    disabled={newTicketForm.type === 'courtesy'}
                                    onClick={() => setNewTicketForm({...newTicketForm, isGhostSoldOut: !newTicketForm.isGhostSoldOut})} 
                                    className={`flex flex-col items-center justify-center gap-1 p-3 rounded-xl border text-[10px] font-bold transition-all ${newTicketForm.type === 'courtesy' ? 'opacity-30 cursor-not-allowed border-zinc-800 text-zinc-600' : (newTicketForm.isGhostSoldOut ? 'bg-red-900/20 border-red-500/50 text-red-400' : 'bg-black border-zinc-800 text-zinc-600 hover:border-zinc-700')}`}
                                >
                                    <Ghost size={18} /> FAKE SOLD OUT
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            </div>
            <button onClick={handleAdd} className="w-full py-2.5 bg-white text-black font-bold rounded-lg text-sm hover:bg-zinc-200 flex items-center justify-center gap-2 mt-2"><Save size={16} /> Guardar Ticket</button>
          </div>
      )}

      <div className="space-y-3">
        {eventData.tickets.map((t) => {
            const isExpanded = expandedTicketId === t.id
            const isCourtesy = t.type === 'courtesy' || t.price === 0; 
            
            return (
                <div key={t.id} className={`bg-zinc-900 border transition-all duration-300 rounded-xl overflow-hidden ${isExpanded ? 'border-purple-500/50 shadow-lg shadow-purple-900/10' : 'border-zinc-800'}`}>
                    <div className="p-4 flex justify-between items-center cursor-pointer" onClick={() => { 
                        if (expandedTicketId === t.id) {
                            setExpandedTicketId(null); 
                        } else {
                            setExpandedTicketId(t.id);
                            setShowAdvancedEdit(false); 
                        }
                    }}>
                        <div className="flex items-center gap-3">
                            <div className={`w-2 h-10 rounded-full ${isCourtesy ? 'bg-pink-500 shadow-[0_0_10px_rgba(236,72,153,0.5)]' : (t.isGhostSoldOut ? 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]' : (t.isActive ? 'bg-green-500' : 'bg-zinc-700'))}`}></div>
                            <div>
                                <h3 className={`font-bold text-sm text-white flex items-center gap-2`}>
                                    {t.name}
                                    {t.ticketsIncluded && t.ticketsIncluded > 1 && (
                                        <span className="bg-blue-500/20 text-blue-300 text-[9px] px-1.5 py-0.5 rounded border border-blue-500/30 uppercase font-black tracking-wider">
                                            Genera {t.ticketsIncluded} QRs
                                        </span>
                                    )}
                                </h3>
                                <div className="flex items-center gap-2 text-xs">
                                    {isCourtesy ? <span className="text-pink-400 font-bold uppercase text-[10px] border border-pink-500/20 bg-pink-500/10 px-1.5 rounded flex items-center gap-1"><Gift size={10} /> Cortesía</span> : <span className="text-purple-400 font-mono font-bold">${t.price.toLocaleString()}</span>}
                                    <span className="text-zinc-600">•</span>
                                    {t.isGhostSoldOut ? (
                                        <span className="text-red-500 font-bold uppercase">SOLD OUT</span>
                                    ) : (
                                        <span className="text-zinc-400">{t.quantity} un.</span>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={(e) => { e.stopPropagation(); setTicketToDelete(t.id); }} className="p-2 text-zinc-600 hover:text-red-500"><Trash2 size={16} /></button>
                            {isExpanded ? <ChevronUp size={16} className="text-zinc-500"/> : <ChevronDown size={16} className="text-zinc-500"/>}
                        </div>
                    </div>

                    {isExpanded && (
                        <div className="p-4 pt-0 border-t border-zinc-800/50 bg-black/20 space-y-5">
                            
                            <div className="mt-4">
                                <label className="text-[10px] text-zinc-500 font-bold uppercase block mb-1">Nombre</label>
                                <input value={t.name} onChange={(e) => updateTicket(t.id, { name: e.target.value })} className="w-full bg-black border border-zinc-800 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-purple-500" />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[10px] text-zinc-500 font-bold uppercase mb-1 block">Precio Total</label>
                                    {t.type === 'courtesy' ? (
                                        <div className="w-full bg-zinc-800/50 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-500 italic">Gratis (Cortesía)</div>
                                    ) : (
                                        <input type="number" value={t.price} onChange={(e) => updateTicket(t.id, { price: Number(e.target.value) })} className="w-full bg-black border border-zinc-800 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-purple-500" />
                                    )}
                                </div>
                                <div>
                                    <label className="text-[10px] text-zinc-500 font-bold uppercase block mb-1">Stock</label>
                                    <input type="number" value={t.quantity} onChange={(e) => updateTicket(t.id, { quantity: parseInt(e.target.value) || 0 })} className="w-full bg-black border border-zinc-800 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-purple-500" />
                                </div>
                            </div>

                            {/* SECCIÓN DE EDICIÓN DE CANTIDAD DE TICKETS */}
                            {!isCourtesy && (
                                <div className="bg-black/20 border border-zinc-800 rounded-lg p-3 flex items-center justify-between">
                                    <div>
                                        <label className="text-[10px] text-zinc-500 font-bold uppercase flex items-center gap-1">
                                            <Layers size={12} /> Tickets por compra
                                        </label>
                                        <p className="text-[9px] text-zinc-600 mt-0.5 max-w-[180px]">
                                            Cantidad de QRs generados por unidad.
                                        </p>
                                    </div>
                                    <div className="w-20">
                                        <input 
                                            type="number" 
                                            min="1"
                                            value={t.ticketsIncluded || 1} 
                                            onChange={(e) => updateTicket(t.id, { ticketsIncluded: Math.max(1, Number(e.target.value)) })} 
                                            className="w-full bg-black border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-blue-500 text-center font-bold" 
                                        />
                                    </div>
                                </div>
                            )}

                            {/* --- CONFIGURACIÓN AVANZADA (EDICIÓN) --- */}
                            <div className="pt-2">
                                <button onClick={() => setShowAdvancedEdit(!showAdvancedEdit)} className="flex items-center gap-2 text-xs font-bold text-zinc-400 hover:text-white transition-colors">
                                    {showAdvancedEdit ? <ChevronUp size={14}/> : <Settings size={14} />} Configuración Avanzada
                                </button>

                                {showAdvancedEdit && (
                                    <div className="mt-3 space-y-4 animate-in slide-in-from-top-2">
                                            <div>
                                                <label className="text-[10px] text-zinc-500 font-bold uppercase mb-1 block">Descripción</label>
                                                <textarea 
                                                    value={t.description || ''} 
                                                    onChange={(e) => updateTicket(t.id, { description: e.target.value })}
                                                    placeholder="Detalles adicionales para este ticket..." 
                                                    className="w-full bg-black border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-purple-500 min-h-[80px] resize-none placeholder:text-zinc-600"
                                                />
                                            </div>

                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="space-y-2">
                                                    <label className="text-[10px] text-zinc-500 font-bold uppercase flex items-center gap-1"><Calendar size={10}/> Fecha Inicio</label>
                                                    <DatePicker selected={parseDate(t.startDate)} onChange={(d) => handleUpdateDateTime(t.id, 'start', d, 'date')} dateFormat="dd/MM/yyyy" customInput={<CustomInput placeholder="Seleccionar Fecha" icon={<Calendar size={14}/>} />} locale="es" />
                                                    <DatePicker selected={parseTime(t.startDate)} onChange={(d) => handleUpdateDateTime(t.id, 'start', d, 'time')} showTimeSelect showTimeSelectOnly timeIntervals={30} timeCaption="Hora" dateFormat="HH:mm" customInput={<CustomInput placeholder="Seleccionar Hora" icon={<Clock size={14}/>} />} locale="es" />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className="text-[10px] text-zinc-500 font-bold uppercase flex items-center gap-1"><Calendar size={10}/> Fecha Fin</label>
                                                    <DatePicker selected={parseDate(t.endDate)} onChange={(d) => handleUpdateDateTime(t.id, 'end', d, 'date')} dateFormat="dd/MM/yyyy" customInput={<CustomInput placeholder="Seleccionar Fecha" icon={<Calendar size={14}/>} />} locale="es" />
                                                    <DatePicker selected={parseTime(t.endDate)} onChange={(d) => handleUpdateDateTime(t.id, 'end', d, 'time')} showTimeSelect showTimeSelectOnly timeIntervals={30} timeCaption="Hora" dateFormat="HH:mm" customInput={<CustomInput placeholder="Seleccionar Hora" icon={<Clock size={14}/>} />} locale="es" />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 gap-2 pt-2">
                                                {isCourtesy ? (
                                                    <div className="flex flex-col items-center justify-center gap-1 p-2 rounded-lg border border-zinc-800 bg-black/50 text-zinc-600 opacity-50 cursor-not-allowed"><EyeOff size={16} /><span className="text-[9px] font-bold">SIEMPRE OCULTO</span></div>
                                                ) : (
                                                    <button onClick={() => updateTicket(t.id, { isActive: !t.isActive })} className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg border text-[10px] font-bold transition-all ${t.isActive ? 'bg-green-900/20 border-green-500/50 text-green-400' : 'bg-black border-zinc-800 text-zinc-600'}`}>{t.isActive ? <Eye size={16} /> : <EyeOff size={16} />} {t.isActive ? 'VISIBLE' : 'OCULTO'}</button>
                                                )}
                                                <button onClick={() => updateTicket(t.id, { isNominative: !t.isNominative })} className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg border text-[10px] font-bold transition-all ${t.isNominative ? 'bg-blue-900/20 border-blue-500/50 text-blue-400' : 'bg-black border-zinc-800 text-zinc-600'}`}><UserCheck size={16} /> NOMINATIVO</button>
                                                
                                                <button 
                                                    disabled={isCourtesy}
                                                    onClick={() => updateTicket(t.id, { isGhostSoldOut: !t.isGhostSoldOut })} 
                                                    className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg border text-[10px] font-bold transition-all ${isCourtesy ? 'opacity-30 cursor-not-allowed border-zinc-800 text-zinc-600' : (t.isGhostSoldOut ? 'bg-red-900/20 border-red-500/50 text-red-400' : 'bg-black border-zinc-800 text-zinc-600')}`}
                                                >
                                                    <Ghost size={16} /> FAKE SOLD OUT
                                                </button>
                                            </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            )
        })}
      </div>
      {ticketToDelete && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"><div className="bg-[#09090b] border border-zinc-800 rounded-2xl p-6 max-w-sm w-full"><div className="flex flex-col items-center text-center gap-4"><div className="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center border border-red-500/20"><AlertTriangle className="text-red-500" size={24} /></div><div><h3 className="text-lg font-bold text-white mb-2">¿Eliminar Ticket?</h3><p className="text-sm text-zinc-400">Esta acción no se puede deshacer.</p></div><div className="flex gap-3 w-full"><button onClick={() => setTicketToDelete(null)} className="flex-1 py-3 bg-zinc-900 text-white rounded-xl text-sm font-bold">Cancelar</button><button onClick={confirmDelete} className="flex-1 py-3 bg-red-600 text-white rounded-xl text-sm font-bold">Sí, Eliminar</button></div></div></div></div>}
    </div>
  )
}
</file>

<file path="components/providers/org-provider.tsx">
'use client'
import { createContext, useContext, useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'
import { useRouter } from 'next/navigation'

interface OrgContextType {
  currentOrgId: string | null
  currentRole: 'owner' | 'admin' | 'finance' | 'staff'
  availableOrgs: any[]
  pendingInvites: any[]
  switchOrg: (orgId: string) => void
  createNewOrg: () => void
  deleteOrg: (orgId: string) => Promise<void>
  acceptInvite: (inviteId: string) => Promise<void>
  rejectInvite: (inviteId: string) => Promise<void> // NUEVA FUNCIÓN
  refreshOrgs: () => Promise<void>
  isLoading: boolean
}

const OrgContext = createContext<OrgContextType>({
  currentOrgId: null,
  currentRole: 'owner',
  availableOrgs: [],
  pendingInvites: [],
  switchOrg: () => {},
  createNewOrg: () => {},
  deleteOrg: async () => {},
  acceptInvite: async () => {},
  rejectInvite: async () => {}, // Inicialización
  refreshOrgs: async () => {},
  isLoading: true
})

export function OrgProvider({ children }: { children: React.ReactNode }) {
  const [currentOrgId, setCurrentOrgId] = useState<string | null>(null)
  const [currentRole, setCurrentRole] = useState<any>('owner')
  const [availableOrgs, setAvailableOrgs] = useState<any[]>([])
  const [pendingInvites, setPendingInvites] = useState<any[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const router = useRouter()

  useEffect(() => {
    fetchOrganizations()
  }, [])

  async function fetchOrganizations() {
    try {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return

      // 1. Mis Productoras
      const { data: myOrgs } = await supabase
        .from('experiences')
        .select('id, name, logo_url')
        .eq('producer_id', user.id)

      // 2. Productoras Invitadas
      const { data: teamData } = await supabase
        .from('team_members')
        .select(`
            id, status, role, email,
            experience:experiences (id, name, logo_url)
        `)
        .or(`user_id.eq.${user.id},email.eq.${user.email}`)

      const activeOrgs: any[] = []
      const pending: any[] = []

      if (myOrgs) {
        myOrgs.forEach(org => activeOrgs.push({ ...org, role: 'owner', is_owner: true }))
      }

      if (teamData) {
        teamData.forEach((item: any) => {
            if (item.experience) {
                if (!activeOrgs.find(o => o.id === item.experience.id)) {
                    if (item.status === 'active') {
                        activeOrgs.push({ ...item.experience, role: item.role, is_owner: false })
                    } else if (item.status === 'pending') {
                        pending.push({ ...item.experience, invite_id: item.id, role: item.role, name: item.experience.name })
                    }
                }
            }
        })
      }

      setAvailableOrgs(activeOrgs)
      setPendingInvites(pending)

      // Selección automática si no hay nada seleccionado
      if (activeOrgs.length > 0 && currentOrgId === null) {
        const saved = localStorage.getItem('dyzgo_active_org')
        const found = activeOrgs.find(o => o.id === saved)
        if (found) {
            setCurrentOrgId(found.id)
            setCurrentRole(found.role)
        } else {
            setCurrentOrgId(activeOrgs[0].id)
            setCurrentRole(activeOrgs[0].role)
        }
      }

    } catch (error) {
      console.error(error)
    } finally {
      setIsLoading(false)
    }
  }

  const switchOrg = (orgId: string) => {
    const org = availableOrgs.find(o => o.id === orgId)
    if (org) {
        setCurrentOrgId(org.id)
        setCurrentRole(org.role)
        localStorage.setItem('dyzgo_active_org', org.id)
        setTimeout(() => router.refresh(), 100)
    }
  }

  const createNewOrg = () => {
      setCurrentOrgId('') 
      setCurrentRole('owner')
      router.push('/settings')
  }

  const deleteOrg = async (orgId: string) => {
      try {
          const { error } = await supabase.from('experiences').delete().eq('id', orgId)
          if (error) throw error
          if (localStorage.getItem('dyzgo_active_org') === orgId) {
              localStorage.removeItem('dyzgo_active_org')
          }
          setCurrentOrgId(null)
          await fetchOrganizations()
          router.push('/')
      } catch (error: any) {
          throw error
      }
  }

  const acceptInvite = async (inviteId: string) => {
    try {
        const { data: { user } } = await supabase.auth.getUser()
        const { error } = await supabase
            .from('team_members')
            .update({ status: 'active', user_id: user?.id })
            .eq('id', inviteId)
        
        if (error) throw error
        
        // RECARGA CRÍTICA: Esto actualiza availableOrgs para que aparezca en el select
        await fetchOrganizations() 
        alert("¡Invitación aceptada! Ya puedes seleccionar la productora en el menú.")
    } catch (e: any) {
        alert("Error al aceptar: " + e.message)
    }
  }

  // NUEVA FUNCIÓN: Rechazar (Borrar)
  const rejectInvite = async (inviteId: string) => {
    if(!confirm("¿Estás seguro de rechazar esta invitación?")) return
    try {
        const { error } = await supabase
            .from('team_members')
            .delete()
            .eq('id', inviteId)
        
        if (error) throw error
        
        await fetchOrganizations() // Recargar listas
        alert("Invitación rechazada.")
    } catch (e: any) {
        alert("Error al rechazar: " + e.message)
    }
  }

  return (
    <OrgContext.Provider value={{ currentOrgId, currentRole, availableOrgs, pendingInvites, switchOrg, createNewOrg, deleteOrg, acceptInvite, rejectInvite, refreshOrgs: fetchOrganizations, isLoading }}>
      {children}
    </OrgContext.Provider>
  )
}

export const useOrg = () => useContext(OrgContext)
</file>

<file path="components/ui/alert.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="components/ui/badge.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-full border border-transparent px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border-border text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
        ghost: "[a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
        link: "text-primary underline-offset-4 [a&]:hover:underline",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      data-variant={variant}
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }
</file>

<file path="components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        xs: "h-6 gap-1 rounded-md px-2 text-xs has-[>svg]:px-1.5 [&_svg:not([class*='size-'])]:size-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-xs": "size-6 rounded-md [&_svg:not([class*='size-'])]:size-3",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant = "default",
  size = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      data-variant={variant}
      data-size={size}
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }
</file>

<file path="components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
</file>

<file path="components/ui/select.tsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "item-aligned",
  align = "center",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        align={align}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span
        data-slot="select-item-indicator"
        className="absolute right-2 flex size-3.5 items-center justify-center"
      >
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}
</file>

<file path="components/ui/separator.tsx">
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }
</file>

<file path="components/ui/table.tsx">
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

function Tabs({
  className,
  orientation = "horizontal",
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      data-orientation={orientation}
      orientation={orientation}
      className={cn(
        "group/tabs flex gap-2 data-[orientation=horizontal]:flex-col",
        className
      )}
      {...props}
    />
  )
}

const tabsListVariants = cva(
  "rounded-lg p-[3px] group-data-[orientation=horizontal]/tabs:h-9 data-[variant=line]:rounded-none group/tabs-list text-muted-foreground inline-flex w-fit items-center justify-center group-data-[orientation=vertical]/tabs:h-fit group-data-[orientation=vertical]/tabs:flex-col",
  {
    variants: {
      variant: {
        default: "bg-muted",
        line: "gap-1 bg-transparent",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function TabsList({
  className,
  variant = "default",
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List> &
  VariantProps<typeof tabsListVariants>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      data-variant={variant}
      className={cn(tabsListVariants({ variant }), className)}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring text-foreground/60 hover:text-foreground dark:text-muted-foreground dark:hover:text-foreground relative inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-all group-data-[orientation=vertical]/tabs:w-full group-data-[orientation=vertical]/tabs:justify-start focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 group-data-[variant=default]/tabs-list:data-[state=active]:shadow-sm group-data-[variant=line]/tabs-list:data-[state=active]:shadow-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        "group-data-[variant=line]/tabs-list:bg-transparent group-data-[variant=line]/tabs-list:data-[state=active]:bg-transparent dark:group-data-[variant=line]/tabs-list:data-[state=active]:border-transparent dark:group-data-[variant=line]/tabs-list:data-[state=active]:bg-transparent",
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 data-[state=active]:text-foreground",
        "after:bg-foreground after:absolute after:opacity-0 after:transition-opacity group-data-[orientation=horizontal]/tabs:after:inset-x-0 group-data-[orientation=horizontal]/tabs:after:bottom-[-5px] group-data-[orientation=horizontal]/tabs:after:h-0.5 group-data-[orientation=vertical]/tabs:after:inset-y-0 group-data-[orientation=vertical]/tabs:after:-right-1 group-data-[orientation=vertical]/tabs:after:w-0.5 group-data-[variant=line]/tabs-list:data-[state=active]:after:opacity-100",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent, tabsListVariants }
</file>

<file path="lib/supabase.ts">
import { createBrowserClient } from '@supabase/ssr'

export const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)
</file>

<file path="lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="store/useEventStore.ts">
import { create } from 'zustand'
import { supabase } from '@/lib/supabase'
import { v4 as uuidv4 } from 'uuid'; 

export interface Ticket {
  id: string
  name: string
  price: number
  quantity: number
  color: string
  description?: string
  isNominative: boolean
  dependencyId?: string
  isActive?: boolean       
  isGhostSoldOut?: boolean 
  startDate?: string       
  endDate?: string         
  type?: 'paid' | 'courtesy'
  ticketsIncluded?: number 
}

const initialEventData: EventData = {
  id: null,
  name: '',
  venue: '',
  clubId: '', 
  address: '',
  region: '',
  commune: '',
  street: '',
  number: '',
  
  date: '',      
  endDate: '',   
  startTime: '', 
  endTime: '',   
  description: '',
  category: 'Reggaeton',
  musicGenre: '', 
  musicTags: [],
  prohibitedItems: [],
  minAgeMen: 21,
  minAgeWomen: 18,
  dressCode: 'Casual',
  socialLinks: { instagram: '', tiktok: '', website: '' },
  
  coverImage: null,
  
  themeColor: '#4a0e4d',          
  themeColorEnd: '#090014',       
  cardBackgroundColor: '#1a0b2e', 
  borderColor: '#8A2BE2',         
  accentColor: '#FF00FF',         
  
  borderRadius: 'rounded-[2rem]',   
  fontStyle: 'font-sans',       
  
  tickets: [],
  uploaded_dbs: [],
  ambassadors: [],
  settings: {
    isPrivate: false,
    absorbFee: false,
    showRemaining: true,
    allowMarketplace: true,
    allowOverprice: false,
    showInstagram: true 
  }
}

interface EventData {
  id: string | null
  name: string
  venue: string
  clubId?: string 
  address: string
  region: string
  commune: string
  street: string
  number: string

  date: string
  endDate: string
  startTime: string
  endTime: string
  description: string
  category: string
  musicGenre: string 
  musicTags: string[]
  prohibitedItems: string[]
  minAgeMen: number
  minAgeWomen: number
  dressCode: string
  coverImage: string | null
  
  themeColor: string      
  themeColorEnd: string   
  cardBackgroundColor: string 
  borderColor: string         
  accentColor: string   
  
  borderRadius: string  
  fontStyle: string     
  socialLinks: { instagram: string; tiktok: string; website: string }
  tickets: Ticket[]
  uploaded_dbs: any[]
  ambassadors: any[]
  settings: {
    isPrivate: boolean
    absorbFee: boolean
    showRemaining: boolean
    allowMarketplace: boolean
    allowOverprice: boolean
    showInstagram: boolean
  }
}

interface EventState {
  eventData: EventData
  activeSection: 'info' | 'tickets' | 'design' | 'settings' | 'experience'
  
  setEventName: (name: string) => void
  setEventVenue: (venue: string) => void
  setClubId: (id: string) => void 
  setEventAddress: (address: string) => void
  setEventRegion: (region: string) => void
  setEventCommune: (commune: string) => void
  setEventStreet: (street: string) => void
  setEventNumber: (number: string) => void

  setEventDate: (date: string) => void
  setEventEndDate: (date: string) => void
  setEventTime: (start: string, end: string) => void
  setCategory: (category: string) => void
  setMusicGenre: (genre: string) => Promise<void> 
  setExperience: (data: Partial<EventData>) => void
  setCoverImage: (url: string) => void
  
  setThemeColor: (color: string) => void
  setThemeColorEnd: (color: string) => void 
  setCardBackgroundColor: (color: string) => void 
  setBorderColor: (color: string) => void         
  setAccentColor: (color: string) => void   
  
  setBorderRadius: (radius: string) => void 
  setFontStyle: (font: string) => void      
  updateSettings: (settings: Partial<EventData['settings']> | Partial<EventData>) => void
  setActiveSection: (section: EventState['activeSection']) => void
  addTicket: (ticket: Omit<Ticket, 'id'>) => Promise<void>
  removeTicket: (id: string) => Promise<void>
  updateTicket: (id: string, data: Partial<Ticket>) => Promise<void>
  resetEvent: () => void
  loadEvent: (id: string) => Promise<void> 
}

export const useEventStore = create<EventState>((set, get) => ({
  eventData: initialEventData,
  activeSection: 'info',

  resetEvent: () => set({ eventData: initialEventData, activeSection: 'info' }),

  setEventName: (name) => set((state) => ({ eventData: { ...state.eventData, name } })),
  setEventVenue: (venue) => set((state) => ({ eventData: { ...state.eventData, venue } })),
  setClubId: (clubId) => set((state) => ({ eventData: { ...state.eventData, clubId } })), 
  setEventAddress: (address) => set((state) => ({ eventData: { ...state.eventData, address } })),
  
  setEventRegion: (region) => set((state) => ({ eventData: { ...state.eventData, region } })),
  setEventCommune: (commune) => set((state) => ({ eventData: { ...state.eventData, commune } })),
  setEventStreet: (street) => set((state) => ({ eventData: { ...state.eventData, street } })),
  setEventNumber: (number) => set((state) => ({ eventData: { ...state.eventData, number } })),

  setEventDate: (date) => set((state) => ({ eventData: { ...state.eventData, date } })),
  setEventEndDate: (endDate) => set((state) => ({ eventData: { ...state.eventData, endDate } })),
  setEventTime: (startTime, endTime) => set((state) => ({ eventData: { ...state.eventData, startTime, endTime } })),
  setCategory: (category) => set((state) => ({ eventData: { ...state.eventData, category } })),
  
  setMusicGenre: async (genre) => {
    set((state) => ({ eventData: { ...state.eventData, musicGenre: genre } }))
    const { id } = get().eventData
    if (id) {
       await supabase
        .from('events')
        .update({ music_genre: genre }) 
        .eq('id', id)
    }
  },

  setExperience: (data) => set((state) => ({ eventData: { ...state.eventData, ...data } })),
  setCoverImage: (coverImage) => set((state) => ({ eventData: { ...state.eventData, coverImage } })),
  
  setThemeColor: (color) => set((state) => ({ eventData: { ...state.eventData, themeColor: color } })),
  setThemeColorEnd: (color) => set((state) => ({ eventData: { ...state.eventData, themeColorEnd: color } })),
  setCardBackgroundColor: (color) => set((state) => ({ eventData: { ...state.eventData, cardBackgroundColor: color } })),
  setBorderColor: (color) => set((state) => ({ eventData: { ...state.eventData, borderColor: color } })),
  setAccentColor: (color) => set((state) => ({ eventData: { ...state.eventData, accentColor: color } })), 
  
  setBorderRadius: (radius) => set((state) => ({ eventData: { ...state.eventData, borderRadius: radius } })), 
  setFontStyle: (font) => set((state) => ({ eventData: { ...state.eventData, fontStyle: font } })), 
  
  updateSettings: (newSettings) => set((state) => {
    if ('isPrivate' in newSettings || 'absorbFee' in newSettings || 'showInstagram' in newSettings) {
      return { eventData: { ...state.eventData, settings: { ...state.eventData.settings, ...newSettings } } }
    }
    return { eventData: { ...state.eventData, ...newSettings } }
  }),

  setActiveSection: (section) => set({ activeSection: section }),

  // --- FUNCIÓN CORREGIDA ---
  loadEvent: async (id) => {
      // Pedimos ticket_tiers(*) para que traiga TODAS las columnas, incluida tickets_included
      const { data: event, error } = await supabase
        .from('events')
        .select(`
            *, 
            ticket_tiers(*)
        `)
        .eq('id', id)
        .single()
      
      if (error || !event) return;

      const tickets = event.ticket_tiers?.map((t: any) => ({
          id: t.id,
          name: t.name,
          price: t.price,
          quantity: t.total_stock,
          description: t.description,
          isActive: t.is_active,
          isNominative: t.nominative,
          isGhostSoldOut: t.fake_sold,
          startDate: t.sales_start_at,
          endDate: t.sales_end_at,
          type: t.type || 'paid', 
          color: (t.type === 'courtesy') ? 'pink' : 'purple',
          
          // AQUÍ ESTABA EL ERROR: Faltaba mapear tickets_included de la BD al store
          ticketsIncluded: t.tickets_included || 1 
      })) || []

      tickets.sort((a: Ticket, b: Ticket) => a.price - b.price);

      set({
          eventData: {
              ...initialEventData,
              id: event.id,
              name: event.title,
              venue: event.club_name,
              clubId: event.club_id, 
              address: event.address || '',
              region: event.region || '',
              commune: event.commune || '',
              street: event.street || '',
              number: event.number || '',
              date: event.date,
              endDate: event.end_date || '',
              startTime: event.start_time || '',
              endTime: event.end_time || '',
              description: event.description || '',
              musicGenre: event.music_genre || '',
              coverImage: event.image_url,
              
              themeColor: event.theme_color || initialEventData.themeColor,
              themeColorEnd: event.theme_color_end || initialEventData.themeColorEnd,
              cardBackgroundColor: event.card_background_color || initialEventData.cardBackgroundColor,
              borderColor: event.border_color || initialEventData.borderColor,
              accentColor: event.accent_color || initialEventData.accentColor,

              tickets: tickets,
              settings: {
                  ...initialEventData.settings,
                  isPrivate: event.status === 'draft', 
              }
          }
      })
  },

  addTicket: async (ticket) => {
    const currentState = get().eventData;
    const tempId = uuidv4(); 

    if (currentState.id) {
        const { data } = await supabase
          .from('ticket_tiers')
          .insert({
            event_id: currentState.id,
            name: ticket.name,
            description: ticket.description,
            price: ticket.price,
            total_stock: ticket.quantity,
            is_active: ticket.isActive,
            fake_sold: ticket.isGhostSoldOut, 
            nominative: ticket.isNominative,
            type: ticket.type || 'paid', 
            sales_start_at: ticket.startDate ? new Date(ticket.startDate).toISOString() : null,
            sales_end_at: ticket.endDate ? new Date(ticket.endDate).toISOString() : null,
            
            // Asegúrate que al crear también se guarde
            tickets_included: ticket.ticketsIncluded || 1
          })
          .select()
          .single()

        if (data) {
            set((state) => ({
                eventData: {
                  ...state.eventData,
                  tickets: [...state.eventData.tickets, { ...ticket, id: data.id }]
                }
            }))
        }
    } else {
        set((state) => ({
            eventData: {
              ...state.eventData,
              tickets: [...state.eventData.tickets, { ...ticket, id: tempId }]
            }
        }))
    }
  },

  removeTicket: async (id) => {
    const currentState = get().eventData;
    if (currentState.id) await supabase.from('ticket_tiers').delete().eq('id', id)
    set((state) => ({
      eventData: { ...state.eventData, tickets: state.eventData.tickets.filter((t) => t.id !== id) }
    }))
  },

  updateTicket: async (id, data) => {
    const currentState = get().eventData;
    
    // Actualización local inmediata (Optimistic UI)
    set((state) => ({
      eventData: {
        ...state.eventData,
        tickets: state.eventData.tickets.map((t) => t.id === id ? { ...t, ...data } : t)
      }
    }))

    // Actualización en Base de Datos
    if (currentState.id) {
        const dbPayload: any = {}
        if (data.name !== undefined) dbPayload.name = data.name
        if (data.price !== undefined) dbPayload.price = data.price
        if (data.quantity !== undefined) dbPayload.total_stock = data.quantity
        if (data.isActive !== undefined) dbPayload.is_active = data.isActive
        if (data.isGhostSoldOut !== undefined) dbPayload.fake_sold = data.isGhostSoldOut
        if (data.isNominative !== undefined) dbPayload.nominative = data.isNominative
        if (data.description !== undefined) dbPayload.description = data.description
        if (data.startDate !== undefined) dbPayload.sales_start_at = data.startDate ? new Date(data.startDate).toISOString() : null
        if (data.endDate !== undefined) dbPayload.sales_end_at = data.endDate ? new Date(data.endDate).toISOString() : null
        if (data.type !== undefined) dbPayload.type = data.type
        
        // Se guarda el cambio en la DB al editar
        if (data.ticketsIncluded !== undefined) dbPayload.tickets_included = data.ticketsIncluded

        await supabase.from('ticket_tiers').update(dbPayload).eq('id', id)
    }
  }
}))
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="middleware.ts">
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: { headers: request.headers },
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return request.cookies.getAll() },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))
          response = NextResponse.next({ request })
          cookiesToSet.forEach(({ name, value, options }) => response.cookies.set(name, value, options))
        },
      },
    }
  )

  // 1. Obtener usuario
  const { data: { user } } = await supabase.auth.getUser()

  // 2. Definir rutas
  const path = request.nextUrl.pathname
  const isLoginPage = path === '/login'
  
  // Define qué rutas proteges (TODO menos login y estáticos)
  const isProtectedRoute = !isLoginPage && !path.startsWith('/_next') && !path.startsWith('/api') && path !== '/favicon.ico'

  // --- LOGS DE DEPURACIÓN ---
  if (!path.startsWith('/_next')) {
    // console.log(`[Middleware] Path: ${path} | User: ${user ? 'Logueado' : 'No Logueado'}`)
  }

  // 3. Obtener Rol (Solo si hay usuario)
  let userRole = null
  if (user) {
    const { data: profile, error } = await supabase
      .from('profiles') // <--- ¡CORREGIDO! (Estaba en 'profile')
      .select('role')
      .eq('id', user.id)
      .single()
    
    userRole = profile?.role
    // console.log(`[Middleware] Rol detectado: ${userRole}`)
    
    if (error) console.error('[Middleware Error DB]:', error.message)
  }

  // --- LÓGICA DE REDIRECCIÓN ---

  // CASO A: El Admin intenta ir al Login -> Lo mandamos al Dashboard
  if (user && userRole === 'admin' && isLoginPage) {
    return NextResponse.redirect(new URL('/dashboard', request.url))
  }

  // CASO B: Protección de Rutas
  if (isProtectedRoute) {
    // Solo pasa si hay usuario Y es admin
    const canAccess = user && userRole === 'admin'
    
    if (!canAccess) {
      console.log('[Middleware] Acceso denegado. Redirigiendo a Login.')
      return NextResponse.redirect(new URL('/login', request.url))
    }
  }

  return response
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
}
</file>

<file path="app/globals.css">
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --radius-2xl: calc(var(--radius) + 8px);
  --radius-3xl: calc(var(--radius) + 12px);
  --radius-4xl: calc(var(--radius) + 16px);
}

:root {
  --radius: 0.625rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.129 0.042 264.695);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.129 0.042 264.695);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.129 0.042 264.695);
  --primary: oklch(0.208 0.042 265.755);
  --primary-foreground: oklch(0.984 0.003 247.858);
  --secondary: oklch(0.968 0.007 247.896);
  --secondary-foreground: oklch(0.208 0.042 265.755);
  --muted: oklch(0.968 0.007 247.896);
  --muted-foreground: oklch(0.554 0.046 257.417);
  --accent: oklch(0.968 0.007 247.896);
  --accent-foreground: oklch(0.208 0.042 265.755);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.929 0.013 255.508);
  --input: oklch(0.929 0.013 255.508);
  --ring: oklch(0.704 0.04 256.788);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.984 0.003 247.858);
  --sidebar-foreground: oklch(0.129 0.042 264.695);
  --sidebar-primary: oklch(0.208 0.042 265.755);
  --sidebar-primary-foreground: oklch(0.984 0.003 247.858);
  --sidebar-accent: oklch(0.968 0.007 247.896);
  --sidebar-accent-foreground: oklch(0.208 0.042 265.755);
  --sidebar-border: oklch(0.929 0.013 255.508);
  --sidebar-ring: oklch(0.704 0.04 256.788);
}

.dark {
  --background: oklch(0.129 0.042 264.695);
  --foreground: oklch(0.984 0.003 247.858);
  --card: oklch(0.208 0.042 265.755);
  --card-foreground: oklch(0.984 0.003 247.858);
  --popover: oklch(0.208 0.042 265.755);
  --popover-foreground: oklch(0.984 0.003 247.858);
  --primary: oklch(0.929 0.013 255.508);
  --primary-foreground: oklch(0.208 0.042 265.755);
  --secondary: oklch(0.279 0.041 260.031);
  --secondary-foreground: oklch(0.984 0.003 247.858);
  --muted: oklch(0.279 0.041 260.031);
  --muted-foreground: oklch(0.704 0.04 256.788);
  --accent: oklch(0.279 0.041 260.031);
  --accent-foreground: oklch(0.984 0.003 247.858);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.551 0.027 264.364);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.208 0.042 265.755);
  --sidebar-foreground: oklch(0.984 0.003 247.858);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.984 0.003 247.858);
  --sidebar-accent: oklch(0.279 0.041 260.031);
  --sidebar-accent-foreground: oklch(0.984 0.003 247.858);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.551 0.027 264.364);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* Elimina absolutamente todos los bordes de enfoque en gráficos y sus elementos internos */
.recharts-wrapper:focus,
.recharts-surface:focus,
.recharts-sector:focus,
.recharts-curve:focus,
.recharts-rectangle:focus,
.recharts-symbols:focus,
.recharts-layer:focus,
path:focus,
svg:focus {
    outline: none !important;
    border: none !important;
    box-shadow: none !important;
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import Script from "next/script"; // <--- 1. Importamos Script
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
        
        {/* <--- 2. Script de Google Maps con librería "places" */}
        <Script
          src={`https://maps.googleapis.com/maps/api/js?key=AIzaSyDOZ9gVgcmAr19Ol35AzFGiuYR_8v8Mx-4&libraries=places`}
          strategy="beforeInteractive"
        />
      </body>
    </html>
  );
}
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="package.json">
{
  "name": "dyzgo-plus",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-tabs": "^1.1.13",
    "@supabase/auth-helpers-nextjs": "^0.15.0",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.91.1",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "framer-motion": "^12.26.2",
    "lucide-react": "^0.562.0",
    "next": "16.1.3",
    "react": "19.2.3",
    "react-colorful": "^5.6.1",
    "react-datepicker": "^9.1.0",
    "react-dom": "19.2.3",
    "recharts": "^3.7.0",
    "tailwind-merge": "^3.4.0",
    "use-places-autocomplete": "^4.0.1",
    "uuid": "^13.0.0",
    "xlsx": "^0.18.5",
    "zustand": "^5.0.10"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-datepicker": "^6.2.0",
    "@types/react-dom": "^19",
    "@types/uuid": "^10.0.0",
    "eslint": "^9",
    "eslint-config-next": "16.1.3",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

</files>
